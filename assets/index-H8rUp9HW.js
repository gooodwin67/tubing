import{S as J,C as Q,F as Z,H as $,a as ee,D as te,b as ne,A as oe,P as ae,c as ie,W as se,d as re,G as O,B as b,V as m,R as K,e as C}from"./three-JQ8oHkCl.js";import{O as w}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=o(i);fetch(i.href,a)}})();function W(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}let j=document.querySelector(".main_load"),de=document.querySelector(".main_menu"),A=document.querySelector(".select_level"),G=document.querySelector(".select_tube"),le=document.querySelector(".startButton"),ce=document.querySelectorAll(".load_level_wrap>div"),ue=document.querySelectorAll(".load_tubes_wrap>div"),pe=document.querySelector(".current_time"),me=document.querySelector(".best_time"),he=document.querySelector(".speed_block>.speed");ce.forEach((e,o)=>{e.addEventListener("click",()=>{A.classList.add("hidden_block"),G.classList.remove("hidden_block"),U(o+1),M=W(),M&&document.body.requestFullscreen().then(()=>{screen.orientation.lock("landscape")})})}),ue.forEach((e,o)=>{e.addEventListener("click",()=>{G.classList.add("hidden_block"),l=o,T=!0})}),le.addEventListener("click",()=>{de.classList.add("hidden_block"),A.classList.remove("hidden_block")});let g,we=[],t,s,q=[],l=0,E,v;const h=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,maxSpeed:26,resetHAngle:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:2,maxSpeed:26,resetHAngle:!1},{hSpeed:25,maxHSpeed:.14,stepSpeed:3,maxSpeed:30,resetHAngle:!0}];let D=[],S=new m,B=new K,T=!1,F=!1,x=[],y,M=W(),ye=new C,P=new C,_=0,I=1/60,H=0,z=0;const N=new K,fe=new m(0,-1,0),d=new J;d.background=new Q(14479094),d.fog=new Z(d.background,1,300);const k=new $(16777215,16777215,2);k.color.setHSL(.6,1,.6),k.groundColor.setHSL(.095,1,.75),k.position.set(0,100,0),new ee(k,10);const c=new te(16777215,3);c.color.setHSL(.1,1,.95),c.position.set(0,1,0),c.position.multiplyScalar(10),c.castShadow=!0,c.shadow.mapSize.width=2048,c.shadow.mapSize.height=2048;const R=500;c.shadow.camera.left=-R,c.shadow.camera.right=R,c.shadow.camera.top=R,c.shadow.camera.bottom=-R,c.shadow.camera.far=350,c.shadow.bias=-.001,new ne(c,10),new oe(11184810,1);const u=new ae(75,window.innerWidth/window.innerHeight,.1,1e3);u.position.set(0,4,-10);let V=new ie;document.body.appendChild(V.dom);const f=new se;f.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(f.domElement),f.shadowMap.enabled=!0,f.shadowMap.type=re,window.addEventListener("resize",ge,!1);function ge(){u.aspect=window.innerWidth/window.innerHeight,u.updateProjectionMatrix(),f.setSize(window.innerWidth,window.innerHeight)}async function De(){P=new C,d.add(c),d.add(k),T=!1,F=!1,z=0,await w.init(),g=new w.World(new w.Vector3(0,-9.81,0)),await new O().loadAsync("models/map-menu.glb").then(e=>{const o=e.scene;o.traverse(function(n){n.isMesh&&(n.castShadow=!0,n.receiveShadow=!0)}),o.traverse(n=>{if(n.name=="player")t=n.clone(),t.material.transparent=!0,t.material.opacity=.4,t.userData.mass=1,t.userData.playerStart=!1,t.userData.playerBraking=!1,t.userData.hTransition=0,t.userData.currentSpeed=0,t.userData.right=!1,t.userData.left=!1,t.userData.onGround=!1,t.userData.flying=!1,L(t),d.add(t);else if(n.name.includes("player-tube")){var i=n.clone();i.userData.startPosition=new m(i.position.x,i.position.y,i.position.z),q[n.name.slice(-1)-1]=i,d.add(i)}else if(n.name=="arrow_area")y=n.clone(),y.userData.hPos=0,d.add(y);else if(n.name.includes("ground")){new b().setFromObject(n).getSize(new m);let a=n.clone();a.userData.mass=0,L(a),x.push(a),d.add(a)}else if(n.name.includes("wall")){new b().setFromObject(n).getSize(new m);let a=n.clone();a.userData.mass=1,L(a),x.push(a),d.add(a)}else if(n.name.includes("area")){let a=n.clone();d.add(a)}})}),F=!0}async function U(e){v=!1;const o=new O,n="models/map"+e+".glb";await o.loadAsync(n).then(i=>{const a=i.scene;a.traverse(function(r){r.isMesh&&(r.castShadow=!0,r.receiveShadow=!0)}),a.traverse(r=>{if(r.name.includes("ground")){new b().setFromObject(r).getSize(new m);let p=r.clone();p.userData.mass=0,p.name=r.name,L(p),x.push(p),d.add(p)}else if(r.name.includes("wall")){new b().setFromObject(r).getSize(new m);let p=r.clone();p.userData.mass=1,L(p),x.push(p),d.add(p)}else if(r.name.includes("area")){let p=r.clone();d.add(p)}else r.name.includes("finish_block")&&(E=r.clone(),d.add(E))})})}X();async function X(){j.classList.remove("hidden_block"),await De(),j.classList.add("hidden_block"),A.classList.remove("hidden_block")}function Se(){if(F&&!v&&(M?(u.lookAt(new m(u.position.x,t.position.y,t.position.z+5)),u.position.y=t.position.y+5,u.position.z=t.position.z-3):(u.lookAt(new m(u.position.x,t.position.y,t.position.z+5)),u.position.y=t.position.y+4,u.position.z=t.position.z-4),y.position.set(t.position.x,t.position.y,t.position.z+5)),T){if(!v)be(),z=P.getElapsedTime().toFixed(3),pe.textContent=z;else{for(t.position.z=0;d.children.length>0;){let e=d.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(o=>o.dispose()):e.material.dispose()),d.remove(e)}A.classList.remove("hidden_block"),X(),v=!1}g.step(),q[l].position.copy(s.translation()),q[l].quaternion.copy(s.rotation());for(let e=0,o=D.length;e<o;e++)D[e][0].position.copy(D[e][1].translation()),D[e][0].quaternion.copy(D[e][1].rotation())}V.update()}f.setAnimationLoop(()=>{_+=ye.getDelta(),_>I&&(Se(),f.render(d,u),_=_%I)}),document.addEventListener("touchend",xe),document.addEventListener("touchstart",Y),document.addEventListener("touchmove",Y),window.addEventListener("keydown",ze),window.addEventListener("keyup",ke),document.addEventListener("mousedown",ve,!1);function be(){t.position.z>E.position.z&&(v=!0,(z<H||H==0)&&(H=z,me.textContent=H),t.position.z=0),y.position.x+=t.userData.hTransition;const e=new m().subVectors(s.translation(),y.position).normalize();y.lookAt(t.position.x,t.position.y,t.position.z),s.setRotation({w:y.quaternion.w,x:s.rotation().x,y:y.quaternion.y,z:s.rotation().z}),s.setLinvel({x:e.x*-h[l].hSpeed,y:s.linvel().y,z:s.linvel().z}),N.set(t.position,fe);const o=N.intersectObjects(x);if(o.length>0&&(o[0].distance<.4?(t.userData.flying=!1,!t.userData.onGround&&t.userData.flying,t.userData.onGround=!0):(t.userData.onGround=!1,t.userData.flying=!0)),s.linvel().z>0?t.userData.currentSpeed=s.linvel().z.toFixed(0):t.userData.currentSpeed=0,he.textContent=t.userData.currentSpeed,t.userData.left&&t.userData.onGround){t.userData.hTransition<5&&(t.userData.hTransition+=h[l].maxHSpeed);let n=s.linvel();n.z*=.9996,s.setLinvel(n,!0)}if(t.userData.right&&t.userData.onGround){t.userData.hTransition>-5&&(t.userData.hTransition-=h[l].maxHSpeed);let n=s.linvel();n.z*=.9996,s.setLinvel(n,!0)}h[l].resetHAngle&&!t.userData.left&&!t.userData.right&&(t.userData.hTransition<-h[l].maxHSpeed?t.userData.hTransition+=h[l].maxHSpeed:t.userData.hTransition>h[l].maxHSpeed?t.userData.hTransition-=h[l].maxHSpeed:t.userData.hTransition=0)}function Y(e){if(t.userData.onGround){e=e.changedTouches[0];var o=f.domElement.getBoundingClientRect();S.x=(e.clientX-o.left)/o.width*2-1,S.y=-((e.clientY-o.top)/o.height)*2+1,B.setFromCamera(S,u),S.y>0?s.linvel().z<h[l].maxSpeed&&s.linvel().y<5&&s.linvel().y>-5&&s.applyImpulse({x:0,y:0,z:h[l].stepSpeed},!0):S.x>0?(t.userData.left=!1,t.userData.right=!0):(t.userData.right=!1,t.userData.left=!0)}}function ve(e){e.preventDefault();var o=f.domElement.getBoundingClientRect();S.x=(e.clientX-o.left)/o.width*2-1,S.y=-((e.clientY-o.top)/o.height)*2+1,B.setFromCamera(S,u),we.forEach(n=>{n.geometry.computeBoundingBox();var i=n.geometry.boundingBox.clone();i.applyMatrix4(n.matrixWorld),B.ray.intersectBox(i,new m)&&U(n.name.slice(-1))})}function xe(e){t.userData.right=!1,t.userData.left=!1}function ze(e){switch(e.code){case"KeyW":case"ArrowUp":s.linvel().z<h[l].maxSpeed&&s.linvel().y<5&&s.linvel().y>-5&&s.applyImpulse({x:0,y:0,z:h[l].stepSpeed},!0),t.userData.playerStart=!0;break;case"KeyS":case"ArrowDown":t.userData.playerBraking=!0;break;case"KeyA":case"ArrowLeft":t.userData.left=!0;break;case"KeyD":case"ArrowRight":t.userData.right=!0;break}}function ke(e){switch(e.code){case"KeyW":case"ArrowUp":break;case"KeyS":case"ArrowDown":s.linvel().y<.1&&(t.userData.playerBraking=!1);break;case"KeyA":case"ArrowLeft":t.userData.left=!1;break;case"KeyD":case"ArrowRight":t.userData.right=!1;break}}function L(e){let o,n;const i=e.rotation.clone();e.rotation.set(0,0,0);const a=new b().setFromObject(e).getSize(new m);e.rotation.copy(i),e.name.includes("player")?(o=g.createRigidBody(w.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),n=w.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),s=o,g.createCollider(n,o),D.push([e,o,e.id])):e.name.includes("ground")&&(o=g.createRigidBody(w.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),n=w.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),g.createCollider(n,o),D.push([e,o,e.id])),e.name.includes("wall")&&(o=g.createRigidBody(w.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0).setLinearDamping(0)),n=w.ColliderDesc.cuboid(a.x/2-.5,a.y/2,a.z/2).setMass(e.userData.mass*20).setRestitution(0).setFriction(4),g.createCollider(n,o),D.push([e,o,e.id]))}
