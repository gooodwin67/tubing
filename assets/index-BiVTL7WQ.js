import{C as ce,S as Ve,a as Ye,F as Ue,H as Qe,b as Xe,D as $e,c as Ze,A as et,P as tt,d as nt,W as ot,V as f,R as de,G as qe,B as G,e as at,f as it,g as ue}from"./three-uEutqz5B.js";import{O as u}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();function Ce(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}let W=document.querySelector(".main_load"),ze=document.querySelector(".main_menu"),Le=document.querySelector(".select_level"),st=document.querySelectorAll(".select_level .level_shadow"),rt=document.querySelector(".select_tube"),lt=document.querySelector(".finish_window"),ct=document.querySelector(".finish_you_time .finish_you_time_time"),ke=document.querySelector(".boom_window"),dt=document.querySelectorAll("body>.overlay"),ut=document.querySelector(".startButton"),pt=document.querySelectorAll(".load_level_wrap>div"),mt=document.querySelectorAll(".load_level_wrap .level_time"),Ae=document.querySelectorAll(".load_tubes_wrap>div"),$=document.querySelectorAll(".language_block>img"),Ee=[],Re=[],Te=document.querySelector(".times"),pe=document.querySelector(".current_time"),Be=document.querySelector(".best_time"),yt=document.querySelector(".finish_window .finish_again"),gt=document.querySelector(".finish_window .finish_in_menu"),ht=document.querySelector(".boom_window .finish_again"),Dt=document.querySelector(".boom_window .finish_in_menu"),Ie=document.querySelector(".speed_block"),Me=document.querySelector(".speed_block>.speed"),_t=document.querySelector(".instr_check"),Z=document.querySelector(".load_percent"),me=document.querySelector(".pause_button_wrap"),St=document.querySelector(".close_pause_button"),bt=document.querySelector(".reset_button"),ft=document.querySelector(".inmenu_button"),wt=document.querySelector(".before_start"),xt=document.querySelector(".instruction_start_btn"),vt=document.querySelector(".menu_in_game_wrap"),He=document.querySelector(".start_time"),Fe=document.querySelector(".start_time_wrap"),ye=document.querySelector(".audio_button"),qt=document.querySelector(".clear_rec");qt.addEventListener("click",()=>{localStorage.clear()}),$.forEach((e,n)=>{e.addEventListener("click",()=>{h.language!=n&&($.forEach(o=>{o.classList.remove("selected")}),e.classList.add("selected"),h.language=n,localStorage.setItem("playerData",JSON.stringify(h)),Oe(h.language))})});function Oe(e){e==0?(document.querySelector(".title_game").src="./images/title.png",document.querySelector(".startgame_title").textContent="\u043D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".language_title").textContent="\u042F\u0437\u044B\u043A:",document.querySelectorAll(".level_text h2>span").forEach(n=>{n.textContent="\u0423\u0440\u043E\u0432\u0435\u043D\u044C"}),document.querySelectorAll(".leveltime_title").forEach(n=>{n.textContent="\u0412\u0440\u0435\u043C\u044F: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(n=>{n.textContent="\u0422\u044E\u0431\u0438\u043D\u0433"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(n=>{n.textContent="\u0421\u043A\u043E\u0440\u043E\u0441\u0442\u044C: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(n=>{n.textContent="\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435: "}),document.querySelector(".selecttubedesc_title").textContent="\u041F\u0440\u043E\u0445\u043E\u0434\u0438\u0442\u0435 \u0443\u0440\u043E\u0432\u043D\u0438, \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0442\u044E\u0431\u0438\u043D\u0433\u0438",document.querySelector(".menu_in_game_wrap_head").textContent="\u041F\u0430\u0443\u0437\u0430",document.querySelector(".close_pause_button").textContent="\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".reset_button").textContent="\u041D\u0430\u0447\u0430\u0442\u044C \u0437\u0430\u043D\u043E\u0432\u043E",document.querySelector(".inmenu_button").textContent="\u0412\u044B\u0439\u0442\u0438",document.querySelector(".finish_you_time_title").textContent="\u0412\u0430\u0448\u0435 \u0432\u0440\u0435\u043C\u044F: ",document.querySelector(".crash_title").textContent="\u0412\u044B \u0432\u0440\u0435\u0437\u0430\u043B\u0438\u0441\u044C",document.querySelector(".finish_title").textContent="\u0412\u044B \u043F\u0440\u0438\u0435\u0445\u0430\u043B\u0438",document.querySelectorAll(".finish_again").forEach(n=>{n.textContent="\u0415\u0449\u0435 \u0440\u0430\u0437"}),document.querySelectorAll(".finish_in_menu").forEach(n=>{n.textContent="\u0412 \u043C\u0435\u043D\u044E"}),document.querySelector(".current_time_title").textContent="\u0412\u0440\u0435\u043C\u044F",document.querySelector(".best_time_title").textContent="\u041B\u0443\u0447\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F",document.querySelector(".speed_title").textContent="\u041A\u041C/\u0427",document.querySelector(".instruction_start_btn").textContent="\u0421\u0422\u0410\u0420\u0422",document.querySelector(".instr-disabled span").textContent="\u0411\u043E\u043B\u044C\u0448\u0435 \u043D\u0435 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0442\u044C",document.querySelector(".desktop_instr").innerHTML=`<h2>\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435</h2>
    <span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 <span class='button_active'>W</span> \u0438\u043B\u0438 <span class='button_active'>\u2191</span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041A\u043B\u0430\u0432\u0438\u0448\u0430\u043C\u0438 <span>\u2190</span> <span>\u2192</span> \u0438\u043B\u0438 <span>A</span> <span>D</span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>
    <span>\u0426\u0435\u043B\u044C - \u0434\u043E\u0435\u0445\u0430\u0442\u044C \u0434\u043E \u0444\u0438\u043D\u0438\u0448\u0430 \u0437\u0430 \u043A\u0440\u0430\u0442\u0447\u0430\u0439\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F</span>`,document.querySelector(".mobile_instr").innerHTML=`<span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 \u043D\u0430 \u0437\u043E\u043D\u0443 <span> \u2191 </span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041D\u0430\u0436\u0438\u043C\u0430\u044F \u043D\u0430 \u0437\u043E\u043D\u044B <span> \u2190 </span> \u0438 <span> \u2192 </span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>
    <img src="/images/instr-mobile.png" alt="">`,document.querySelector(".sci-fi-loader strong").textContent="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430"):(document.querySelector(".title_game").src="./images/title-en.png",document.querySelector(".startgame_title").textContent="start game",document.querySelector(".language_title").textContent="Language:",document.querySelectorAll(".level_text h2>span").forEach(n=>{n.textContent="Level"}),document.querySelectorAll(".leveltime_title").forEach(n=>{n.textContent="Time: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(n=>{n.textContent="Tubing"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(n=>{n.textContent="Speed: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(n=>{n.textContent="Control: "}),document.querySelector(".selecttubedesc_title").textContent="Complete the levels to unlock the tubings",document.querySelector(".menu_in_game_wrap_head").textContent="Pause",document.querySelector(".close_pause_button").textContent="Continue",document.querySelector(".reset_button").textContent="Start again",document.querySelector(".inmenu_button").textContent="Exit to levels",document.querySelector(".finish_you_time_title").textContent="You time: ",document.querySelector(".crash_title").textContent="You crashed",document.querySelector(".finish_title").textContent="You finished",document.querySelectorAll(".finish_again").forEach(n=>{n.textContent="Again"}),document.querySelectorAll(".finish_in_menu").forEach(n=>{n.textContent="In Menu"}),document.querySelector(".current_time_title").textContent="Time",document.querySelector(".best_time_title").textContent="Best time",document.querySelector(".speed_title").textContent="KM/H",document.querySelector(".instruction_start_btn").textContent="START",document.querySelector(".instr-disabled span").textContent="Don't show again",document.querySelector(".desktop_instr").innerHTML=`<h2>Instructions</h2>
    <span>Quickly press <span class='button_active'>W</span> or <span class='button_active'>\u2191</span> to accelerate to the starting point</span>
    <span>Use <span>\u2190</span> <span>\u2192</span> or <span>A</span> <span>D</span> keys to control the tubing</span>
    <span>The goal is to reach the finish line in the shortest time</span>`,document.querySelector(".mobile_instr").innerHTML=`<span>Quickly press on zone <span> \u2191 </span> to accelerate to the starting point</span>
    <span>By taps on zones <span> \u2190 </span> and <span> \u2192 </span> control the tubing</span>
    <img src="/images/instr-mobile.png" alt="">`,document.querySelector(".sci-fi-loader strong").textContent="Loading ")}pt.forEach((e,n)=>{e.addEventListener("click",async()=>{n+1<=ve+10&&(O=n+1,Ae.forEach((o,r)=>{p[r].levels.includes(O)?(o.classList.remove("disabledTube"),p[r].canInLevel=!0):(o.classList.add("disabledTube"),p[r].canInLevel=!1)}),_(W),await X(!1,!0),_(rt))})}),Ae.forEach((e,n)=>{e.addEventListener("click",()=>{p[n].canInLevel&&(y=n,_(0),U())})});function U(){if(!h.canStart)_(wt),ie?document.querySelector(".mobile_instr").classList.remove("hidden_instr"):document.querySelector(".desktop_instr").classList.remove("hidden_instr");else{Te.classList.remove("hidden_block"),Ie.classList.remove("hidden_block"),ee[y].position.copy(i.translation());let e=2;De=!0;let n=setInterval(o=>{Fe.classList.remove("hidden_block"),e++,e==4?(De=!1,He.textContent="GO",R=!0,me.classList.remove("hidden_block"),clearInterval(n),setTimeout(()=>{Fe.classList.add("hidden_block")},600)):He.textContent=4-e},1e3)}}xt.addEventListener("click",()=>{h.canStart=!0,_(0),U()}),ye.addEventListener("click",()=>{L==!0?(ye.classList.add("audio_off"),g!=null&&g.isPlaying&&g.stop(),l==null||l.stop(),L=!1):(ye.classList.remove("audio_off"),g!=null&&!g.isPlaying&&g.play(),i.linvel().z>3&&t.userData.onGround&&!J&&(l==null||l.play()),L=!0)}),ut.addEventListener("click",()=>{ie=Ce(),document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),g!=null&&L&&g.play(),ie&&document.body.requestFullscreen().then(()=>{screen.orientation.lock("landscape")}),ze.classList.add("hidden_block"),Le.classList.remove("hidden_block")});function _(e){dt.forEach(n=>{n.classList.add("hidden_block")}),e!=0&&e.classList.remove("hidden_block")}yt.addEventListener("click",async()=>{_(W),await Y(),await X(!0,!0),_(0),U()}),ht.addEventListener("click",async()=>{_(W),await Y(),await X(!0,!0),_(0),U()}),bt.addEventListener("click",async()=>{await Y(),await X(!0,!0),_(0),U()}),gt.addEventListener("click",async()=>{_(W),await Y(),await le()}),Dt.addEventListener("click",async()=>{_(W),await Y(),await le()}),ft.addEventListener("click",async()=>{_(W),await Y(),await le()}),me.addEventListener("click",()=>{De==!1&&R&&!z&&(_(vt),t.userData.time=C.getElapsedTime(),C.stop(),document.querySelector(".audio_button_wrap").classList.add("hidden_block"),l==null||l.stop(),g==null||g.stop(),J=!0)}),St.addEventListener("click",()=>{_(0),C.start(),C.elapsedTime=t.userData.time,document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),L&&(g==null||g.play()),i.linvel().z>3&&t.userData.onGround&&L&&(l==null||l.play()),J=!1}),_t.onchange=function(){this.checked?(h.canStart=!0,localStorage.setItem("playerData",JSON.stringify(h))):(h.canStart=!1,localStorage.setItem("playerData",JSON.stringify(h)))};let m,ge=!0;performance.now();let Ct=[],O=0,J=!1,L=!0,t,i,he,De=!1,ee=[],y=0,M,_e,Se,z;const p=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,nowSpeed:0,maxSpeed:26,resetHAngle:!1,levels:[1,2,3,4,5,6,7,8],canInLevel:!1},{hSpeed:12,maxHSpeed:.1,stepSpeed:2,nowSpeed:0,maxSpeed:38,resetHAngle:!1,levels:[5,6,7,8],canInLevel:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:3,nowSpeed:0,maxSpeed:44,resetHAngle:!0,levels:[6,7,8],canInLevel:!1}];let l,g,k,Je,x=[],I=new f,be=new de,R=!1,fe=!1,j,Ne,Pe,D,T,B,v,q,te,ne,oe,K,V,we,N=[],ae=[],xe=[],S,ie=Ce(),zt=new ce,C=new ce,se=0,Ge=1/60,P=0,A=0,ve=2,h;const We=new de,Lt=new f(0,-1,0),d=new Ve;d.background=new Ye(14479094),d.fog=new Ue(d.background,1,300);const Q=new Qe(16777215,16777215,2);Q.color.setHSL(.6,1,.6),Q.groundColor.setHSL(.095,1,.75),Q.position.set(0,100,0),new Xe(Q,10);const re=new $e(16777215,3);re.position.set(1,2,.2),re.position.multiplyScalar(120),new Ze(re,10),new et(11184810,1);const w=new tt(85,document.body.offsetWidth/document.body.offsetHeight,.1,310);w.position.set(0,4,-10);let je=new nt;document.body.appendChild(je.dom);const H=new ot({antialias:!1});H.setSize(document.body.offsetWidth,document.body.offsetHeight),document.body.appendChild(H.domElement),H.shadowMap.enabled=!1,window.addEventListener("resize",kt,!1);function kt(){w.aspect=document.body.offsetWidth/document.body.offsetHeight,w.updateProjectionMatrix(),H.setSize(document.body.offsetWidth,document.body.offsetHeight)}async function At(){localStorage.getItem("playerData")?(h=JSON.parse(localStorage.getItem("playerData")),$.forEach(e=>{e.classList.remove("selected")}),$[h.language].classList.add("selected"),Oe(h.language)):(h={levelsTimes:{},canStart:!1,language:0},localStorage.setItem("playerData",JSON.stringify(h))),JSON.stringify(h),ve=0,st.forEach((e,n)=>{n<Object.keys(h.levelsTimes).length+2&&(ve++,e.classList.remove("level_disabled"))}),mt.forEach((e,n,o)=>{h.levelsTimes["time"+(n+1)]!=null?e.childNodes[2].textContent=h.levelsTimes["time"+(n+1)]:e.childNodes[2].textContent="00.000"})}async function Et(){C=new ce,d.add(re),d.add(Q),A=0,await u.init(),m=new u.World(new u.Vector3(0,-9.81,0)),await new qe().loadAsync("models/map-menu.glb",onprogress=c=>{console.log(`Loaded: ${c.loaded}, Total: ${c.total}`);let b=Math.min(Math.round(c.loaded/c.total*100),100);Z.textContent=b+"%"}).then(c=>{const b=c.scene;Z.textContent="0",b.traverse(s=>{if(s.name=="player")t=s.clone(),t.userData.vertices=t.geometry.attributes.position.array,t.userData.indices=t.geometry.index.array,t.material.transparent=!0,t.material.opacity=0,t.userData.mass=1,t.userData.playerBraking=!1,t.userData.hTransition=0,t.userData.currentSpeed=0,t.userData.boom=!1,t.userData.onStartArea=!0,t.userData.canBoostStep=!0,t.userData.time=0,t.userData.right=!1,t.userData.left=!1,t.userData.onGround=!1,t.userData.flying=!1,t.userData.origPosition=t.position,E(t),d.add(t);else if(s.name.includes("player-tube"))M=s.clone(),M.userData.startPosition=new f(M.position.x,M.position.y,M.position.z),ee[s.name.slice(-1)-1]=M,d.add(M);else if(s.name=="arrow_area")S=s.clone(),S.userData.hPos=0,d.add(S);else if(s.name.includes("ground"))new G().setFromObject(s).getSize(new f),j=s.clone(),j.userData.mass=0,E(j),N.push(j),d.add(j),s.name=="left_ground_wall"?Ne=s.position:s.name=="right_ground_wall"&&(Pe=s.position);else if(s.name.includes("wall")){new G().setFromObject(s).getSize(new f);let F=s.clone();F.userData.mass=1,E(F),N.push(F),ae.push(F),d.add(F)}else if(s.name.includes("area")){let F=s.clone();d.add(F)}else s.name.includes("start_flag")?(_e=s.clone(),d.add(_e)):s.name.includes("itsmen_body")?(D=s.clone(),D.material.transparent=!0,D.material.opacity=0,d.add(D),E(D)):s.name.includes("itsmen_left_hand")?(T=s.clone(),T.material.transparent=!0,T.material.opacity=0,d.add(T),E(T)):s.name.includes("itsmen_right_hand")?(B=s.clone(),B.material.transparent=!0,B.material.opacity=0,d.add(B),E(B)):s.name.includes("itsmen_left_leg")?(v=s.clone(),v.material.transparent=!0,v.material.opacity=0,d.add(v),E(v)):s.name.includes("itsmen_right_leg")?(q=s.clone(),q.material.transparent=!0,q.material.opacity=0,d.add(q),E(q)):s.name.includes("qmen_body")?(te=s.clone(),d.add(te)):s.name.includes("qmen_left_hand")?(ne=s.clone(),d.add(ne)):s.name.includes("qmen_right_hand")?(oe=s.clone(),d.add(oe)):s.name.includes("qmen_left_leg")?(K=s.clone(),d.add(K)):s.name.includes("qmen_right_leg")&&(V=s.clone(),d.add(V))})}),d.traverse(function(c){c.material&&(c.material.needsUpdate=!0)}),await At();let e=u.JointData.spherical({x:.2,y:0,z:-.2},{x:-.4,y:0,z:0});m.createImpulseJoint(e,D.userData.body,T.userData.body,!0);let n=u.JointData.spherical({x:-.2,y:0,z:-.2},{x:.4,y:0,z:0});m.createImpulseJoint(n,D.userData.body,B.userData.body,!0);let o=u.JointData.spherical({x:.22,y:0,z:.5},{x:0,y:0,z:-.5});m.createImpulseJoint(o,D.userData.body,v.userData.body,!0);let r=u.JointData.spherical({x:-.22,y:0,z:.5},{x:0,y:0,z:-.5});m.createImpulseJoint(r,D.userData.body,q.userData.body,!0);let a=u.JointData.spherical({x:0,y:0,z:0},{x:0,y:.3,z:0});we=m.createImpulseJoint(a,D.userData.body,i,!0),fe=!0}async function Rt(){z=!1;const e=new qe,n="models/map"+O+".glb";await e.loadAsync(n,onprogress=o=>{let r=Math.min(Math.round(o.loaded/o.total*100),100);Z.textContent=r+"%"}).then(o=>{const r=o.scene;Z.textContent="0",r.traverse(a=>{if(a.name.includes("ground")){new G().setFromObject(a).getSize(new f);let c=a.clone();c.userData.mass=0,c.name=a.name,E(c),N.push(c),d.add(c)}else if(a.name.includes("wall")){new G().setFromObject(a).getSize(new f);let c=a.clone();c.userData.mass=1,E(c),N.push(c),ae.push(c),d.add(c)}else if(a.name.includes("moving_block")){const c=new G().setFromObject(a).getSize(new f);let b=a.clone();b.userData.size=c,b.userData.mass=1,b.userData.raycaster=new de,b.userData.speed=-a.name.substr(a.name.indexOf("speed")+6),b.userData.direction=new f(b.userData.speed,0,0),Ee.push(b),E(b),ae.push(b),d.add(b)}else if(a.name.includes("area")){let c=a.clone();d.add(c)}else a.name.includes("finish_block")&&(Se=a.clone(),d.add(Se))})}),Be.textContent=h.levelsTimes["time"+O]}async function Tt(){const e=new at;t.add(e);const n=new it;await n.loadAsync("audio/slide.mp3").then(o=>{l=new ue(e),l.setBuffer(o),l.setLoop(!0),l.setRefDistance(40),l.setVolume(.7),t.add(l)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await n.loadAsync("audio/around.mp3").then(o=>{g=new ue(e),g.setBuffer(o),g.setLoop(!0),g.setRefDistance(40),g.setVolume(1),g.error=!1,t.add(g)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await n.loadAsync("audio/boom1.mp3").then(o=>{k=new ue(e),k.setBuffer(o),k.setLoop(!1),k.setRefDistance(40),k.setVolume(.9),k.error=!1,t.add(k)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)})}async function le(){await X(!0,!1),ge?(_(ze),ge=!1):_(Le)}le();async function X(e,n){e&&await Et(),n&&await Rt(),ge&&Tt()}async function Y(){for(R=!1,fe=!1,A=0,t.userData.time=0,t.userData.boom=!1,p.forEach(e=>{e.nowSpeed=0}),N=[],ae=[],x=[],me.classList.add("hidden_block"),Te.classList.add("hidden_block"),Ie.classList.add("hidden_block"),document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),C.start(),C.elapsedTime=t.userData.time,J=!1,t.userData.currentSpeed=0,Me.textContent=t.userData.currentSpeed,A=0,pe.textContent=A;d.children.length>0;){let e=d.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(n=>n.dispose()):e.material.dispose()),d.remove(e)}z=!1}function Bt(){if(performance.now(),fe&&!z&&(l!=null&&L&&(i.linvel().z>3&&t.userData.onGround?l.isPlaying||l.play():l.isPlaying&&l.stop()),ie?t.userData.boom?(w.lookAt(D.position),l==null||l.stop()):(w.lookAt(new f(w.position.x,t.position.y,t.position.z+5)),w.position.y=t.position.y+5,w.position.z=t.position.z-3):t.userData.boom?(M.position.y>0&&w.lookAt(D.position),l==null||l.stop()):(w.lookAt(new f(w.position.x,t.position.y,t.position.z+5)),w.position.y=t.position.y+4,w.position.z=t.position.z-4),S.position.set(t.position.x,t.position.y,t.position.z+5)),R){z?(_(lt),l==null||l.stop()):(A=C.getElapsedTime().toFixed(3),pe.textContent=A,Mt(),It()),t.position.x>Ne.x-t.userData.size.x/1.3&&(S.position.x=t.position.x,t.userData.hTransition=-.4),t.position.x<Pe.x+t.userData.size.x/1.3&&(S.position.x=t.position.x,t.userData.hTransition=.4);let e=new u.EventQueue(!0);m.step(e),ee[y].position.copy(i.translation()),ee[y].quaternion.copy(i.rotation()),te.position.copy(D.position),te.rotation.copy(D.rotation),ne.position.copy(T.position),ne.rotation.copy(T.rotation),oe.position.copy(B.position),oe.rotation.copy(B.rotation),K.position.copy(v.position),K.rotation.copy(v.rotation),V.position.copy(q.position),V.rotation.copy(q.rotation);for(let n=0,o=x.length;n<o;n++)x[n][0].position.copy(x[n][1].translation()),x[n][0].quaternion.copy(x[n][1].rotation());e.drainCollisionEvents((n,o,r)=>{xe.forEach((a,c)=>{i.handle==n&&a.handle==o&&!z?i.linvel().z<15&&t.userData.boom==!1&&(k!=null&&L&&k.play(),m.removeImpulseJoint(we),D.userData.body.applyImpulse({x:5,y:5,z:5},!0),D.userData.body.setEnabledRotations(!0),he.setFriction(20),setTimeout(()=>{R=!1,_(ke)},3e3),t.userData.boom=!0):i.handle==n&&!z&&i.linvel().z<15&&t.position.y<5&&t.userData.boom==!1&&(k!=null&&L&&k.play(),m.removeImpulseJoint(we),D.userData.body.applyImpulse({x:5,y:5,z:5},!0),D.userData.body.setEnabledRotations(!0),he.setFriction(20),t.userData.boom=!0,setTimeout(()=>{R=!1,_(ke)},3e3))})})}je.update()}H.setAnimationLoop(()=>{se+=zt.getDelta(),se>Ge&&!J&&(Bt(),H.render(d,w),se=se%Ge)}),document.addEventListener("touchend",Ft),document.addEventListener("touchstart",Ke),document.addEventListener("touchmove",Ke),window.addEventListener("keydown",Ot),window.addEventListener("keyup",Jt),document.addEventListener("mousedown",Ht,!1);function It(){Ee.forEach((e,n)=>{let o=e,r=Re[n];r.setLinvel(o.userData.direction,!0),r.setAngvel({x:o.userData.direction.z,y:o.userData.direction.y,z:-o.userData.direction.x},!0);const a=o.userData.direction;o.userData.raycaster.set(new f(o.position.x,.4,o.position.z),a.clone().normalize());const c=o.userData.raycaster.intersectObjects(N);c.length>0&&c[0].distance<o.userData.size.x/2&&(o.userData.direction.x=o.userData.direction.x*-1)})}function Mt(){t.position.z>Se.position.z&&!t.userData.boom&&(A=C.getElapsedTime().toFixed(3),pe.textContent=A,z=!0,ct.textContent=A,h.levelsTimes["time"+O]!=null?P=h.levelsTimes["time"+O]:P=0,(A<P||P==0)&&(P=A,Be.textContent=P,h.levelsTimes["time"+O]=P,localStorage.setItem("playerData",JSON.stringify(h))),t.position.z=0),S.position.x+=t.userData.hTransition;const e=new f().subVectors(i.translation(),S.position).normalize(),n=i.linvel(),o=new f(e.x*-p[y].hSpeed,n.y,e.z*-p[y].nowSpeed);i.translation().y<100&&i.translation().y>=10&&(p[y].nowSpeed+=.05,i.rotation().x<.04&&i.setRotation({w:i.rotation().w,x:.04,y:i.rotation().y,z:i.rotation().z})),i.translation().y<10&&i.translation().y>1&&i.rotation().x<.04&&(i.setRotation({w:i.rotation().w,x:.04,y:i.rotation().y,z:i.rotation().z}),i.lockRotations(!0,!0,!0)),i.setLinvel(o,!0),S.lookAt(S.position.x-(t.position.x-S.position.x),S.position.y-(t.position.y-S.position.y),S.position.z-(t.position.z-S.position.z)),i.setRotation({w:S.quaternion.w,x:i.rotation().x,y:S.quaternion.y,z:i.rotation().z}),D.userData.body.setRotation({w:S.quaternion.w,x:i.rotation().x,y:S.quaternion.y,z:i.rotation().z}),(K.rotation.y>0||K.rotation.y<0)&&v.userData.body.setRotation({w:v.userData.body.rotation().w,x:v.userData.body.rotation().x,y:0,z:v.userData.body.rotation().z}),(V.rotation.y>0||V.rotation.y<0)&&q.userData.body.setRotation({w:q.userData.body.rotation().w,x:q.userData.body.rotation().x,y:0,z:q.userData.body.rotation().z}),We.set(t.position,Lt);const r=We.intersectObjects(N);r.length>0&&(r[0].distance<.4?(t.userData.flying=!1,t.userData.onGround=!0):(t.userData.onGround=!1,t.userData.flying=!0)),i.linvel().z>0?t.userData.currentSpeed=i.linvel().z.toFixed(0):t.userData.currentSpeed=0,Me.textContent=t.userData.currentSpeed,t.userData.left&&t.userData.onGround&&!t.userData.onStartArea&&(t.userData.hTransition<5&&(t.userData.hTransition+=p[y].maxHSpeed),p[y].nowSpeed-=.009),t.userData.right&&t.userData.onGround&&!t.userData.onStartArea&&(t.userData.hTransition>-5&&(t.userData.hTransition-=p[y].maxHSpeed),p[y].nowSpeed-=.009),p[y].resetHAngle&&!t.userData.left&&!t.userData.right&&(t.userData.hTransition<-p[y].maxHSpeed?t.userData.hTransition+=p[y].maxHSpeed:t.userData.hTransition>p[y].maxHSpeed?t.userData.hTransition-=p[y].maxHSpeed:t.userData.hTransition=0),t.position.z>_e.position.z?(t.userData.onStartArea&&i.lockRotations(!1,!0,!0),t.userData.onStartArea=!1):(t.userData.onStartArea=!0,i.lockRotations(!0,!0,!0))}function Ke(e){if(t.userData.onGround){e=e.changedTouches[0];var n=H.domElement.getBoundingClientRect();I.x=(e.clientX-n.left)/n.width*2-1,I.y=-((e.clientY-n.top)/n.height)*2+1,be.setFromCamera(I,w),I.y>0&&t.userData.canBoostStep&&R&&t.userData.onStartArea&&i.linvel().z<p[y].maxSpeed&&i.linvel().y<5&&i.linvel().y>-5&&!z&&p[y].nowSpeed<p[y].maxSpeed&&(p[y].nowSpeed+=p[y].stepSpeed),t.userData.canBoostStep=!1,I.y<0&&(I.x>0?(t.userData.left=!1,t.userData.right=!0):(t.userData.right=!1,t.userData.left=!0))}}function Ht(e){e.preventDefault();var n=H.domElement.getBoundingClientRect();I.x=(e.clientX-n.left)/n.width*2-1,I.y=-((e.clientY-n.top)/n.height)*2+1,be.setFromCamera(I,w),Ct.forEach(o=>{o.geometry.computeBoundingBox();var r=o.geometry.boundingBox.clone();r.applyMatrix4(o.matrixWorld),be.ray.intersectBox(r,new f)})}function Ft(e){t.userData.right=!1,t.userData.left=!1,t.userData.canBoostStep=!0}function Ot(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep&&R&&t.userData.onStartArea&&i.linvel().z<p[y].maxSpeed&&i.linvel().y<5&&i.linvel().y>-5&&!z&&p[y].nowSpeed<p[y].maxSpeed&&(p[y].nowSpeed+=p[y].stepSpeed),t.userData.canBoostStep=!1;break;case"KeyS":case"ArrowDown":i.applyImpulse({x:0,y:0,z:-p[y].stepSpeed/2},!0),t.userData.playerBraking=!0;break;case"KeyA":case"ArrowLeft":t.userData.left=!0;break;case"KeyD":case"ArrowRight":t.userData.right=!0;break}}function Jt(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep=!0;break;case"KeyS":case"ArrowDown":i.linvel().y<.1&&(t.userData.playerBraking=!1);break;case"KeyA":case"ArrowLeft":t.userData.left=!1;break;case"KeyD":case"ArrowRight":t.userData.right=!1;break}}function E(e){let n,o;const r=e.rotation.clone();e.rotation.set(0,0,0);const a=new G().setFromObject(e).getSize(new f);if(e.rotation.copy(r),e.name.includes("player")?(t.userData.size=a,t.userData.orgRotation=r,n=m.createRigidBody(u.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),o=u.ColliderDesc.cuboid(a.x/5,a.y/1.5,a.z/3).setMass(e.userData.mass).setRestitution(0).setFriction(0),i=n,he=o,o.setActiveEvents(u.ActiveEvents.COLLISION_EVENTS),m.createCollider(o,n),t.userData.handle=i.handle,x.push([e,n,e.id])):e.name.includes("ground")&&(n=m.createRigidBody(u.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),o=u.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),m.createCollider(o,n),Je=n,j.userData.handle=Je.handle,x.push([e,n,e.id])),e.name.includes("wall")){n=m.createRigidBody(u.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0)),o=u.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(40);let c=m.createCollider(o,n);xe.push(c),x.push([e,n,e.id])}if(e.name.includes("moving_block")){n=m.createRigidBody(u.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!0,!0).setLinearDamping(0)),o=u.ColliderDesc.ball(a.x/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(20);let c=n;Re.push(c);let b=m.createCollider(o,n);xe.push(b),x.push([e,n,e.id])}e.name.includes("itsmen_body")&&(n=m.createRigidBody(u.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!0).setLinearDamping(0).setAngularDamping(0)),o=u.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(0).setRestitution(0).setFriction(0).setDensity(2),D.userData.body=n,D.userData.collider=o,m.createCollider(o,n),x.push([e,n,e.id])),e.name.includes("itsmen_left_hand")&&(n=m.createRigidBody(u.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=u.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),T.userData.body=n,T.userData.collider=o,m.createCollider(o,n),x.push([e,n,e.id])),e.name.includes("itsmen_right_hand")&&(n=m.createRigidBody(u.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=u.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),B.userData.body=n,B.userData.collider=o,m.createCollider(o,n),x.push([e,n,e.id])),e.name.includes("itsmen_left_leg")&&(n=m.createRigidBody(u.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=u.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),v.userData.body=n,v.userData.collider=o,m.createCollider(o,n),x.push([e,n,e.id])),e.name.includes("itsmen_right_leg")&&(n=m.createRigidBody(u.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=u.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),q.userData.body=n,q.userData.collider=o,m.createCollider(o,n),x.push([e,n,e.id]))}document.addEventListener("visibilitychange",function(){document.visibilityState==="visible"?(L&&(g==null||g.play()),i.linvel().z>3&&t.userData.onGround&&L&&(l==null||l.play()),!z&&R&&J==!1&&(C.start(),C.elapsedTime=t.userData.time)):(g==null||g.stop(),l==null||l.stop(),J==!1&&!z&&R&&(t.userData.time=C.getElapsedTime(),C.stop()))});
