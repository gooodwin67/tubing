import{S as O,C as K,F as W,H as q,a as G,D as j,b as P,A as I,P as N,c as V,W as U,d as X,V as p,R as L,e as Y,G as A,B as f}from"./three-JQ8oHkCl.js";import{O as m}from"./@dimforge-D3Mqfikn.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();function R(){let t=window.matchMedia||window.msMatchMedia;return t?t("(pointer:coarse)").matches:!1}var _=document.getElementById("startButton");_.addEventListener("click",ae);let y,B=[],e,r,D=[],g=new p,k=new L,C=!1,S=[],w,H=R(),J=new Y,b=0,E=1/60;const T=new L,Q=new p(0,-1,0),d=new O;d.background=new K(14479094),d.fog=new W(d.background,1,300);const v=new q(16777215,16777215,2);v.color.setHSL(.6,1,.6),v.groundColor.setHSL(.095,1,.75),v.position.set(0,100,0),d.add(v),new G(v,10);const c=new j(16777215,3);c.color.setHSL(.1,1,.95),c.position.set(0,1,0),c.position.multiplyScalar(10),c.castShadow=!0,d.add(c),c.shadow.mapSize.width=2048,c.shadow.mapSize.height=2048;const z=500;c.shadow.camera.left=-z,c.shadow.camera.right=z,c.shadow.camera.top=z,c.shadow.camera.bottom=-z,c.shadow.camera.far=350,c.shadow.bias=-.001;const Z=new P(c,10);d.add(Z),new I(11184810,1);const l=new N(75,window.innerWidth/window.innerHeight,.1,1e3);l.position.set(0,4,-10);let M=new V;document.body.appendChild(M.dom);const h=new U;h.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(h.domElement),h.shadowMap.enabled=!0,h.shadowMap.type=X,window.addEventListener("resize",$,!1);function $(){l.aspect=window.innerWidth/window.innerHeight,l.updateProjectionMatrix(),h.setSize(window.innerWidth,window.innerHeight)}async function ee(){await m.init(),y=new m.World(new m.Vector3(0,-9.81,0)),H=R(),document.body.addEventListener("touchstart",function(){this.requestFullscreen().then(()=>{screen.orientation.lock("landscape")})},!1),await new A().loadAsync("models/map-menu.glb").then(t=>{const o=t.scene;o.traverse(function(a){a.isMesh&&(a.castShadow=!0,a.receiveShadow=!0)}),o.traverse(a=>{if(a.name=="player")e=a.clone(),e.userData.mass=1,e.userData.playerStart=!1,e.userData.playerBraking=!1,e.userData.hTransition=0,e.userData.hSpeed=10,e.userData.maxHSpeed=.08,e.userData.stepSpeed=2,e.userData.maxSpeed=16,e.userData.resetHAngle=!1,e.userData.right=!1,e.userData.left=!1,e.userData.onGround=!1,e.userData.flying=!1,x(e),d.add(e);else if(a.name=="arrow_area")w=a.clone(),w.userData.hPos=0,d.add(w);else if(a.name.includes("ground")){new f().setFromObject(a).getSize(new p);let n=a.clone();n.userData.mass=0,x(n),S.push(n),d.add(n)}else if(a.name.includes("wall")){new f().setFromObject(a).getSize(new p);let n=a.clone();n.userData.mass=1,x(n),S.push(n),d.add(n)}else if(a.name.includes("area")){let n=a.clone();d.add(n)}else if(a.name.includes("selectlevel")){let n=a.clone();d.add(n),B.push(a)}})}),C=!0}async function te(t){const o=new A,a="models/map"+t+".glb";await o.loadAsync(a).then(n=>{const s=n.scene;s.traverse(function(i){i.isMesh&&(i.castShadow=!0,i.receiveShadow=!0)}),s.traverse(i=>{if(i.name.includes("ground")){new f().setFromObject(i).getSize(new p);let u=i.clone();u.userData.mass=0,u.name=i.name,x(u),S.push(u),d.add(u)}else if(i.name.includes("wall")){new f().setFromObject(i).getSize(new p);let u=i.clone();u.userData.mass=1,x(u),S.push(u),d.add(u)}else if(i.name.includes("area")){let u=i.clone();d.add(u)}})})}async function ae(){await ee();var t=document.getElementById("overlay");t.remove()}function ne(){if(C){H?(l.lookAt(new p(l.position.x,e.position.y,e.position.z+5)),l.position.y=e.position.y+5,l.position.z=e.position.z-3):(l.lookAt(new p(l.position.x,e.position.y,e.position.z+5)),l.position.y=e.position.y+4,l.position.z=e.position.z-4),w.position.set(e.position.x,e.position.y,e.position.z+5),oe(),y.step();for(let t=0,o=D.length;t<o;t++)D[t][0].position.copy(D[t][1].translation()),D[t][0].quaternion.copy(D[t][1].rotation())}M.update()}h.setAnimationLoop(()=>{b+=J.getDelta(),b>E&&(ne(),h.render(d,l),b=b%E)}),document.addEventListener("touchend",ie),document.addEventListener("touchstart",F),document.addEventListener("touchmove",F),window.addEventListener("keydown",re),window.addEventListener("keyup",de),document.addEventListener("mousedown",se,!1);function oe(){w.position.x+=e.userData.hTransition;const t=new p().subVectors(r.translation(),w.position).normalize();w.lookAt(e.position.x,e.position.y,e.position.z),r.setRotation({w:w.quaternion.w,x:r.rotation().x,y:w.quaternion.y,z:r.rotation().z}),r.setLinvel({x:t.x*-e.userData.hSpeed,y:r.linvel().y,z:r.linvel().z}),T.set(e.position,Q);const o=T.intersectObjects(S);o.length>0&&(o[0].distance<.4?(e.userData.flying=!1,!e.userData.onGround&&e.userData.flying,e.userData.onGround=!0):(e.userData.onGround=!1,e.userData.flying=!0)),e.userData.left&&e.userData.onGround&&e.userData.hTransition<5&&(e.userData.hTransition+=e.userData.maxHSpeed),e.userData.right&&e.userData.onGround&&e.userData.hTransition>-5&&(e.userData.hTransition-=e.userData.maxHSpeed),e.userData.resetHAngle&&!e.userData.left&&!e.userData.right&&(e.userData.hTransition<-e.userData.maxHSpeed?e.userData.hTransition+=e.userData.maxHSpeed:e.userData.hTransition>e.userData.maxHSpeed?e.userData.hTransition-=e.userData.maxHSpeed:e.userData.hTransition=0)}function F(t){if(e.userData.onGround){t=t.changedTouches[0];var o=h.domElement.getBoundingClientRect();g.x=(t.clientX-o.left)/o.width*2-1,g.y=-((t.clientY-o.top)/o.height)*2+1,k.setFromCamera(g,l),g.y>0?r.linvel().z<e.userData.maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&r.applyImpulse({x:0,y:0,z:e.userData.stepSpeed},!0):g.x>0?(e.userData.left=!1,e.userData.right=!0):(e.userData.right=!1,e.userData.left=!0)}}function se(t){t.preventDefault();var o=h.domElement.getBoundingClientRect();g.x=(t.clientX-o.left)/o.width*2-1,g.y=-((t.clientY-o.top)/o.height)*2+1,k.setFromCamera(g,l),B.forEach(a=>{a.geometry.computeBoundingBox();var n=a.geometry.boundingBox.clone();n.applyMatrix4(a.matrixWorld),k.ray.intersectBox(n,new p)&&te(a.name.slice(-1))})}function ie(t){e.userData.right=!1,e.userData.left=!1}function re(t){switch(t.code){case"KeyW":case"ArrowUp":r.linvel().z<e.userData.maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&r.applyImpulse({x:0,y:0,z:e.userData.stepSpeed},!0),e.userData.playerStart=!0;break;case"KeyS":case"ArrowDown":e.userData.playerBraking=!0;break;case"KeyA":case"ArrowLeft":e.userData.left=!0;break;case"KeyD":case"ArrowRight":e.userData.right=!0;break}}function de(t){switch(t.code){case"KeyW":case"ArrowUp":break;case"KeyS":case"ArrowDown":r.linvel().y<.1&&(e.userData.playerBraking=!1);break;case"KeyA":case"ArrowLeft":e.userData.left=!1;break;case"KeyD":case"ArrowRight":e.userData.right=!1;break}}function x(t){let o,a;const n=t.rotation.clone();t.rotation.set(0,0,0);const s=new f().setFromObject(t).getSize(new p);t.rotation.copy(n),t.name.includes("player")?(o=y.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(t.position.x,t.position.y,t.position.z).setRotation(t.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0).setAngularDamping(2)),a=m.ColliderDesc.cuboid(s.x/2,s.y/2,s.z/2).setMass(t.userData.mass).setRestitution(0).setFriction(0),r=o,y.createCollider(a,o),D.push([t,o,t.id])):t.name.includes("ground")&&(o=y.createRigidBody(m.RigidBodyDesc.fixed().setTranslation(t.position.x,t.position.y,t.position.z).setRotation(t.quaternion).setCanSleep(!1).enabledRotations(!0)),a=m.ColliderDesc.cuboid(s.x/2,s.y/2,s.z/2).setMass(t.userData.mass).setRestitution(0).setFriction(0),y.createCollider(a,o),D.push([t,o,t.id])),t.name.includes("wall")&&(o=y.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(t.position.x,t.position.y,t.position.z).setRotation(t.quaternion).setCanSleep(!1).enabledRotations(!0).setLinearDamping(0)),a=m.ColliderDesc.cuboid(s.x/3,s.y/2,s.z/3).setMass(t.userData.mass*20).setRestitution(0).setFriction(4),y.createCollider(a,o),D.push([t,o,t.id]))}
