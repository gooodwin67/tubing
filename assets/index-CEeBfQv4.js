import{C as se,S as Ne,a as We,F as je,H as Ke,b as Ge,D as Pe,c as Ue,A as Ye,P as Ve,d as Qe,W as Xe,e as $e,V as _,R as re,G as _e,B as J,f as Ze}from"./three-CPvv5sxK.js";import{O as d}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(l){if(l.ep)return;l.ep=!0;const o=n(l);fetch(l.href,o)}})();function be(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}let N=document.querySelector(".main_load"),we=document.querySelector(".main_menu"),fe=document.querySelector(".select_level"),et=document.querySelectorAll(".select_level .level_shadow"),tt=document.querySelector(".select_tube"),nt=document.querySelector(".finish_window"),at=document.querySelector(".finish_you_time .finish_you_time_time"),xe=document.querySelector(".boom_window"),ot=document.querySelectorAll("body>.overlay"),it=document.querySelector(".startButton"),st=document.querySelectorAll(".load_level_wrap>div"),rt=document.querySelectorAll(".load_level_wrap .level_time"),ve=document.querySelectorAll(".load_tubes_wrap>div"),V=document.querySelectorAll(".language_block>img"),qe=[],Ce=[],ze=document.querySelector(".times"),le=document.querySelector(".current_time"),Le=document.querySelector(".best_time"),lt=document.querySelector(".finish_window .finish_again"),ct=document.querySelector(".finish_window .finish_in_menu"),dt=document.querySelector(".boom_window .finish_again"),ut=document.querySelector(".boom_window .finish_in_menu"),ke=document.querySelector(".speed_block"),Ae=document.querySelector(".speed_block>.speed"),pt=document.querySelector(".shadow_check"),mt=document.querySelector(".instr_check"),Q=document.querySelector(".load_percent"),ce=document.querySelector(".pause_button_wrap"),yt=document.querySelector(".close_pause_button"),ht=document.querySelector(".reset_button"),St=document.querySelector(".inmenu_button"),gt=document.querySelector(".before_start"),Dt=document.querySelector(".instruction_start_btn"),_t=document.querySelector(".menu_in_game_wrap"),Ee=document.querySelector(".start_time"),Re=document.querySelector(".start_time_wrap"),bt=document.querySelector(".clear_rec");bt.addEventListener("click",()=>{localStorage.clear()}),V.forEach((e,n)=>{e.addEventListener("click",()=>{y.language!=n&&(V.forEach(a=>{a.classList.remove("selected")}),e.classList.add("selected"),y.language=n,localStorage.setItem("playerData",JSON.stringify(y)),Te(y.language))})});function Te(e){e==0?(document.querySelector(".title_game").src="/images/title.png",document.querySelector(".startgame_title").textContent="\u043D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".language_title").textContent="\u042F\u0437\u044B\u043A:",document.querySelectorAll(".level_text h2>span").forEach(n=>{n.textContent="\u0423\u0440\u043E\u0432\u0435\u043D\u044C"}),document.querySelectorAll(".leveltime_title").forEach(n=>{n.textContent="\u0412\u0440\u0435\u043C\u044F: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(n=>{n.textContent="\u0422\u044E\u0431\u0438\u043D\u0433"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(n=>{n.textContent="\u0421\u043A\u043E\u0440\u043E\u0441\u0442\u044C: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(n=>{n.textContent="\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435: "}),document.querySelector(".selecttubedesc_title").textContent="\u041F\u0440\u043E\u0445\u043E\u0434\u0438\u0442\u0435 \u0443\u0440\u043E\u0432\u043D\u0438, \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0442\u044E\u0431\u0438\u043D\u0433\u0438",document.querySelector(".menu_in_game_wrap_head").textContent="\u041F\u0430\u0443\u0437\u0430",document.querySelector(".close_pause_button").textContent="\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".reset_button").textContent="\u041D\u0430\u0447\u0430\u0442\u044C \u0437\u0430\u043D\u043E\u0432\u043E",document.querySelector(".inmenu_button").textContent="\u0412\u044B\u0439\u0442\u0438",document.querySelector(".finish_you_time_title").textContent="\u0412\u0430\u0448\u0435 \u0432\u0440\u0435\u043C\u044F: ",document.querySelector(".crash_title").textContent="\u0412\u044B \u0432\u0440\u0435\u0437\u0430\u043B\u0438\u0441\u044C",document.querySelector(".finish_title").textContent="\u0412\u044B \u043F\u0440\u0438\u0435\u0445\u0430\u043B\u0438",document.querySelectorAll(".finish_again").forEach(n=>{n.textContent="\u0415\u0449\u0435 \u0440\u0430\u0437"}),document.querySelectorAll(".finish_in_menu").forEach(n=>{n.textContent="\u0412 \u043C\u0435\u043D\u044E"}),document.querySelector(".current_time_title").textContent="\u0412\u0440\u0435\u043C\u044F",document.querySelector(".best_time_title").textContent="\u041B\u0443\u0447\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F",document.querySelector(".speed_title").textContent="\u041A\u041C/\u0427",document.querySelector(".instruction_start_btn").textContent="\u0421\u0422\u0410\u0420\u0422",document.querySelector(".instr-disabled span").textContent="\u0411\u043E\u043B\u044C\u0448\u0435 \u043D\u0435 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0442\u044C",document.querySelector(".desktop_instr").innerHTML=`<h2>\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435</h2>
    <span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 <span class='button_active'>W</span> \u0438\u043B\u0438 <span class='button_active'>\u2191</span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041A\u043B\u0430\u0432\u0438\u0448\u0430\u043C\u0438 <span>\u2190</span> <span>\u2192</span> \u0438\u043B\u0438 <span>A</span> <span>D</span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>
    <span>\u0426\u0435\u043B\u044C - \u0434\u043E\u0435\u0445\u0430\u0442\u044C \u0434\u043E \u0444\u0438\u043D\u0438\u0448\u0430 \u0437\u0430 \u043A\u0440\u0430\u0442\u0447\u0430\u0439\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F</span>`,document.querySelector(".mobile_instr").innerHTML=`<span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 \u043D\u0430 \u0437\u043E\u043D\u0443 <span> \u2191 </span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041D\u0430\u0436\u0438\u043C\u0430\u044F \u043D\u0430 \u0437\u043E\u043D\u044B <span> \u2190 </span> \u0438 <span> \u2192 </span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>
    <img src="/images/instr-mobile.png" alt="">`):(document.querySelector(".title_game").src="/images/title-en.png",document.querySelector(".startgame_title").textContent="start game",document.querySelector(".language_title").textContent="Language:",document.querySelectorAll(".level_text h2>span").forEach(n=>{n.textContent="Level"}),document.querySelectorAll(".leveltime_title").forEach(n=>{n.textContent="Time: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(n=>{n.textContent="Tubing"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(n=>{n.textContent="Speed: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(n=>{n.textContent="Control: "}),document.querySelector(".selecttubedesc_title").textContent="Complete the levels to unlock the tubings",document.querySelector(".menu_in_game_wrap_head").textContent="Pause",document.querySelector(".close_pause_button").textContent="Continue",document.querySelector(".reset_button").textContent="Start again",document.querySelector(".inmenu_button").textContent="Exit to levels",document.querySelector(".finish_you_time_title").textContent="You time: ",document.querySelector(".crash_title").textContent="You crashed",document.querySelector(".finish_title").textContent="You finished",document.querySelectorAll(".finish_again").forEach(n=>{n.textContent="Again"}),document.querySelectorAll(".finish_in_menu").forEach(n=>{n.textContent="In Menu"}),document.querySelector(".current_time_title").textContent="Time",document.querySelector(".best_time_title").textContent="Best time",document.querySelector(".speed_title").textContent="KM/H",document.querySelector(".instruction_start_btn").textContent="START",document.querySelector(".instr-disabled span").textContent="Don't show again",document.querySelector(".desktop_instr").innerHTML=`<h2>Instructions</h2>
    <span>Quickly press <span class='button_active'>W</span> or <span class='button_active'>\u2191</span> to accelerate to the starting point</span>
    <span>Use <span>\u2190</span> <span>\u2192</span> or <span>A</span> <span>D</span> keys to control the tubing</span>
    <span>The goal is to reach the finish line in the shortest time</span>`,document.querySelector(".mobile_instr").innerHTML=`<span>Quickly press on zone <span> \u2191 </span> to accelerate to the starting point</span>
    <span>By taps on zones <span> \u2190 </span> and <span> \u2192 </span> control the tubing</span>
    <img src="/images/instr-mobile.png" alt="">`)}st.forEach((e,n)=>{e.addEventListener("click",async()=>{n+1<=De+10&&(M=n+1,ve.forEach((a,l)=>{u[l].levels.includes(M)?(a.classList.remove("disabledTube"),u[l].canInLevel=!0):(a.classList.add("disabledTube"),u[l].canInLevel=!1)}),S(N),await Y(!1,!0),S(tt))})}),ve.forEach((e,n)=>{e.addEventListener("click",()=>{u[n].canInLevel&&(m=n,S(0),P())})});function P(){if(!y.canStart)S(gt),ne?document.querySelector(".mobile_instr").classList.remove("hidden_instr"):document.querySelector(".desktop_instr").classList.remove("hidden_instr");else{ze.classList.remove("hidden_block"),ke.classList.remove("hidden_block"),X[m].position.copy(s.translation());let e=2;ue=!0;let n=setInterval(a=>{Re.classList.remove("hidden_block"),e++,e==4?(ue=!1,Ee.textContent="GO",E=!0,ce.classList.remove("hidden_block"),clearInterval(n),setTimeout(()=>{Re.classList.add("hidden_block")},600)):Ee.textContent=4-e},1e3)}}Dt.addEventListener("click",()=>{y.canStart=!0,S(0),P()}),it.addEventListener("click",()=>{ne=be(),ne&&document.body.requestFullscreen().then(()=>{screen.orientation.lock("landscape")}),we.classList.add("hidden_block"),fe.classList.remove("hidden_block")});function S(e){ot.forEach(n=>{n.classList.add("hidden_block")}),e!=0&&e.classList.remove("hidden_block")}lt.addEventListener("click",async()=>{S(N),await G(),await Y(!0,!0),S(0),P()}),dt.addEventListener("click",async()=>{S(N),await G(),await Y(!0,!0),S(0),P()}),ht.addEventListener("click",async()=>{await G(),await Y(!0,!0),S(0),P()}),ct.addEventListener("click",async()=>{S(N),await G(),await ie()}),ut.addEventListener("click",async()=>{S(N),await G(),await ie()}),St.addEventListener("click",async()=>{S(N),await G(),await ie()}),ce.addEventListener("click",()=>{ue==!1&&E&&!C&&(S(_t),t.userData.time=v.getElapsedTime(),v.stop(),W=!0)}),yt.addEventListener("click",()=>{S(0),v.start(),v.elapsedTime=t.userData.time,W=!1}),pt.onchange=function(){this.checked?(L.shadowMap.enabled=!0,c.traverse(e=>{e.material&&(e.material.needsUpdate=!0)})):(L.shadowMap.enabled=!1,c.traverse(e=>{e.material&&(e.material.needsUpdate=!0)}))},mt.onchange=function(){this.checked?(y.canStart=!0,localStorage.setItem("playerData",JSON.stringify(y))):(y.canStart=!1,localStorage.setItem("playerData",JSON.stringify(y)))};let p,Be=!0;performance.now();let wt=[],M=0,W=!1,t,s,de,ue=!1,X=[],m=0,I,pe,me,C;const u=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,nowSpeed:0,maxSpeed:26,resetHAngle:!1,levels:[1,2,3,4,5,6,7,8],canInLevel:!1},{hSpeed:12,maxHSpeed:.1,stepSpeed:2,nowSpeed:0,maxSpeed:38,resetHAngle:!1,levels:[5,6,7,8],canInLevel:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:3,nowSpeed:0,maxSpeed:44,resetHAngle:!0,levels:[6,7,8],canInLevel:!1}];let Ie,w=[],B=new _,ye=new re,E=!1,he=!1,H,Me,He,h,R,T,f,x,$,Z,ee,j,K,Se,F=[],te=[],ge=[],g,ne=be(),ft=new se,v=new se,ae=0,Fe=1/60,O=0,z=0,De=2,y;const Oe=new re,xt=new _(0,-1,0),c=new Ne;c.background=new We(14479094),c.fog=new je(c.background,1,300);const U=new Ke(16777215,16777215,2);U.color.setHSL(.6,1,.6),U.groundColor.setHSL(.095,1,.75),U.position.set(0,100,0),new Ge(U,10);const q=new Pe(16777215,3);q.position.set(1,2,.2),q.position.multiplyScalar(120),q.castShadow=!0,q.shadow.mapSize.width=2048,q.shadow.mapSize.height=2048;const oe=1e3;q.shadow.camera.left=-oe,q.shadow.camera.right=oe,q.shadow.camera.top=oe,q.shadow.camera.bottom=-oe,q.shadow.camera.far=3500,q.shadow.bias=-.001,new Ue(q,10),new Ye(11184810,1);const b=new Ve(85,document.body.offsetWidth/document.body.offsetHeight,.1,600);b.position.set(0,4,-10);let vt=new Qe;const L=new Xe;L.setSize(document.body.offsetWidth,document.body.offsetHeight),document.body.appendChild(L.domElement),L.shadowMap.enabled=!0,L.shadowMap.type=$e,window.addEventListener("resize",qt,!1);function qt(){b.aspect=document.body.offsetWidth/document.body.offsetHeight,b.updateProjectionMatrix(),L.setSize(document.body.offsetWidth,document.body.offsetHeight)}async function Ct(){localStorage.getItem("playerData")?(y=JSON.parse(localStorage.getItem("playerData")),V.forEach(e=>{e.classList.remove("selected")}),V[y.language].classList.add("selected"),Te(y.language)):(y={levelsTimes:{},canStart:!1,language:0},localStorage.setItem("playerData",JSON.stringify(y))),JSON.stringify(y),De=0,et.forEach((e,n)=>{n<Object.keys(y.levelsTimes).length+2&&(De++,e.classList.remove("level_disabled"))}),rt.forEach((e,n,a)=>{y.levelsTimes["time"+(n+1)]!=null?e.childNodes[2].textContent=y.levelsTimes["time"+(n+1)]:e.childNodes[2].textContent="00.000"})}async function zt(){v=new se,c.add(q),c.add(U),z=0,await d.init(),p=new d.World(new d.Vector3(0,-9.81,0)),await new _e().loadAsync("models/map-menu.glb",onprogress=r=>{console.log(`Loaded: ${r.loaded}, Total: ${r.total}`);let D=Math.min(Math.round(r.loaded/r.total*100),100);Q.textContent=D+"%"}).then(r=>{const D=r.scene;Q.textContent="0",D.traverse(i=>{if(i.name=="player")t=i.clone(),t.userData.vertices=t.geometry.attributes.position.array,t.userData.indices=t.geometry.index.array,t.castShadow=!0,t.receiveShadow=!0,t.material.transparent=!0,t.material.opacity=0,t.userData.mass=1,t.userData.playerBraking=!1,t.userData.hTransition=0,t.userData.currentSpeed=0,t.userData.boom=!1,t.userData.onStartArea=!0,t.userData.canBoostStep=!0,t.userData.time=0,t.userData.right=!1,t.userData.left=!1,t.userData.onGround=!1,t.userData.flying=!1,t.userData.origPosition=t.position,k(t),c.add(t);else if(i.name.includes("player-tube"))I=i.clone(),I.userData.startPosition=new _(I.position.x,I.position.y,I.position.z),X[i.name.slice(-1)-1]=I,c.add(I);else if(i.name=="arrow_area")g=i.clone(),g.userData.hPos=0,c.add(g);else if(i.name.includes("ground"))new J().setFromObject(i).getSize(new _),H=i.clone(),H.receiveShadow=!0,H.userData.mass=0,k(H),F.push(H),c.add(H),i.name=="left_ground_wall"?Me=i.position:i.name=="right_ground_wall"&&(He=i.position);else if(i.name.includes("wall")){new J().setFromObject(i).getSize(new _);let A=i.clone();A.castShadow=!0,A.receiveShadow=!0,A.userData.mass=1,k(A),F.push(A),te.push(A),c.add(A)}else if(i.name.includes("area")){let A=i.clone();A.castShadow=!0,c.add(A)}else i.name.includes("start_flag")?(pe=i.clone(),c.add(pe)):i.name.includes("itsmen_body")?(h=i.clone(),h.material.transparent=!0,h.material.opacity=0,c.add(h),k(h)):i.name.includes("itsmen_left_hand")?(R=i.clone(),R.material.transparent=!0,R.material.opacity=0,c.add(R),k(R)):i.name.includes("itsmen_right_hand")?(T=i.clone(),T.material.transparent=!0,T.material.opacity=0,c.add(T),k(T)):i.name.includes("itsmen_left_leg")?(f=i.clone(),f.material.transparent=!0,f.material.opacity=0,c.add(f),k(f)):i.name.includes("itsmen_right_leg")?(x=i.clone(),x.material.transparent=!0,x.material.opacity=0,c.add(x),k(x)):i.name.includes("qmen_body")?($=i.clone(),c.add($)):i.name.includes("qmen_left_hand")?(Z=i.clone(),c.add(Z)):i.name.includes("qmen_right_hand")?(ee=i.clone(),c.add(ee)):i.name.includes("qmen_left_leg")?(j=i.clone(),c.add(j)):i.name.includes("qmen_right_leg")&&(K=i.clone(),c.add(K))})}),c.traverse(function(r){r.material&&(r.material.needsUpdate=!0)}),await Ct();let e=d.JointData.spherical({x:.2,y:0,z:-.2},{x:-.4,y:0,z:0});p.createImpulseJoint(e,h.userData.body,R.userData.body,!0);let n=d.JointData.spherical({x:-.2,y:0,z:-.2},{x:.4,y:0,z:0});p.createImpulseJoint(n,h.userData.body,T.userData.body,!0);let a=d.JointData.spherical({x:.22,y:0,z:.5},{x:0,y:0,z:-.5});p.createImpulseJoint(a,h.userData.body,f.userData.body,!0);let l=d.JointData.spherical({x:-.22,y:0,z:.5},{x:0,y:0,z:-.5});p.createImpulseJoint(l,h.userData.body,x.userData.body,!0);let o=d.JointData.spherical({x:0,y:0,z:0},{x:0,y:.3,z:0});Se=p.createImpulseJoint(o,h.userData.body,s,!0),he=!0}async function Lt(){C=!1;const e=new _e,n="models/map"+M+".glb";await e.loadAsync(n,onprogress=a=>{let l=Math.min(Math.round(a.loaded/a.total*100),100);Q.textContent=l+"%"}).then(a=>{const l=a.scene;Q.textContent="0",l.traverse(o=>{if(o.name.includes("ground")){new J().setFromObject(o).getSize(new _);let r=o.clone();r.receiveShadow=!0,r.userData.mass=0,r.name=o.name,k(r),F.push(r),c.add(r)}else if(o.name.includes("wall")){new J().setFromObject(o).getSize(new _);let r=o.clone();r.userData.mass=1,k(r),F.push(r),te.push(r),c.add(r)}else if(o.name.includes("moving_block")){const r=new J().setFromObject(o).getSize(new _);let D=o.clone();D.userData.size=r,D.userData.mass=1,D.userData.raycaster=new re,D.userData.speed=-o.name.substr(o.name.indexOf("speed")+6),D.userData.direction=new _(D.userData.speed,0,0),qe.push(D),k(D),te.push(D),c.add(D)}else if(o.name.includes("area")){let r=o.clone();r.castShadow=!0,r.receiveShadow=!0,c.add(r)}else o.name.includes("finish_block")&&(me=o.clone(),c.add(me))})}),Le.textContent=y.levelsTimes["time"+M]}async function kt(){const e=new Ze;t.add(e)}async function ie(){await Y(!0,!1),Be?(S(we),Be=!1):S(fe)}ie();async function Y(e,n){e&&await zt(),n&&await Lt(),await kt()}async function G(){for(E=!1,he=!1,z=0,t.userData.time=0,t.userData.boom=!1,u.forEach(e=>{e.nowSpeed=0}),F=[],te=[],w=[],ce.classList.add("hidden_block"),ze.classList.add("hidden_block"),ke.classList.add("hidden_block"),v.start(),v.elapsedTime=t.userData.time,W=!1,t.userData.currentSpeed=0,Ae.textContent=t.userData.currentSpeed,z=0,le.textContent=z;c.children.length>0;){let e=c.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(n=>n.dispose()):e.material.dispose()),c.remove(e)}C=!1}function At(){if(performance.now(),he&&!C&&(ne?t.userData.boom?b.lookAt(h.position):(b.lookAt(new _(b.position.x,t.position.y,t.position.z+5)),b.position.y=t.position.y+5,b.position.z=t.position.z-3):t.userData.boom?I.position.y>0&&b.lookAt(h.position):(b.lookAt(new _(b.position.x,t.position.y,t.position.z+5)),b.position.y=t.position.y+4,b.position.z=t.position.z-4),g.position.set(t.position.x,t.position.y,t.position.z+5)),E){C?S(nt):(z=v.getElapsedTime().toFixed(3),le.textContent=z,Rt(),Et()),t.position.x>Me.x-t.userData.size.x/1.3&&(g.position.x=t.position.x,t.userData.hTransition=-.4),t.position.x<He.x+t.userData.size.x/1.3&&(g.position.x=t.position.x,t.userData.hTransition=.4);let e=new d.EventQueue(!0);p.step(e),X[m].position.copy(s.translation()),X[m].quaternion.copy(s.rotation()),$.position.copy(h.position),$.rotation.copy(h.rotation),Z.position.copy(R.position),Z.rotation.copy(R.rotation),ee.position.copy(T.position),ee.rotation.copy(T.rotation),j.position.copy(f.position),j.rotation.copy(f.rotation),K.position.copy(x.position),K.rotation.copy(x.rotation);for(let n=0,a=w.length;n<a;n++)w[n][0].position.copy(w[n][1].translation()),w[n][0].quaternion.copy(w[n][1].rotation());e.drainCollisionEvents((n,a,l)=>{ge.forEach((o,r)=>{s.handle==n&&o.handle==a&&!C?s.linvel().z<15&&t.userData.boom==!1&&(p.removeImpulseJoint(Se),h.userData.body.applyImpulse({x:5,y:5,z:5},!0),h.userData.body.setEnabledRotations(!0),de.setFriction(20),setTimeout(()=>{E=!1,S(xe)},3e3),t.userData.boom=!0):s.handle==n&&!C&&s.linvel().z<15&&t.position.y<5&&t.userData.boom==!1&&(p.removeImpulseJoint(Se),h.userData.body.applyImpulse({x:5,y:5,z:5},!0),h.userData.body.setEnabledRotations(!0),de.setFriction(20),t.userData.boom=!0,setTimeout(()=>{E=!1,S(xe)},3e3))})})}vt.update()}L.setAnimationLoop(()=>{ae+=ft.getDelta(),ae>Fe&&!W&&(At(),L.render(c,b),ae=ae%Fe)}),document.addEventListener("touchend",Bt),document.addEventListener("touchstart",Je),document.addEventListener("touchmove",Je),window.addEventListener("keydown",It),window.addEventListener("keyup",Mt),document.addEventListener("mousedown",Tt,!1);function Et(){qe.forEach((e,n)=>{let a=e,l=Ce[n];l.setLinvel(a.userData.direction,!0),l.setAngvel({x:a.userData.direction.z,y:a.userData.direction.y,z:-a.userData.direction.x},!0);const o=a.userData.direction;a.userData.raycaster.set(new _(a.position.x,.4,a.position.z),o.clone().normalize());const r=a.userData.raycaster.intersectObjects(F);r.length>0&&r[0].distance<a.userData.size.x/2&&(a.userData.direction.x=a.userData.direction.x*-1)})}function Rt(){t.position.z>me.position.z&&!t.userData.boom&&(z=v.getElapsedTime().toFixed(3),le.textContent=z,C=!0,at.textContent=z,y.levelsTimes["time"+M]!=null?O=y.levelsTimes["time"+M]:O=0,(z<O||O==0)&&(O=z,Le.textContent=O,y.levelsTimes["time"+M]=O,localStorage.setItem("playerData",JSON.stringify(y))),t.position.z=0),g.position.x+=t.userData.hTransition;const e=new _().subVectors(s.translation(),g.position).normalize(),n=s.linvel(),a=new _(e.x*-u[m].hSpeed,n.y,e.z*-u[m].nowSpeed);s.translation().y<68&&s.translation().y>=10&&(u[m].nowSpeed+=.05,s.rotation().x<.04&&s.setRotation({w:s.rotation().w,x:.04,y:s.rotation().y,z:s.rotation().z})),s.translation().y<10&&s.translation().y>1&&s.rotation().x<.04&&s.lockRotations(!0,!0,!0),s.setLinvel(a,!0),g.lookAt(g.position.x-(t.position.x-g.position.x),g.position.y-(t.position.y-g.position.y),g.position.z-(t.position.z-g.position.z)),s.setRotation({w:g.quaternion.w,x:s.rotation().x,y:g.quaternion.y,z:s.rotation().z}),h.userData.body.setRotation({w:g.quaternion.w,x:s.rotation().x,y:g.quaternion.y,z:s.rotation().z}),(j.rotation.y>0||j.rotation.y<0)&&f.userData.body.setRotation({w:f.userData.body.rotation().w,x:f.userData.body.rotation().x,y:0,z:f.userData.body.rotation().z}),(K.rotation.y>0||K.rotation.y<0)&&x.userData.body.setRotation({w:x.userData.body.rotation().w,x:x.userData.body.rotation().x,y:0,z:x.userData.body.rotation().z}),Oe.set(t.position,xt);const l=Oe.intersectObjects(F);l.length>0&&(l[0].distance<.4?(t.userData.flying=!1,!t.userData.onGround&&t.userData.flying,t.userData.onGround=!0):(t.userData.onGround=!1,t.userData.flying=!0)),s.linvel().z>0?t.userData.currentSpeed=s.linvel().z.toFixed(0):t.userData.currentSpeed=0,Ae.textContent=t.userData.currentSpeed,t.userData.left&&t.userData.onGround&&!t.userData.onStartArea&&(t.userData.hTransition<5&&(t.userData.hTransition+=u[m].maxHSpeed),u[m].nowSpeed-=.009),t.userData.right&&t.userData.onGround&&!t.userData.onStartArea&&(t.userData.hTransition>-5&&(t.userData.hTransition-=u[m].maxHSpeed),u[m].nowSpeed-=.009),u[m].resetHAngle&&!t.userData.left&&!t.userData.right&&(t.userData.hTransition<-u[m].maxHSpeed?t.userData.hTransition+=u[m].maxHSpeed:t.userData.hTransition>u[m].maxHSpeed?t.userData.hTransition-=u[m].maxHSpeed:t.userData.hTransition=0),t.position.z>pe.position.z?(t.userData.onStartArea&&s.lockRotations(!1,!0,!0),t.userData.onStartArea=!1):(t.userData.onStartArea=!0,s.lockRotations(!0,!0,!0))}function Je(e){if(t.userData.onGround){e=e.changedTouches[0];var n=L.domElement.getBoundingClientRect();B.x=(e.clientX-n.left)/n.width*2-1,B.y=-((e.clientY-n.top)/n.height)*2+1,ye.setFromCamera(B,b),B.y>0&&t.userData.canBoostStep&&E&&t.userData.onStartArea&&s.linvel().z<u[m].maxSpeed&&s.linvel().y<5&&s.linvel().y>-5&&!C&&u[m].nowSpeed<u[m].maxSpeed&&(u[m].nowSpeed+=u[m].stepSpeed),t.userData.canBoostStep=!1,B.y<0&&(B.x>0?(t.userData.left=!1,t.userData.right=!0):(t.userData.right=!1,t.userData.left=!0))}}function Tt(e){e.preventDefault();var n=L.domElement.getBoundingClientRect();B.x=(e.clientX-n.left)/n.width*2-1,B.y=-((e.clientY-n.top)/n.height)*2+1,ye.setFromCamera(B,b),wt.forEach(a=>{a.geometry.computeBoundingBox();var l=a.geometry.boundingBox.clone();l.applyMatrix4(a.matrixWorld),ye.ray.intersectBox(l,new _)})}function Bt(e){t.userData.right=!1,t.userData.left=!1,t.userData.canBoostStep=!0}function It(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep&&E&&t.userData.onStartArea&&s.linvel().z<u[m].maxSpeed&&s.linvel().y<5&&s.linvel().y>-5&&!C&&u[m].nowSpeed<u[m].maxSpeed&&(u[m].nowSpeed+=u[m].stepSpeed),t.userData.canBoostStep=!1;break;case"KeyS":case"ArrowDown":s.applyImpulse({x:0,y:0,z:-u[m].stepSpeed/2},!0),t.userData.playerBraking=!0;break;case"KeyA":case"ArrowLeft":t.userData.left=!0;break;case"KeyD":case"ArrowRight":t.userData.right=!0;break}}function Mt(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep=!0;break;case"KeyS":case"ArrowDown":s.linvel().y<.1&&(t.userData.playerBraking=!1);break;case"KeyA":case"ArrowLeft":t.userData.left=!1;break;case"KeyD":case"ArrowRight":t.userData.right=!1;break}}function k(e){let n,a;const l=e.rotation.clone();e.rotation.set(0,0,0);const o=new J().setFromObject(e).getSize(new _);if(e.rotation.copy(l),e.name.includes("player")?(t.userData.size=o,t.userData.orgRotation=l,n=p.createRigidBody(d.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),a=d.ColliderDesc.cuboid(o.x/5,o.y/1.5,o.z/3).setMass(e.userData.mass).setRestitution(0).setFriction(0),s=n,de=a,a.setActiveEvents(d.ActiveEvents.COLLISION_EVENTS),p.createCollider(a,n),t.userData.handle=s.handle,w.push([e,n,e.id])):e.name.includes("ground")&&(n=p.createRigidBody(d.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),a=d.ColliderDesc.cuboid(o.x/2,o.y/2,o.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),p.createCollider(a,n),Ie=n,H.userData.handle=Ie.handle,w.push([e,n,e.id])),e.name.includes("wall")){n=p.createRigidBody(d.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0)),a=d.ColliderDesc.cuboid(o.x/2,o.y/2,o.z/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(40);let r=p.createCollider(a,n);ge.push(r),w.push([e,n,e.id])}if(e.name.includes("moving_block")){n=p.createRigidBody(d.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!0,!0).setLinearDamping(0)),a=d.ColliderDesc.ball(o.x/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(20);let r=n;Ce.push(r);let D=p.createCollider(a,n);ge.push(D),w.push([e,n,e.id])}e.name.includes("itsmen_body")&&(n=p.createRigidBody(d.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!0).setLinearDamping(0).setAngularDamping(0)),a=d.ColliderDesc.cuboid(o.x/2,o.y/2,o.z/2).setMass(0).setRestitution(0).setFriction(0).setDensity(2),h.userData.body=n,h.userData.collider=a,p.createCollider(a,n),w.push([e,n,e.id])),e.name.includes("itsmen_left_hand")&&(n=p.createRigidBody(d.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),a=d.ColliderDesc.capsule(o.z/2,o.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),R.userData.body=n,R.userData.collider=a,p.createCollider(a,n),w.push([e,n,e.id])),e.name.includes("itsmen_right_hand")&&(n=p.createRigidBody(d.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),a=d.ColliderDesc.capsule(o.z/2,o.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),T.userData.body=n,T.userData.collider=a,p.createCollider(a,n),w.push([e,n,e.id])),e.name.includes("itsmen_left_leg")&&(n=p.createRigidBody(d.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),a=d.ColliderDesc.capsule(o.z/2,o.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),f.userData.body=n,f.userData.collider=a,p.createCollider(a,n),w.push([e,n,e.id])),e.name.includes("itsmen_right_leg")&&(n=p.createRigidBody(d.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),a=d.ColliderDesc.capsule(o.z/2,o.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),x.userData.body=n,x.userData.collider=a,p.createCollider(a,n),w.push([e,n,e.id]))}document.addEventListener("visibilitychange",function(){document.visibilityState==="visible"?!C&&E&&W==!1&&(v.start(),v.elapsedTime=t.userData.time):W==!1&&!C&&E&&(t.userData.time=v.getElapsedTime(),v.stop())});
