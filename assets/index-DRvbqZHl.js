import{S as ie,C as ae,F as re,H as se,a as de,D as ce,b as le,A as ue,P as pe,c as me,W as ye,d as he,V as u,R as I,e as C,G as N,B as b}from"./three-JQ8oHkCl.js";import{O as m}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const v of i.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&a(v)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();function H(e,n){e.geometry.computeBoundingBox(),n.forEach(function(i,v,G){i.children.length>0?i.children.forEach(function(w,ne,oe){w.geometry.computeBoundingBox()}):i.geometry.computeBoundingBox()}),e.updateMatrixWorld(),n.forEach(function(i,v,G){i.updateMatrixWorld()});let a=e.geometry.boundingBox.clone();a.applyMatrix4(e.matrixWorld);var o=!1;return n.forEach(function(i,v,G){if(i.children.length>0)i.children.forEach(function(w,ne,oe){let j=w.geometry.boundingBox.clone();j.applyMatrix4(w.matrixWorld),a.intersectsBox(j)&&(o=w)});else{let w=i.geometry.boundingBox.clone();w.applyMatrix4(i.matrixWorld),a.intersectsBox(w)&&(o=i)}}),o}function U(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}let M=document.querySelector(".main_load"),V=document.querySelector(".main_menu"),we=document.querySelector(".select_level"),fe=document.querySelector(".select_tube"),ge=document.querySelector(".finish_window"),De=document.querySelectorAll("body>.overlay"),Se=document.querySelector(".startButton"),xe=document.querySelectorAll(".load_level_wrap>div"),ve=document.querySelectorAll(".load_tubes_wrap>div"),be=document.querySelector(".current_time"),ze=document.querySelector(".best_time"),ke=document.querySelector(".finish_again"),Le=document.querySelector(".finish_in_menu"),Ae=document.querySelector(".speed_block>.speed"),Be=document.querySelector(".shadow_check");xe.forEach((e,n)=>{e.addEventListener("click",async()=>{X=n+1,f(M),await P(!1,!0),f(fe)})}),ve.forEach((e,n)=>{e.addEventListener("click",()=>{d=n,f(0),E=!0})}),Se.addEventListener("click",()=>{K=U(),K&&document.body.requestFullscreen().then(()=>{screen.orientation.lock("landscape")}),V.classList.add("hidden_block"),we.classList.remove("hidden_block")});function f(e){De.forEach(n=>{n.classList.add("hidden_block")}),e!=0&&e.classList.remove("hidden_block")}ke.addEventListener("click",async()=>{f(M),await ee(),await P(!0,!0),f(0),E=!0}),Le.addEventListener("click",async()=>{f(M),await ee(),await $()}),Be.onchange=function(){this.checked};let g,Ee=[],X=0,t,r,T=[],d=0,z=[],F,x;const p=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,maxSpeed:26,resetHAngle:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:10,maxSpeed:180,resetHAngle:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:3,maxSpeed:30,resetHAngle:!1}];let D=[],S=new u,W=new I,E=!1,O=!1,k=[],y,K=U(),qe=new C,Y=new C,q=0,J=1/60,_=0,L=0;const Q=new I,_e=new u(0,-1,0),s=new ie;s.background=new ae(14479094),s.fog=new re(s.background,1,300);const A=new se(16777215,16777215,2);A.color.setHSL(.6,1,.6),A.groundColor.setHSL(.095,1,.75),A.position.set(0,100,0),new de(A,10);const l=new ce(16777215,3);l.position.set(1,2,.2),l.position.multiplyScalar(120),l.castShadow=!0,l.shadow.mapSize.width=2048,l.shadow.mapSize.height=2048;const R=1e3;l.shadow.camera.left=-R,l.shadow.camera.right=R,l.shadow.camera.top=R,l.shadow.camera.bottom=-R,l.shadow.camera.far=3500,l.shadow.bias=-.001,new le(l,10),new ue(11184810,1);const c=new pe(75,window.innerWidth/window.innerHeight,.1,1e3);c.position.set(0,4,-10);let Z=new me;document.body.appendChild(Z.dom);const h=new ye;h.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(h.domElement),h.shadowMap.enabled=!0,h.shadowMap.type=he,window.addEventListener("resize",Re,!1);function Re(){c.aspect=window.innerWidth/window.innerHeight,c.updateProjectionMatrix(),h.setSize(window.innerWidth,window.innerHeight)}async function Ce(){Y=new C,s.add(l),s.add(A),L=0,await m.init(),g=new m.World(new m.Vector3(0,-9.81,0)),await new N().loadAsync("models/map-menu.glb").then(e=>{e.scene.traverse(n=>{if(n.name=="player")t=n.clone(),t.userData.vertices=t.geometry.attributes.position.array,t.userData.indices=t.geometry.index.array,t.castShadow=!0,t.receiveShadow=!0,t.material.transparent=!0,t.material.opacity=1,t.userData.mass=1,t.userData.playerStart=!1,t.userData.playerBraking=!1,t.userData.hTransition=0,t.userData.currentSpeed=0,t.userData.right=!1,t.userData.left=!1,t.userData.onGround=!1,t.userData.flying=!1,t.userData.origPosition=t.position,B(t),s.add(t);else if(n.name.includes("player-tube")){var a=n.clone();a.userData.startPosition=new u(a.position.x,a.position.y,a.position.z),T[n.name.slice(-1)-1]=a,s.add(a)}else if(n.name=="arrow_area")y=n.clone(),y.userData.hPos=0,s.add(y);else if(n.name.includes("ground")){new b().setFromObject(n).getSize(new u);let o=n.clone();o.receiveShadow=!0,o.userData.mass=0,B(o),k.push(o),s.add(o)}else if(n.name.includes("wall")){new b().setFromObject(n).getSize(new u);let o=n.clone();o.castShadow=!0,o.receiveShadow=!0,o.userData.mass=1,B(o),k.push(o),s.add(o)}else if(n.name.includes("area")){let o=n.clone();o.castShadow=!0,s.add(o)}})}),s.traverse(function(e){e.material&&(e.material.needsUpdate=!0)}),O=!0}async function He(){x=!1;const e=new N,n="models/map"+X+".glb";await e.loadAsync(n).then(a=>{a.scene.traverse(o=>{if(o.name.includes("ground")){new b().setFromObject(o).getSize(new u);let i=o.clone();i.receiveShadow=!0,i.userData.mass=0,i.name=o.name,B(i),k.push(i),s.add(i)}else if(o.name.includes("wall")){new b().setFromObject(o).getSize(new u);let i=o.clone();i.userData.mass=1,B(i),k.push(i),s.add(i)}else if(o.name.includes("area")){let i=o.clone();i.castShadow=!0,i.receiveShadow=!0,s.add(i),o.name.includes("star_area")&&z.push(i)}else o.name.includes("finish_block")&&(F=o.clone(),s.add(F))})})}async function $(){await P(!0,!1),f(V)}$();async function P(e,n){e&&await Ce(),n&&await He()}async function ee(){for(E=!1,O=!1;s.children.length>0;){let e=s.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(n=>n.dispose()):e.material.dispose()),s.remove(e)}x=!1}function Me(){if(O&&!x&&(K?(c.lookAt(new u(c.position.x,t.position.y,t.position.z+5)),c.position.y=t.position.y+5,c.position.z=t.position.z-3):(c.lookAt(new u(c.position.x,t.position.y,t.position.z+5)),c.position.y=t.position.y+4,c.position.z=t.position.z-4),y.position.set(t.position.x,t.position.y,t.position.z+5)),E){x?f(ge):(Te(),z.forEach((e,n,a)=>{e.rotation.z+=.05}),H(t,z)&&(console.log(H(t,z)),s.remove(H(t,z))),L=Y.getElapsedTime().toFixed(3),be.textContent=L),g.step(),T[d].position.copy(r.translation()),T[d].quaternion.copy(r.rotation());for(let e=0,n=D.length;e<n;e++)D[e][0].position.copy(D[e][1].translation()),D[e][0].quaternion.copy(D[e][1].rotation())}Z.update()}h.setAnimationLoop(()=>{q+=qe.getDelta(),q>J&&(Me(),h.render(s,c),q=q%J)}),document.addEventListener("touchend",We),document.addEventListener("touchstart",te),document.addEventListener("touchmove",te),window.addEventListener("keydown",Oe),window.addEventListener("keyup",Ke),document.addEventListener("mousedown",Fe,!1);function Te(){t.position.z>F.position.z&&(x=!0,(L<_||_==0)&&(_=L,ze.textContent=_),t.position.z=0),y.position.x+=t.userData.hTransition;const e=new u().subVectors(r.translation(),y.position).normalize();y.lookAt(t.position.x,t.position.y,t.position.z),r.setRotation({w:y.quaternion.w,x:r.rotation().x,y:y.quaternion.y,z:r.rotation().z}),r.setLinvel({x:e.x*-p[d].hSpeed,y:r.linvel().y,z:r.linvel().z}),Q.set(t.position,_e);const n=Q.intersectObjects(k);if(n.length>0&&(n[0].distance<.4?(t.userData.flying=!1,!t.userData.onGround&&t.userData.flying,t.userData.onGround=!0):(t.userData.onGround=!1,t.userData.flying=!0)),r.linvel().z>0?t.userData.currentSpeed=r.linvel().z.toFixed(0):t.userData.currentSpeed=0,Ae.textContent=t.userData.currentSpeed,t.userData.left&&t.userData.onGround){t.userData.hTransition<5&&(t.userData.hTransition+=p[d].maxHSpeed);let a=r.linvel();a.z*=.9996,r.setLinvel(a,!0)}if(t.userData.right&&t.userData.onGround){t.userData.hTransition>-5&&(t.userData.hTransition-=p[d].maxHSpeed);let a=r.linvel();a.z*=.9996,r.setLinvel(a,!0)}p[d].resetHAngle&&!t.userData.left&&!t.userData.right&&(t.userData.hTransition<-p[d].maxHSpeed?t.userData.hTransition+=p[d].maxHSpeed:t.userData.hTransition>p[d].maxHSpeed?t.userData.hTransition-=p[d].maxHSpeed:t.userData.hTransition=0)}function te(e){if(t.userData.onGround){e=e.changedTouches[0];var n=h.domElement.getBoundingClientRect();S.x=(e.clientX-n.left)/n.width*2-1,S.y=-((e.clientY-n.top)/n.height)*2+1,W.setFromCamera(S,c),S.y>0&&!x?r.linvel().z<p[d].maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&r.applyImpulse({x:0,y:0,z:p[d].stepSpeed},!0):S.x>0?(t.userData.left=!1,t.userData.right=!0):(t.userData.right=!1,t.userData.left=!0)}}function Fe(e){e.preventDefault();var n=h.domElement.getBoundingClientRect();S.x=(e.clientX-n.left)/n.width*2-1,S.y=-((e.clientY-n.top)/n.height)*2+1,W.setFromCamera(S,c),Ee.forEach(a=>{a.geometry.computeBoundingBox();var o=a.geometry.boundingBox.clone();o.applyMatrix4(a.matrixWorld),W.ray.intersectBox(o,new u)})}function We(e){t.userData.right=!1,t.userData.left=!1}function Oe(e){switch(e.code){case"KeyW":case"ArrowUp":r.linvel().z<p[d].maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&!x&&r.applyImpulse({x:0,y:0,z:p[d].stepSpeed},!0),t.userData.playerStart=!0;break;case"KeyS":case"ArrowDown":t.userData.playerBraking=!0;break;case"KeyA":case"ArrowLeft":t.userData.left=!0;break;case"KeyD":case"ArrowRight":t.userData.right=!0;break}}function Ke(e){switch(e.code){case"KeyW":case"ArrowUp":break;case"KeyS":case"ArrowDown":r.linvel().y<.1&&(t.userData.playerBraking=!1);break;case"KeyA":case"ArrowLeft":t.userData.left=!1;break;case"KeyD":case"ArrowRight":t.userData.right=!1;break}}function B(e){let n,a;const o=e.rotation.clone();e.rotation.set(0,0,0);const i=new b().setFromObject(e).getSize(new u);e.rotation.copy(o),e.name.includes("player")?(n=g.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),a=m.ColliderDesc.trimesh(t.userData.vertices,t.userData.indices).setMass(e.userData.mass).setRestitution(0).setFriction(0),r=n,g.createCollider(a,n),D.push([e,n,e.id])):e.name.includes("ground")&&(n=g.createRigidBody(m.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),a=m.ColliderDesc.cuboid(i.x/2,i.y/2,i.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),g.createCollider(a,n),D.push([e,n,e.id])),e.name.includes("wall")&&(n=g.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0).setLinearDamping(0)),a=m.ColliderDesc.cuboid(i.x/2,i.y/2,i.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(40),g.createCollider(a,n),D.push([e,n,e.id]))}
