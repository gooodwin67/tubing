import{C as De,S as it,a as st,F as rt,H as lt,b as ct,D as dt,c as ut,A as pt,P as mt,W as yt,G as Te,V as w,B as G,R as ge,d as _t,e as ht,f as oe}from"./three-Dhj7f3wh.js";import{O as p}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();function Be(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}function Me(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}function He(e){const t=e/1e3,o=Math.floor(t),r=Math.floor((t-o)*1e3),a=Math.floor(o/60),c=o%60;return`${String(a).padStart(2,"0")}:${String(c).padStart(2,"0")}.${String(r).padStart(3,"0")}`}let K=document.querySelector(".main_load"),Ie=document.querySelector(".main_menu"),Oe=document.querySelector(".select_level"),be=document.querySelectorAll(".select_level .level_shadow"),St=document.querySelector(".select_tube"),Dt=document.querySelector(".finish_window"),gt=document.querySelector(".finish_you_time .finish_you_time_time"),Fe=document.querySelector(".boom_window"),ae=document.querySelector(".main_record"),bt=document.querySelectorAll("body>.overlay"),ft=document.querySelector(".startButton"),xt=document.querySelectorAll(".load_level_wrap .btn_lev"),Pe=document.querySelectorAll(".load_level_wrap .level_time"),Je=document.querySelectorAll(".load_tubes_wrap>div"),ie=document.querySelectorAll(".language_block img"),je=[],Ne=[],X=0,We=document.querySelector(".times"),fe=document.querySelector(".current_time"),Ge=document.querySelector(".best_time"),wt=document.querySelector(".finish_window .finish_again"),vt=document.querySelector(".finish_window .finish_in_menu"),qt=document.querySelector(".boom_window .finish_again"),Ct=document.querySelector(".boom_window .finish_in_menu"),Ke=document.querySelector(".speed_block"),Ve=document.querySelector(".speed_block>.speed"),Lt=document.querySelector(".instr_check"),se=document.querySelector(".load_percent");document.querySelector(".records_wrap>div");let xe=document.querySelector(".pause_button_wrap"),zt=document.querySelector(".close_pause_button"),kt=document.querySelector(".reset_button"),At=document.querySelector(".inmenu_button"),Et=document.querySelector(".before_start"),Rt=document.querySelector(".instruction_start_btn"),Tt=document.querySelector(".menu_in_game_wrap"),we=document.querySelector(".start_time"),Ue=document.querySelector(".start_time_wrap"),re=document.querySelector(".audio_button");window.oncontextmenu=function(e){return!1},ie.forEach((e,t)=>{e.addEventListener("click",()=>{X!=t&&(ie.forEach(o=>{o.classList.remove("selected")}),e.classList.add("selected"),X=t,Ye(X))})});function Ye(e){e==0?(document.querySelector(".title_game").src="./images/title.png",document.querySelector(".startgame_title").textContent="\u043D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".language_title").textContent="\u042F\u0437\u044B\u043A:",document.querySelectorAll(".level_text h2>span").forEach(t=>{t.textContent="\u0423\u0440\u043E\u0432\u0435\u043D\u044C"}),document.querySelectorAll(".leveltime_title").forEach(t=>{t.textContent="\u0412\u0440\u0435\u043C\u044F: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(t=>{t.textContent="\u0422\u044E\u0431\u0438\u043D\u0433"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(t=>{t.textContent="\u0421\u043A\u043E\u0440\u043E\u0441\u0442\u044C: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(t=>{t.textContent="\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435: "}),document.querySelectorAll(".load_level_wrap .btn_lev").forEach(t=>{t.textContent="\u041D\u0430\u0447\u0430\u0442\u044C"}),document.querySelectorAll(".load_level_wrap .ad_res").forEach(t=>{t.textContent="\u041F\u0440\u043E\u043F\u0443\u0441\u0442\u0438\u0442\u044C"}),document.querySelector(".selecttubedesc_title").textContent="\u041F\u0440\u043E\u0445\u043E\u0434\u0438\u0442\u0435 \u0443\u0440\u043E\u0432\u043D\u0438, \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0442\u044E\u0431\u0438\u043D\u0433\u0438",document.querySelector(".menu_in_game_wrap_head").textContent="\u041F\u0430\u0443\u0437\u0430",document.querySelector(".close_pause_button").textContent="\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".reset_button").textContent="\u041D\u0430\u0447\u0430\u0442\u044C \u0437\u0430\u043D\u043E\u0432\u043E",document.querySelector(".inmenu_button").textContent="\u0412\u044B\u0439\u0442\u0438",document.querySelector(".finish_you_time_title").textContent="\u0412\u0430\u0448\u0435 \u0432\u0440\u0435\u043C\u044F: ",document.querySelector(".crash_title").textContent="\u0412\u044B \u0432\u0440\u0435\u0437\u0430\u043B\u0438\u0441\u044C",document.querySelector(".finish_title").textContent="\u0412\u044B \u043F\u0440\u0438\u0435\u0445\u0430\u043B\u0438",document.querySelectorAll(".finish_again").forEach(t=>{t.textContent="\u0415\u0449\u0435 \u0440\u0430\u0437"}),document.querySelectorAll(".finish_in_menu").forEach(t=>{t.textContent="\u0412\u044B\u0431\u043E\u0440 \u0443\u0440\u043E\u0432\u043D\u044F"}),document.querySelector(".current_time_title").textContent="\u0412\u0440\u0435\u043C\u044F",document.querySelector(".best_time_title").textContent="\u041B\u0443\u0447\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F",document.querySelector(".speed_title").textContent="\u041A\u041C/\u0427",document.querySelector(".instruction_start_btn").textContent="\u0421\u0422\u0410\u0420\u0422",document.querySelector(".instr-disabled span").textContent="\u0411\u043E\u043B\u044C\u0448\u0435 \u043D\u0435 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0442\u044C",document.querySelector(".desktop_instr").innerHTML=`<h2>\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435</h2>
    <span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 <span class='button_active'>W</span> \u0438\u043B\u0438 <span class='button_active'>\u2191</span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041A\u043B\u0430\u0432\u0438\u0448\u0430\u043C\u0438 <span>\u2190</span> <span>\u2192</span> \u0438\u043B\u0438 <span>A</span> <span>D</span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>`,document.querySelector(".mobile_instr div").innerHTML=`<span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 \u043D\u0430 \u0437\u043E\u043D\u0443 <span> \u2191 </span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041D\u0430\u0436\u0438\u043C\u0430\u044F \u043D\u0430 \u0437\u043E\u043D\u044B <span> \u2190 </span> \u0438 <span> \u2192 </span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>`,document.querySelector(".sci-fi-loader strong").textContent="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430",document.querySelector(".main_record_title").textContent="\u041C\u043E\u0435 \u043E\u0431\u0449\u0435\u0435 \u0432\u0440\u0435\u043C\u044F: ",O==0&&(document.querySelector(".main_record").textContent="\u041F\u0440\u043E\u0439\u0434\u0438\u0442\u0435 \u0432\u0441\u0435 \u0443\u0440\u043E\u0432\u043D\u0438, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0440\u0435\u043A\u043E\u0440\u0434"),document.querySelector(".records_wrap>p").textContent="\u041C\u0438\u0440\u043E\u0432\u043E\u0439 \u0440\u0435\u0439\u0442\u0438\u043D\u0433: ",document.querySelector(".need_auth_text").textContent="\u0427\u0442\u043E\u0431\u044B \u0443\u0447\u0430\u0441\u0442\u0432\u043E\u0432\u0430\u0442\u044C \u0432 \u0440\u0435\u0439\u0442\u0438\u043D\u0433\u0435  ",document.querySelector(".auth_link").textContent="\u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0432 \u0430\u043A\u043A\u0430\u0443\u043D\u0442"):(document.querySelector(".title_game").src="./images/title-en.png",document.querySelector(".startgame_title").textContent="start game",document.querySelector(".language_title").textContent="Language:",document.querySelectorAll(".level_text h2>span").forEach(t=>{t.textContent="Level"}),document.querySelectorAll(".leveltime_title").forEach(t=>{t.textContent="Time: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(t=>{t.textContent="Tubing"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(t=>{t.textContent="Speed: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(t=>{t.textContent="Control: "}),document.querySelector(".selecttubedesc_title").textContent="Complete the levels to unlock the tubings",document.querySelector(".menu_in_game_wrap_head").textContent="Pause",document.querySelector(".close_pause_button").textContent="Continue",document.querySelector(".reset_button").textContent="Start again",document.querySelector(".inmenu_button").textContent="Exit to levels",document.querySelector(".finish_you_time_title").textContent="You time: ",document.querySelector(".crash_title").textContent="You crashed",document.querySelector(".finish_title").textContent="You finished",document.querySelectorAll(".finish_again").forEach(t=>{t.textContent="Again"}),document.querySelectorAll(".finish_in_menu").forEach(t=>{t.textContent="Select Level"}),document.querySelector(".current_time_title").textContent="Time",document.querySelector(".best_time_title").textContent="Best time",document.querySelector(".speed_title").textContent="KM/H",document.querySelector(".instruction_start_btn").textContent="START",document.querySelector(".instr-disabled span").textContent="Don't show again",document.querySelector(".desktop_instr").innerHTML=`<h2>Instructions</h2>
    <span>Quickly press <span class='button_active'>W</span> or <span class='button_active'>\u2191</span> to accelerate to the starting point</span>
    <span>Use <span>\u2190</span> <span>\u2192</span> or <span>A</span> <span>D</span> keys to control the tubing</span>`,document.querySelector(".mobile_instr div").innerHTML=`<span>Quickly press on zone <span> \u2191 </span> to accelerate to the starting point</span>
    <span>By taps on zones <span> \u2190 </span> and <span> \u2192 </span> control the tubing</span>`,document.querySelector(".sci-fi-loader strong").textContent="Loading ",document.querySelector(".main_record_title").textContent="My total time: ",O==0&&(document.querySelector(".main_record").textContent="Complete all the levels to set a record"),document.querySelector(".records_wrap>p").textContent="World Ranking: ",document.querySelector(".need_auth_text").textContent="To participate in the rating ",document.querySelector(".auth_link").textContent="login to account",document.querySelectorAll(".load_level_wrap .btn_lev").forEach(t=>{t.textContent="Start"}),document.querySelectorAll(".load_level_wrap .ad_res").forEach(t=>{t.textContent="Skip"}))}document.querySelectorAll(".load_level_wrap .ad_res").forEach((e,t)=>{e.addEventListener("click",async()=>{})}),xt.forEach((e,t)=>{e.addEventListener("click",async()=>{t+1<=Re+1&&(j=t+1,Je.forEach((o,r)=>{y[r].levels.includes(j)?(o.classList.remove("disabledTube"),y[r].canInLevel=!0):(o.classList.add("disabledTube"),y[r].canInLevel=!1)}),D(K),await ne(!1,!0),D(St))})}),Je.forEach((e,t)=>{e.addEventListener("click",()=>{y[t].canInLevel&&(_=t,D(0),Z())})});function Z(){if(!h.canStart)D(Et),E?document.querySelector(".mobile_instr").classList.remove("hidden_instr"):document.querySelector(".desktop_instr").classList.remove("hidden_instr");else{We.classList.remove("hidden_block"),Ke.classList.remove("hidden_block"),ce[_].position.copy(s.translation());let e=0;Ce=!0,E&&document.querySelector(".instr-mobile-ingame").classList.remove("hidden_block"),E&&document.querySelector(".anim_tap_top").classList.remove("hidden_block");let t=setInterval(o=>{g!=null&&!g.isPlaying&&L&&!ee&&e==0&&g.play(),Ue.classList.remove("hidden_block"),ee||e++,e==2&&E&&document.querySelector(".instr-mobile-ingame").classList.add("hidden_block"),e==4?(Ce=!1,X==0?we.textContent="\u0421\u0422\u0410\u0420\u0422":we.textContent="GO",B=!0,xe.classList.remove("hidden_block"),clearInterval(t),setTimeout(()=>{Ue.classList.add("hidden_block"),g==null||g.stop()},1500)):we.textContent=4-e},1e3)}}Rt.addEventListener("click",()=>{h.canStart=!0,D(0),Z()}),re.addEventListener("click",()=>{L==!0?(re.classList.add("audio_off"),u!=null&&u.isPlaying&&u.stop(),l!=null&&l.isPlaying&&l.stop(),g!=null&&g.isPlaying&&g.stop(),L=!1):(re.classList.remove("audio_off"),u!=null&&!u.isPlaying&&u.play(),s.linvel().z>3&&n.userData.onGround&&!I&&(l==null||l.play()),L=!0)}),ft.addEventListener("click",()=>{E=Be(),Ee=Me(),Ee&&re.classList.add("hidden_block"),X==0?de=Qe:de=$e,document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),u!=null&&L&&u.play(),Ie.classList.add("hidden_block"),Oe.classList.remove("hidden_block")});function D(e){bt.forEach(t=>{t.classList.add("hidden_block")}),e!=0&&e.classList.remove("hidden_block")}wt.addEventListener("click",async()=>{D(K),await $(),await ne(!0,!0),D(0),Z()}),qt.addEventListener("click",async()=>{D(K),await $(),await ne(!0,!0),D(0),Z()}),kt.addEventListener("click",async()=>{await $(),await ne(!0,!0),D(0),Z()}),vt.addEventListener("click",async()=>{D(K),await $(),await Se()}),Ct.addEventListener("click",async()=>{D(K),await $(),await Se()}),At.addEventListener("click",async()=>{D(K),await $(),await Se()}),xe.addEventListener("click",()=>{Ce==!1&&B&&!k&&(D(Tt),n.userData.time=z.getElapsedTime(),z.stop(),document.querySelector(".audio_button_wrap").classList.add("hidden_block"),l==null||l.stop(),u==null||u.stop(),I=!0)}),zt.addEventListener("click",()=>{D(0),z.start(),z.elapsedTime=n.userData.time,document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),L&&(u==null||u.play()),s.linvel().z>3&&n.userData.onGround&&L&&(l==null||l.play()),I=!1}),Lt.onchange=function(){this.checked?(h.canStart=!0,localStorage.setItem("playerData",JSON.stringify(h))):(h.canStart=!1,localStorage.setItem("playerData",JSON.stringify(h)))};let m,ve=!0;performance.now();let j=0,I=!1,L=!0,O=0,le=0,n,s,qe,Ce=!1,ce=[],_=0,F,de,Qe,$e,ee=!1,Xe=!1,Le,k;const y=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,nowSpeed:0,maxSpeed:26,resetHAngle:!1,levels:[1,2,3,4,5,6,7,8,9],canInLevel:!1},{hSpeed:12,maxHSpeed:.1,stepSpeed:2,nowSpeed:0,maxSpeed:38,resetHAngle:!1,levels:[4,5,6,7,8,9],canInLevel:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:2,nowSpeed:0,maxSpeed:44,resetHAngle:!0,levels:[7,8,9],canInLevel:!1}];let l,u,A,g,Ze,v=[],V=new w,Bt=new ge,B=!1,ze=!1,U,et,tt,S,M,H,q,C,ue,pe,me,Y,Q,ke,N=[],ye=[],Ae=[],b,E=Be(),Ee=Me(),Mt=new De,z=new De,_e=0,nt=1/60,W=0,R=0,Re=2,h;const ot=new ge,Ht=new w(0,-1,0),d=new it;d.background=new st(14479094),d.fog=new rt(d.background,1,300);const te=new lt(16777215,16777215,2);te.color.setHSL(.6,1,.6),te.groundColor.setHSL(.095,1,.75),te.position.set(0,100,0),new ct(te,10);const he=new dt(16777215,3);he.position.set(1,2,.2),he.position.multiplyScalar(120),new ut(he,10),new pt(11184810,1);const f=new mt(85,document.body.offsetWidth/document.body.offsetHeight,.1,310);f.position.set(0,4,-10);const P=new yt({antialias:!1});P.setSize(document.body.offsetWidth,document.body.offsetHeight),document.body.appendChild(P.domElement),P.shadowMap.enabled=!1,window.addEventListener("resize",It,!1);function It(){E?(f.aspect=document.body.offsetWidth/document.body.offsetHeight,f.updateProjectionMatrix(),P.setSize(innerWidth,innerHeight)):(f.aspect=document.body.offsetWidth/document.body.offsetHeight,f.updateProjectionMatrix(),P.setSize(document.body.offsetWidth,document.body.offsetHeight))}async function Ot(){localStorage.getItem("playerData")?(h=JSON.parse(localStorage.getItem("playerData")),ie.forEach(e=>{e.classList.remove("selected")}),le=Object.keys(h.levelsTimes).length,le==be.length&&(O=0,Object.values(h.levelsTimes).forEach(e=>{O+=parseFloat(e)}),ae.textContent=He(Math.round(O*1e3)),ae.classList.add("main_record_green"))):(h={levelsTimes:{},canStart:!1},localStorage.setItem("playerData",JSON.stringify(h))),JSON.stringify(h),Re=0,be.forEach((e,t)=>{t<Object.keys(h.levelsTimes).length+1&&(Re++,e.classList.remove("level_disabled"))}),Pe.forEach((e,t,o)=>{h.levelsTimes["time"+(t+1)]!=null?(e.childNodes[2].textContent=h.levelsTimes["time"+(t+1)],document.querySelectorAll(".load_level_wrap .ad_res").forEach((r,a)=>{(t==a||a==Pe.length-1)&&r.classList.add("not_vis")})):e.childNodes[2].textContent="00.000"})}async function Ft(){z=new De,d.add(he),d.add(te),R=0,await p.init(),m=new p.World(new p.Vector3(0,-9.81,0)),await new Te().loadAsync("models/map-menu.glb",onprogress=c=>{let x=Math.min(Math.round(c.loaded/c.total*100),100);se.textContent=x+"%"}).then(c=>{const x=c.scene;se.textContent="0",x.traverse(i=>{if(i.name=="player")n=i.clone(),n.userData.vertices=n.geometry.attributes.position.array,n.userData.indices=n.geometry.index.array,n.material.transparent=!0,n.material.opacity=0,n.userData.mass=1,n.userData.playerBraking=!1,n.userData.hTransition=0,n.userData.currentSpeed=0,n.userData.boom=!1,n.userData.onStartArea=!0,n.userData.canBoostStep=!0,n.userData.time=0,n.userData.right=!1,n.userData.left=!1,n.userData.onGround=!1,n.userData.flying=!1,n.userData.origPosition=n.position,T(n),d.add(n);else if(i.name.includes("player-tube"))F=i.clone(),F.userData.startPosition=new w(F.position.x,F.position.y,F.position.z),ce[i.name.slice(-1)-1]=F,d.add(F);else if(i.name=="arrow_area")b=i.clone(),b.userData.hPos=0,d.add(b);else if(i.name.includes("ground"))new G().setFromObject(i).getSize(new w),U=i.clone(),U.userData.mass=0,T(U),N.push(U),d.add(U),i.name=="left_ground_wall"?et=i.position:i.name=="right_ground_wall"&&(tt=i.position);else if(i.name.includes("wall")){new G().setFromObject(i).getSize(new w);let J=i.clone();J.userData.mass=1,T(J),N.push(J),ye.push(J),d.add(J)}else if(i.name.includes("area")){let J=i.clone();d.add(J)}else i.name.includes("start_flag_en")?$e=i.clone():i.name.includes("start_flag_ru")?Qe=i.clone():i.name.includes("itsmen_body")?(S=i.clone(),S.material.transparent=!0,S.material.opacity=0,d.add(S),T(S)):i.name.includes("itsmen_left_hand")?(M=i.clone(),M.material.transparent=!0,M.material.opacity=0,d.add(M),T(M)):i.name.includes("itsmen_right_hand")?(H=i.clone(),H.material.transparent=!0,H.material.opacity=0,d.add(H),T(H)):i.name.includes("itsmen_left_leg")?(q=i.clone(),q.material.transparent=!0,q.material.opacity=0,d.add(q),T(q)):i.name.includes("itsmen_right_leg")?(C=i.clone(),C.material.transparent=!0,C.material.opacity=0,d.add(C),T(C)):i.name.includes("qmen_body")?(ue=i.clone(),d.add(ue)):i.name.includes("qmen_left_hand")?(pe=i.clone(),d.add(pe)):i.name.includes("qmen_right_hand")?(me=i.clone(),d.add(me)):i.name.includes("qmen_left_leg")?(Y=i.clone(),d.add(Y)):i.name.includes("qmen_right_leg")&&(Q=i.clone(),d.add(Q))})}),d.traverse(function(c){c.material&&(c.material.needsUpdate=!0)}),await Ot();let e=p.JointData.spherical({x:.2,y:0,z:-.2},{x:-.4,y:0,z:0});m.createImpulseJoint(e,S.userData.body,M.userData.body,!0);let t=p.JointData.spherical({x:-.2,y:0,z:-.2},{x:.4,y:0,z:0});m.createImpulseJoint(t,S.userData.body,H.userData.body,!0);let o=p.JointData.spherical({x:.22,y:0,z:.5},{x:0,y:0,z:-.5});m.createImpulseJoint(o,S.userData.body,q.userData.body,!0);let r=p.JointData.spherical({x:-.22,y:0,z:.5},{x:0,y:0,z:-.5});m.createImpulseJoint(r,S.userData.body,C.userData.body,!0);let a=p.JointData.spherical({x:0,y:0,z:0},{x:0,y:.3,z:0});ke=m.createImpulseJoint(a,S.userData.body,s,!0),ze=!0}async function Pt(){d.add(de),k=!1;const e=new Te,t="models/map"+j+".glb";await e.loadAsync(t,onprogress=o=>{let r=Math.min(Math.round(o.loaded/o.total*100),100);se.textContent=r+"%"}).then(o=>{const r=o.scene;se.textContent="0",r.traverse(a=>{if(a.name.includes("ground")){new G().setFromObject(a).getSize(new w);let c=a.clone();c.userData.mass=0,c.name=a.name,T(c),N.push(c),d.add(c)}else if(a.name.includes("wall")){new G().setFromObject(a).getSize(new w);let c=a.clone();c.userData.mass=1,T(c),N.push(c),ye.push(c),d.add(c)}else if(a.name.includes("moving_block")){const c=new G().setFromObject(a).getSize(new w);let x=a.clone();x.userData.size=c,x.userData.mass=1,x.userData.raycaster=new ge,x.userData.speed=-a.name.substr(a.name.indexOf("speed")+6),x.userData.direction=new w(x.userData.speed,0,0),je.push(x),T(x),ye.push(x),d.add(x)}else if(a.name.includes("area")){let c=a.clone();d.add(c)}else a.name.includes("finish_block")&&(Le=a.clone(),d.add(Le))})}),Ge.textContent=h.levelsTimes["time"+j]}async function Jt(){const e=new _t,t=new ht;await t.loadAsync("audio/slide.mp3").then(o=>{l=new oe(e),l.setBuffer(o),l.setLoop(!0),l.setRefDistance(400),l.setVolume(.7),n.add(l)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await t.loadAsync("audio/around.mp3").then(o=>{u=new oe(e),u.setBuffer(o),u.setLoop(!0),u.setRefDistance(400),u.setVolume(1),u.error=!1,n.add(u)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await t.loadAsync("audio/boom1.mp3").then(o=>{A=new oe(e),A.setBuffer(o),A.setLoop(!1),A.setRefDistance(400),A.setVolume(.3),A.error=!1,n.add(A)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await t.loadAsync("audio/bip.mp3").then(o=>{g=new oe(e),g.setBuffer(o),g.setLoop(!1),g.setRefDistance(400),g.setVolume(.3),g.error=!1,n.add(g)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)})}document.querySelector(".auth_link").addEventListener("click",()=>{});async function Se(){await ne(!0,!1),ve?(ie[0].classList.add("selected"),Ye(0),D(Ie),ve=!1):D(Oe)}Se();async function ne(e,t){e&&await Ft(),t&&await Pt(),ve&&!Ee&&Jt()}async function $(){for(B=!1,ze=!1,R=0,n.userData.time=0,n.userData.boom=!1,y.forEach(e=>{e.nowSpeed=0}),N=[],ye=[],v=[],xe.classList.add("hidden_block"),We.classList.add("hidden_block"),Ke.classList.add("hidden_block"),document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),z.start(),z.elapsedTime=n.userData.time,I=!1,n.userData.currentSpeed=0,Ve.textContent=n.userData.currentSpeed,R=0,fe.textContent=R;d.children.length>0;){let e=d.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()),d.remove(e)}k=!1,u!=null&&L&&!ee&&!Xe&&u.play()}function jt(){if(ze&&!k&&(l!=null&&L&&(s.linvel().z>3&&n.userData.onGround?l.isPlaying||l.play():l.isPlaying&&l.stop()),E?n.userData.boom?(f.lookAt(S.position),l==null||l.stop()):(f.lookAt(new w(f.position.x,n.position.y,n.position.z+5)),f.position.y=n.position.y+5,f.position.z=n.position.z-3):n.userData.boom?(F.position.y>0&&f.lookAt(S.position),l==null||l.stop()):(f.lookAt(new w(f.position.x,n.position.y,n.position.z+5)),f.position.y=n.position.y+4,f.position.z=n.position.z-4),b.position.set(n.position.x,n.position.y,n.position.z+5)),B){k?(D(Dt),l==null||l.stop()):(R=z.getElapsedTime().toFixed(3),fe.textContent=R,Wt(),Nt()),n.position.x>et.x-n.userData.size.x/1.3&&(b.position.x=n.position.x,n.userData.hTransition=-.4),n.position.x<tt.x+n.userData.size.x/1.3&&(b.position.x=n.position.x,n.userData.hTransition=.4);let e=new p.EventQueue(!0);m.step(e),ce[_].position.copy(s.translation()),ce[_].quaternion.copy(s.rotation()),ue.position.copy(S.position),ue.rotation.copy(S.rotation),pe.position.copy(M.position),pe.rotation.copy(M.rotation),me.position.copy(H.position),me.rotation.copy(H.rotation),Y.position.copy(q.position),Y.rotation.copy(q.rotation),Q.position.copy(C.position),Q.rotation.copy(C.rotation);for(let t=0,o=v.length;t<o;t++)v[t][0].position.copy(v[t][1].translation()),v[t][0].quaternion.copy(v[t][1].rotation());e.drainCollisionEvents((t,o,r)=>{Ae.forEach((a,c)=>{s.handle==t&&a.handle==o&&!k?s.linvel().z<15&&n.userData.boom==!1&&(A!=null&&L&&A.play(),m.removeImpulseJoint(ke),S.userData.body.applyImpulse({x:5,y:5,z:5},!0),S.userData.body.setEnabledRotations(!0),qe.setFriction(20),setTimeout(()=>{B=!1,D(Fe)},3e3),n.userData.boom=!0):s.handle==t&&!k&&s.linvel().z<15&&n.position.y<5&&n.userData.boom==!1&&(A!=null&&L&&A.play(),m.removeImpulseJoint(ke),S.userData.body.applyImpulse({x:5,y:5,z:5},!0),S.userData.body.setEnabledRotations(!0),qe.setFriction(20),n.userData.boom=!0,setTimeout(()=>{B=!1,D(Fe)},3e3))})})}}P.setAnimationLoop(()=>{_e+=Mt.getDelta(),_e>nt&&!I&&(jt(),P.render(d,f),_e=_e%nt)}),document.addEventListener("touchend",Gt),document.addEventListener("touchstart",at),document.addEventListener("touchmove",at),window.addEventListener("keydown",Kt),window.addEventListener("keyup",Vt);function Nt(){je.forEach((e,t)=>{let o=e,r=Ne[t];r.setLinvel(o.userData.direction,!0),r.setAngvel({x:o.userData.direction.z,y:o.userData.direction.y,z:-o.userData.direction.x},!0);const a=o.userData.direction;o.userData.raycaster.set(new w(o.position.x,.4,o.position.z),a.clone().normalize());const c=o.userData.raycaster.intersectObjects(N);c.length>0&&c[0].distance<o.userData.size.x/2&&(o.userData.direction.x=o.userData.direction.x*-1)})}function Wt(){n.position.z>Le.position.z&&!n.userData.boom&&(R=z.getElapsedTime().toFixed(3),fe.textContent=R,k=!0,gt.textContent=R,h.levelsTimes["time"+j]!=null?W=h.levelsTimes["time"+j]:W=0,(R<W||W==0)&&(W=R,Ge.textContent=W,h.levelsTimes["time"+j]=W,le=Object.keys(h.levelsTimes).length,le==be.length&&(O=0,Object.values(h.levelsTimes).forEach(a=>{O+=parseFloat(a)}),ae.textContent=He(Math.round(O*1e3)),ae.classList.add("main_record_green")),localStorage.setItem("playerData",JSON.stringify(h))),n.position.z=0),b.position.x+=n.userData.hTransition;const e=new w().subVectors(s.translation(),b.position).normalize(),t=s.linvel(),o=new w(e.x*-y[_].hSpeed,t.y,e.z*-y[_].nowSpeed);s.translation().y<100&&s.translation().y>=20&&(y[_].nowSpeed+=.05,s.rotation().x<.04&&s.setRotation({w:s.rotation().w,x:.04,y:s.rotation().y,z:s.rotation().z})),s.translation().y<20&&s.translation().y>1&&s.lockRotations(!0,!0,!0,!0),s.setLinvel(o,!0),b.lookAt(b.position.x-(n.position.x-b.position.x),b.position.y-(n.position.y-b.position.y),b.position.z-(n.position.z-b.position.z)),s.setRotation({w:b.quaternion.w,x:s.rotation().x,y:b.quaternion.y,z:s.rotation().z}),S.userData.body.setRotation({w:b.quaternion.w,x:s.rotation().x,y:b.quaternion.y,z:s.rotation().z}),(Y.rotation.y>0||Y.rotation.y<0)&&q.userData.body.setRotation({w:q.userData.body.rotation().w,x:q.userData.body.rotation().x,y:0,z:q.userData.body.rotation().z}),(Q.rotation.y>0||Q.rotation.y<0)&&C.userData.body.setRotation({w:C.userData.body.rotation().w,x:C.userData.body.rotation().x,y:0,z:C.userData.body.rotation().z}),ot.set(n.position,Ht);const r=ot.intersectObjects(N);r.length>0&&(r[0].distance<.4?(n.userData.flying=!1,n.userData.onGround=!0):(n.userData.onGround=!1,n.userData.flying=!0)),s.linvel().z>0?n.userData.currentSpeed=s.linvel().z.toFixed(0):n.userData.currentSpeed=0,Ve.textContent=n.userData.currentSpeed,n.userData.left&&n.userData.onGround&&!n.userData.onStartArea&&(n.userData.hTransition<5&&(n.userData.hTransition+=y[_].maxHSpeed),y[_].nowSpeed-=.009),n.userData.right&&n.userData.onGround&&!n.userData.onStartArea&&(n.userData.hTransition>-5&&(n.userData.hTransition-=y[_].maxHSpeed),y[_].nowSpeed-=.009),y[_].resetHAngle&&!n.userData.left&&!n.userData.right&&(n.userData.hTransition<-y[_].maxHSpeed?n.userData.hTransition+=y[_].maxHSpeed:n.userData.hTransition>y[_].maxHSpeed?n.userData.hTransition-=y[_].maxHSpeed:n.userData.hTransition=0),n.position.z>de.position.z?(n.userData.onStartArea==!0&&E&&document.querySelector(".anim_tap_top").classList.add("hidden_block"),n.userData.onStartArea==!0&&E&&document.querySelector(".anim_tap_left").classList.remove("hidden_block"),n.userData.onStartArea==!0&&E&&document.querySelector(".anim_tap_right").classList.remove("hidden_block"),n.userData.onStartArea==!0&&E&&setTimeout(()=>{document.querySelector(".anim_tap_left").classList.add("hidden_block"),document.querySelector(".anim_tap_right").classList.add("hidden_block")},2e3),n.userData.onStartArea=!1):n.userData.onStartArea=!0}function at(e){if(n.userData.onGround){e=e.changedTouches[0];var t=P.domElement.getBoundingClientRect();V.x=(e.clientX-t.left)/t.width*2-1,V.y=-((e.clientY-t.top)/t.height)*2+1,Bt.setFromCamera(V,f),V.y>0&&n.userData.canBoostStep&&B&&n.userData.onStartArea&&s.linvel().z<y[_].maxSpeed&&s.linvel().y<5&&s.linvel().y>-5&&!k&&y[_].nowSpeed<y[_].maxSpeed&&(y[_].nowSpeed+=y[_].stepSpeed),n.userData.canBoostStep=!1,V.y<.5&&(V.x>0?(n.userData.left=!1,n.userData.right=!0):(n.userData.right=!1,n.userData.left=!0))}}function Gt(e){n.userData.right=!1,n.userData.left=!1,n.userData.canBoostStep=!0}function Kt(e){switch(e.code){case"KeyW":case"ArrowUp":n.userData.canBoostStep&&B&&n.userData.onStartArea&&s.linvel().z<y[_].maxSpeed&&s.linvel().y<5&&s.linvel().y>-5&&!k&&y[_].nowSpeed<y[_].maxSpeed&&(y[_].nowSpeed+=y[_].stepSpeed),n.userData.canBoostStep=!1;break;case"KeyS":case"ArrowDown":break;case"KeyA":case"ArrowLeft":n.userData.left=!0;break;case"KeyD":case"ArrowRight":n.userData.right=!0;break}}function Vt(e){switch(e.code){case"KeyW":case"ArrowUp":n.userData.canBoostStep=!0;break;case"KeyS":case"ArrowDown":break;case"KeyA":case"ArrowLeft":n.userData.left=!1;break;case"KeyD":case"ArrowRight":n.userData.right=!1;break}}function T(e){let t,o;const r=e.rotation.clone();e.rotation.set(0,0,0);const a=new G().setFromObject(e).getSize(new w);if(e.rotation.copy(r),e.name.includes("player")?(n.userData.size=a,n.userData.orgRotation=r,t=m.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),o=p.ColliderDesc.cuboid(a.x/5,a.y/1.5,a.z/3).setMass(e.userData.mass).setRestitution(0).setFriction(0),s=t,qe=o,o.setActiveEvents(p.ActiveEvents.COLLISION_EVENTS),m.createCollider(o,t),n.userData.handle=s.handle,v.push([e,t,e.id])):e.name.includes("ground")&&(t=m.createRigidBody(p.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),o=p.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),m.createCollider(o,t),Ze=t,U.userData.handle=Ze.handle,v.push([e,t,e.id])),e.name.includes("wall")){t=m.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0)),o=p.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(40);let c=m.createCollider(o,t);Ae.push(c),v.push([e,t,e.id])}if(e.name.includes("moving_block")){t=m.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!0,!0).setLinearDamping(0)),o=p.ColliderDesc.ball(a.x/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(20);let c=t;Ne.push(c);let x=m.createCollider(o,t);Ae.push(x),v.push([e,t,e.id])}e.name.includes("itsmen_body")&&(t=m.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!0).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(0).setRestitution(0).setFriction(0).setDensity(2),S.userData.body=t,S.userData.collider=o,m.createCollider(o,t),v.push([e,t,e.id])),e.name.includes("itsmen_left_hand")&&(t=m.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),M.userData.body=t,M.userData.collider=o,m.createCollider(o,t),v.push([e,t,e.id])),e.name.includes("itsmen_right_hand")&&(t=m.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),H.userData.body=t,H.userData.collider=o,m.createCollider(o,t),v.push([e,t,e.id])),e.name.includes("itsmen_left_leg")&&(t=m.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),q.userData.body=t,q.userData.collider=o,m.createCollider(o,t),v.push([e,t,e.id])),e.name.includes("itsmen_right_leg")&&(t=m.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),C.userData.body=t,C.userData.collider=o,m.createCollider(o,t),v.push([e,t,e.id]))}document.addEventListener("visibilitychange",function(){document.visibilityState==="visible"?(ee=!1,L&&I==!1&&!Xe&&(u==null||u.play()),s.linvel().z>3&&n.userData.onGround&&L&&I==!1&&(l==null||l.play()),!k&&B&&I==!1&&(z.start(),z.elapsedTime=n.userData.time)):(ee=!0,g!=null&&g.isPlaying&&g.stop(),u==null||u.stop(),l==null||l.stop(),I==!1&&!k&&B&&(n.userData.time=z.getElapsedTime(),z.stop()))});
