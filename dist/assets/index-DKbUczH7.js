import{C as ge,S as et,a as tt,F as nt,H as ot,b as at,D as st,c as rt,A as it,P as lt,W as ct,G as Re,V as x,B as K,R as De,d as dt,e as ut,f as oe}from"./three-Dhj7f3wh.js";import{O as m}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();function Me(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}function F(e){const n=e/1e3,o=Math.floor(n),i=Math.floor((n-o)*1e3),a=Math.floor(o/60),s=o%60;return`${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}.${String(i).padStart(3,"0")}`}let V=document.querySelector(".main_load"),Ie=document.querySelector(".main_menu"),He=document.querySelector(".select_level"),be=document.querySelectorAll(".select_level .level_shadow"),pt=document.querySelector(".select_tube"),mt=document.querySelector(".finish_window"),yt=document.querySelector(".finish_you_time .finish_you_time_time"),Be=document.querySelector(".boom_window"),ae=document.querySelector(".main_record"),ht=document.querySelectorAll("body>.overlay"),_t=document.querySelector(".startButton"),St=document.querySelectorAll(".load_level_wrap>div"),gt=document.querySelectorAll(".load_level_wrap .level_time"),Pe=document.querySelectorAll(".load_tubes_wrap>div"),se=document.querySelectorAll(".language_block>img"),Oe=[],Fe=[],Ge=document.querySelector(".times"),fe=document.querySelector(".current_time"),Je=document.querySelector(".best_time"),Dt=document.querySelector(".finish_window .finish_again"),bt=document.querySelector(".finish_window .finish_in_menu"),ft=document.querySelector(".boom_window .finish_again"),wt=document.querySelector(".boom_window .finish_in_menu"),Ne=document.querySelector(".speed_block"),je=document.querySelector(".speed_block>.speed"),xt=document.querySelector(".instr_check"),re=document.querySelector(".load_percent");document.querySelector(".records_wrap>div");let we=document.querySelector(".pause_button_wrap"),qt=document.querySelector(".close_pause_button"),vt=document.querySelector(".reset_button"),Lt=document.querySelector(".inmenu_button"),Ct=document.querySelector(".before_start"),kt=document.querySelector(".instruction_start_btn"),At=document.querySelector(".menu_in_game_wrap"),We=document.querySelector(".start_time"),Ke=document.querySelector(".start_time_wrap"),xe=document.querySelector(".audio_button");se.forEach((e,n)=>{e.addEventListener("click",()=>{p.language!=n&&(se.forEach(o=>{o.classList.remove("selected")}),e.classList.add("selected"),p.language=n,localStorage.setItem("playerData",JSON.stringify(p)),Ve(p.language))})});function Ve(e){e==0?(document.querySelector(".title_game").src="./images/title.png",document.querySelector(".startgame_title").textContent="\u043D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".language_title").textContent="\u042F\u0437\u044B\u043A:",document.querySelectorAll(".level_text h2>span").forEach(n=>{n.textContent="\u0423\u0440\u043E\u0432\u0435\u043D\u044C"}),document.querySelectorAll(".leveltime_title").forEach(n=>{n.textContent="\u0412\u0440\u0435\u043C\u044F: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(n=>{n.textContent="\u0422\u044E\u0431\u0438\u043D\u0433"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(n=>{n.textContent="\u0421\u043A\u043E\u0440\u043E\u0441\u0442\u044C: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(n=>{n.textContent="\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435: "}),document.querySelector(".selecttubedesc_title").textContent="\u041F\u0440\u043E\u0445\u043E\u0434\u0438\u0442\u0435 \u0443\u0440\u043E\u0432\u043D\u0438, \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0442\u044E\u0431\u0438\u043D\u0433\u0438",document.querySelector(".menu_in_game_wrap_head").textContent="\u041F\u0430\u0443\u0437\u0430",document.querySelector(".close_pause_button").textContent="\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".reset_button").textContent="\u041D\u0430\u0447\u0430\u0442\u044C \u0437\u0430\u043D\u043E\u0432\u043E",document.querySelector(".inmenu_button").textContent="\u0412\u044B\u0439\u0442\u0438",document.querySelector(".finish_you_time_title").textContent="\u0412\u0430\u0448\u0435 \u0432\u0440\u0435\u043C\u044F: ",document.querySelector(".crash_title").textContent="\u0412\u044B \u0432\u0440\u0435\u0437\u0430\u043B\u0438\u0441\u044C",document.querySelector(".finish_title").textContent="\u0412\u044B \u043F\u0440\u0438\u0435\u0445\u0430\u043B\u0438",document.querySelectorAll(".finish_again").forEach(n=>{n.textContent="\u0415\u0449\u0435 \u0440\u0430\u0437"}),document.querySelectorAll(".finish_in_menu").forEach(n=>{n.textContent="\u0412\u044B\u0431\u043E\u0440 \u0443\u0440\u043E\u0432\u043D\u044F"}),document.querySelector(".current_time_title").textContent="\u0412\u0440\u0435\u043C\u044F",document.querySelector(".best_time_title").textContent="\u041B\u0443\u0447\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F",document.querySelector(".speed_title").textContent="\u041A\u041C/\u0427",document.querySelector(".instruction_start_btn").textContent="\u0421\u0422\u0410\u0420\u0422",document.querySelector(".instr-disabled span").textContent="\u0411\u043E\u043B\u044C\u0448\u0435 \u043D\u0435 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0442\u044C",document.querySelector(".desktop_instr").innerHTML=`<h2>\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435</h2>
    <span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 <span class='button_active'>W</span> \u0438\u043B\u0438 <span class='button_active'>\u2191</span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041A\u043B\u0430\u0432\u0438\u0448\u0430\u043C\u0438 <span>\u2190</span> <span>\u2192</span> \u0438\u043B\u0438 <span>A</span> <span>D</span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>
    <span>\u0426\u0435\u043B\u044C - \u0434\u043E\u0435\u0445\u0430\u0442\u044C \u0434\u043E \u0444\u0438\u043D\u0438\u0448\u0430 \u0437\u0430 \u043A\u0440\u0430\u0442\u0447\u0430\u0439\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F</span>`,document.querySelector(".mobile_instr div").innerHTML=`<span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 \u043D\u0430 \u0437\u043E\u043D\u0443 <span> \u2191 </span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041D\u0430\u0436\u0438\u043C\u0430\u044F \u043D\u0430 \u0437\u043E\u043D\u044B <span> \u2190 </span> \u0438 <span> \u2192 </span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>`,document.querySelector(".sci-fi-loader strong").textContent="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430",document.querySelector(".main_record_title").textContent="\u041C\u043E\u0435 \u043E\u0431\u0449\u0435\u0435 \u0432\u0440\u0435\u043C\u044F: ",(E=0)&&(document.querySelector(".main_record").textContent="\u041F\u0440\u043E\u0439\u0434\u0438\u0442\u0435 \u0432\u0441\u0435 \u0443\u0440\u043E\u0432\u043D\u0438, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0440\u0435\u043A\u043E\u0440\u0434"),document.querySelector(".records_wrap>p").textContent="\u041C\u0438\u0440\u043E\u0432\u043E\u0439 \u0440\u0435\u0439\u0442\u0438\u043D\u0433: ",document.querySelector(".need_auth_text").textContent="\u0427\u0442\u043E\u0431\u044B \u0443\u0447\u0430\u0441\u0442\u0432\u043E\u0432\u0430\u0442\u044C \u0432 \u0440\u0435\u0439\u0442\u0438\u043D\u0433\u0435  ",document.querySelector(".auth_link").textContent="\u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0432 \u042F\u043D\u0434\u0435\u043A\u0441 \u0430\u043A\u043A\u0430\u0443\u043D\u0442"):(document.querySelector(".title_game").src="./images/title-en.png",document.querySelector(".startgame_title").textContent="start game",document.querySelector(".language_title").textContent="Language:",document.querySelectorAll(".level_text h2>span").forEach(n=>{n.textContent="Level"}),document.querySelectorAll(".leveltime_title").forEach(n=>{n.textContent="Time: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(n=>{n.textContent="Tubing"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(n=>{n.textContent="Speed: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(n=>{n.textContent="Control: "}),document.querySelector(".selecttubedesc_title").textContent="Complete the levels to unlock the tubings",document.querySelector(".menu_in_game_wrap_head").textContent="Pause",document.querySelector(".close_pause_button").textContent="Continue",document.querySelector(".reset_button").textContent="Start again",document.querySelector(".inmenu_button").textContent="Exit to levels",document.querySelector(".finish_you_time_title").textContent="You time: ",document.querySelector(".crash_title").textContent="You crashed",document.querySelector(".finish_title").textContent="You finished",document.querySelectorAll(".finish_again").forEach(n=>{n.textContent="Again"}),document.querySelectorAll(".finish_in_menu").forEach(n=>{n.textContent="Select Level"}),document.querySelector(".current_time_title").textContent="Time",document.querySelector(".best_time_title").textContent="Best time",document.querySelector(".speed_title").textContent="KM/H",document.querySelector(".instruction_start_btn").textContent="START",document.querySelector(".instr-disabled span").textContent="Don't show again",document.querySelector(".desktop_instr").innerHTML=`<h2>Instructions</h2>
    <span>Quickly press <span class='button_active'>W</span> or <span class='button_active'>\u2191</span> to accelerate to the starting point</span>
    <span>Use <span>\u2190</span> <span>\u2192</span> or <span>A</span> <span>D</span> keys to control the tubing</span>
    <span>The goal is to reach the finish line in the shortest time</span>`,document.querySelector(".mobile_instr div").innerHTML=`<span>Quickly press on zone <span> \u2191 </span> to accelerate to the starting point</span>
    <span>By taps on zones <span> \u2190 </span> and <span> \u2192 </span> control the tubing</span>`,document.querySelector(".sci-fi-loader strong").textContent="Loading ",document.querySelector(".main_record_title").textContent="My total time: ",(E=0)&&(document.querySelector(".main_record").textContent="Complete all the levels to set a record"),document.querySelector(".records_wrap>p").textContent="World Ranking: ",document.querySelector(".need_auth_text").textContent="To participate in the rating ",document.querySelector(".auth_link").textContent="login to Yandex account")}St.forEach((e,n)=>{e.addEventListener("click",async()=>{n+1<=Ee&&(N=n+1,Pe.forEach((o,i)=>{_[i].levels.includes(N)?(o.classList.remove("disabledTube"),_[i].canInLevel=!0):(o.classList.add("disabledTube"),_[i].canInLevel=!1)}),D(V),await ne(!1,!0),D(pt))})}),Pe.forEach((e,n)=>{e.addEventListener("click",()=>{_[n].canInLevel&&(S=n,D(0),ee())})});function ee(){if(!p.canStart)D(Ct),z?document.querySelector(".mobile_instr").classList.remove("hidden_instr"):document.querySelector(".desktop_instr").classList.remove("hidden_instr");else{Ge.classList.remove("hidden_block"),Ne.classList.remove("hidden_block"),ce[S].position.copy(l.translation());let e=0;Le=!0,z&&document.querySelector(".instr-mobile-ingame").classList.remove("hidden_block"),z&&document.querySelector(".anim_tap_top").classList.remove("hidden_block");let n=setInterval(o=>{b!=null&&!b.isPlaying&&v&&!de&&b.play(),Ke.classList.remove("hidden_block"),de||e++,e==2&&z&&document.querySelector(".instr-mobile-ingame").classList.add("hidden_block"),e==4?(b==null||b.stop(2.5),Le=!1,We.textContent="GO",H=!0,we.classList.remove("hidden_block"),clearInterval(n),ysdk.features.GameplayAPI.start(),setTimeout(()=>{Ke.classList.add("hidden_block")},600)):We.textContent=4-e},1e3)}}kt.addEventListener("click",()=>{p.canStart=!0,D(0),ee()}),xe.addEventListener("click",()=>{console.log(123),v==!0?(xe.classList.add("audio_off"),d!=null&&d.isPlaying&&d.stop(),c!=null&&c.isPlaying&&c.stop(),b!=null&&b.isPlaying&&b.stop(),v=!1):(xe.classList.remove("audio_off"),d!=null&&!d.isPlaying&&d.play(),l.linvel().z>3&&t.userData.onGround&&!O&&(c==null||c.play()),v=!0)}),_t.addEventListener("click",()=>{z=Me(),document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),d!=null&&v&&d.play(),z&&document.body.requestFullscreen().then(()=>{screen.orientation.lock("landscape")}),Ie.classList.add("hidden_block"),He.classList.remove("hidden_block")});function D(e){ht.forEach(n=>{n.classList.add("hidden_block")}),e!=0&&e.classList.remove("hidden_block")}Dt.addEventListener("click",async()=>{D(V),await Z(),await ne(!0,!0),D(0),ee()}),ft.addEventListener("click",async()=>{D(V),await Z(),await ne(!0,!0),D(0),ee()}),vt.addEventListener("click",async()=>{await Z(),await ne(!0,!0),D(0),ee()}),bt.addEventListener("click",async()=>{D(V),await Z(),await Se(),ysdk.adv.showFullscreenAdv({callbacks:{onOpen:function(e){d!=null&&d.isPlaying&&d.stop()},onClose:function(e){d!=null&&!d.isPlaying&&v&&d.play()},onError:function(e){d!=null&&!d.isPlaying&&v&&d.play()}}})}),wt.addEventListener("click",async()=>{D(V),await Z(),await Se()}),Lt.addEventListener("click",async()=>{D(V),await Z(),await Se()}),we.addEventListener("click",()=>{var e;Le==!1&&H&&!A&&((e=ysdk.features.GameplayAPI)==null||e.stop(),D(At),t.userData.time=k.getElapsedTime(),k.stop(),document.querySelector(".audio_button_wrap").classList.add("hidden_block"),c==null||c.stop(),d==null||d.stop(),O=!0)}),qt.addEventListener("click",()=>{var e;D(0),k.start(),k.elapsedTime=t.userData.time,document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),v&&(d==null||d.play()),l.linvel().z>3&&t.userData.onGround&&v&&(c==null||c.play()),O=!1,(e=ysdk.features.GameplayAPI)==null||e.start()}),xt.onchange=function(){this.checked?(p.canStart=!0,localStorage.setItem("playerData",JSON.stringify(p))):(p.canStart=!1,localStorage.setItem("playerData",JSON.stringify(p)))};let h,qe=!0;performance.now();let N=0,O=!1,v=!0,E=0,ie=0,le,Y=!1,t,l,ve,Le=!1,ce=[],S=0,G,Ce,de=!1,ke,A;const _=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,nowSpeed:0,maxSpeed:26,resetHAngle:!1,levels:[1,2,3,4,5,6,7,8,9],canInLevel:!1},{hSpeed:12,maxHSpeed:.1,stepSpeed:2,nowSpeed:0,maxSpeed:38,resetHAngle:!1,levels:[4,5,6,7,8,9],canInLevel:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:2,nowSpeed:0,maxSpeed:44,resetHAngle:!0,levels:[7,8,9],canInLevel:!1}];let c,d,R,b,Ye,q=[],U=new x,zt=new De,H=!1,Ae=!1,$,Ue,$e,g,B,P,L,C,ue,pe,me,Q,X,ze,j=[],ye=[],Te=[],f,z=Me(),Tt=new ge,k=new ge,he=0,Qe=1/60,W=0,M=0,Ee=2,p;const Xe=new De,Et=new x(0,-1,0),u=new et;u.background=new tt(14479094),u.fog=new nt(u.background,1,300);const te=new ot(16777215,16777215,2);te.color.setHSL(.6,1,.6),te.groundColor.setHSL(.095,1,.75),te.position.set(0,100,0),new at(te,10);const _e=new st(16777215,3);_e.position.set(1,2,.2),_e.position.multiplyScalar(120),new rt(_e,10),new it(11184810,1);const w=new lt(85,document.body.offsetWidth/document.body.offsetHeight,.1,310);w.position.set(0,4,-10);const J=new ct({antialias:!1});J.setSize(document.body.offsetWidth,document.body.offsetHeight),document.body.appendChild(J.domElement),J.shadowMap.enabled=!1,window.addEventListener("resize",Rt,!1);function Rt(){z?(w.aspect=document.body.offsetWidth/document.body.offsetHeight,w.updateProjectionMatrix(),J.setSize(innerWidth,innerHeight)):(w.aspect=document.body.offsetWidth/document.body.offsetHeight,w.updateProjectionMatrix(),J.setSize(document.body.offsetWidth,document.body.offsetHeight))}async function Mt(){localStorage.getItem("playerData")?(p=JSON.parse(localStorage.getItem("playerData")),se.forEach(e=>{e.classList.remove("selected")}),se[p.language].classList.add("selected"),Ve(p.language),ie=Object.keys(p.levelsTimes).length,ie==be.length&&(E=0,Object.values(p.levelsTimes).forEach(e=>{E+=parseFloat(e)}),ae.textContent=F(Math.round(E*1e3)),ae.classList.add("main_record_green"))):(p={levelsTimes:{},canStart:!1,language:0},localStorage.setItem("playerData",JSON.stringify(p))),JSON.stringify(p),Ee=0,be.forEach((e,n)=>{n<Object.keys(p.levelsTimes).length+2&&(Ee++,e.classList.remove("level_disabled"))}),gt.forEach((e,n,o)=>{p.levelsTimes["time"+(n+1)]!=null?e.childNodes[2].textContent=p.levelsTimes["time"+(n+1)]:e.childNodes[2].textContent="00.000"})}async function It(){k=new ge,u.add(_e),u.add(te),M=0,await m.init(),h=new m.World(new m.Vector3(0,-9.81,0)),await new Re().loadAsync("models/map-menu.glb",onprogress=s=>{console.log(`Loaded: ${s.loaded}, Total: ${s.total}`);let y=Math.min(Math.round(s.loaded/s.total*100),100);re.textContent=y+"%"}).then(s=>{const y=s.scene;re.textContent="0",y.traverse(r=>{if(r.name=="player")t=r.clone(),t.userData.vertices=t.geometry.attributes.position.array,t.userData.indices=t.geometry.index.array,t.material.transparent=!0,t.material.opacity=0,t.userData.mass=1,t.userData.playerBraking=!1,t.userData.hTransition=0,t.userData.currentSpeed=0,t.userData.boom=!1,t.userData.onStartArea=!0,t.userData.canBoostStep=!0,t.userData.time=0,t.userData.right=!1,t.userData.left=!1,t.userData.onGround=!1,t.userData.flying=!1,t.userData.origPosition=t.position,I(t),u.add(t);else if(r.name.includes("player-tube"))G=r.clone(),G.userData.startPosition=new x(G.position.x,G.position.y,G.position.z),ce[r.name.slice(-1)-1]=G,u.add(G);else if(r.name=="arrow_area")f=r.clone(),f.userData.hPos=0,u.add(f);else if(r.name.includes("ground"))new K().setFromObject(r).getSize(new x),$=r.clone(),$.userData.mass=0,I($),j.push($),u.add($),r.name=="left_ground_wall"?Ue=r.position:r.name=="right_ground_wall"&&($e=r.position);else if(r.name.includes("wall")){new K().setFromObject(r).getSize(new x);let T=r.clone();T.userData.mass=1,I(T),j.push(T),ye.push(T),u.add(T)}else if(r.name.includes("area")){let T=r.clone();u.add(T)}else r.name.includes("start_flag")?(Ce=r.clone(),u.add(Ce)):r.name.includes("itsmen_body")?(g=r.clone(),g.material.transparent=!0,g.material.opacity=0,u.add(g),I(g)):r.name.includes("itsmen_left_hand")?(B=r.clone(),B.material.transparent=!0,B.material.opacity=0,u.add(B),I(B)):r.name.includes("itsmen_right_hand")?(P=r.clone(),P.material.transparent=!0,P.material.opacity=0,u.add(P),I(P)):r.name.includes("itsmen_left_leg")?(L=r.clone(),L.material.transparent=!0,L.material.opacity=0,u.add(L),I(L)):r.name.includes("itsmen_right_leg")?(C=r.clone(),C.material.transparent=!0,C.material.opacity=0,u.add(C),I(C)):r.name.includes("qmen_body")?(ue=r.clone(),u.add(ue)):r.name.includes("qmen_left_hand")?(pe=r.clone(),u.add(pe)):r.name.includes("qmen_right_hand")?(me=r.clone(),u.add(me)):r.name.includes("qmen_left_leg")?(Q=r.clone(),u.add(Q)):r.name.includes("qmen_right_leg")&&(X=r.clone(),u.add(X))})}),u.traverse(function(s){s.material&&(s.material.needsUpdate=!0)}),await Mt();let e=m.JointData.spherical({x:.2,y:0,z:-.2},{x:-.4,y:0,z:0});h.createImpulseJoint(e,g.userData.body,B.userData.body,!0);let n=m.JointData.spherical({x:-.2,y:0,z:-.2},{x:.4,y:0,z:0});h.createImpulseJoint(n,g.userData.body,P.userData.body,!0);let o=m.JointData.spherical({x:.22,y:0,z:.5},{x:0,y:0,z:-.5});h.createImpulseJoint(o,g.userData.body,L.userData.body,!0);let i=m.JointData.spherical({x:-.22,y:0,z:.5},{x:0,y:0,z:-.5});h.createImpulseJoint(i,g.userData.body,C.userData.body,!0);let a=m.JointData.spherical({x:0,y:0,z:0},{x:0,y:.3,z:0});ze=h.createImpulseJoint(a,g.userData.body,l,!0),Ae=!0}async function Ht(){A=!1;const e=new Re,n="models/map"+N+".glb";await e.loadAsync(n,onprogress=o=>{let i=Math.min(Math.round(o.loaded/o.total*100),100);re.textContent=i+"%"}).then(o=>{const i=o.scene;re.textContent="0",i.traverse(a=>{if(a.name.includes("ground")){new K().setFromObject(a).getSize(new x);let s=a.clone();s.userData.mass=0,s.name=a.name,I(s),j.push(s),u.add(s)}else if(a.name.includes("wall")){new K().setFromObject(a).getSize(new x);let s=a.clone();s.userData.mass=1,I(s),j.push(s),ye.push(s),u.add(s)}else if(a.name.includes("moving_block")){const s=new K().setFromObject(a).getSize(new x);let y=a.clone();y.userData.size=s,y.userData.mass=1,y.userData.raycaster=new De,y.userData.speed=-a.name.substr(a.name.indexOf("speed")+6),y.userData.direction=new x(y.userData.speed,0,0),Oe.push(y),I(y),ye.push(y),u.add(y)}else if(a.name.includes("area")){let s=a.clone();u.add(s)}else a.name.includes("finish_block")&&(ke=a.clone(),u.add(ke))})}),Je.textContent=p.levelsTimes["time"+N]}async function Bt(){const e=new dt;t.add(e);const n=new ut;await n.loadAsync("audio/slide.mp3").then(o=>{c=new oe(e),c.setBuffer(o),c.setLoop(!0),c.setRefDistance(40),c.setVolume(.7),t.add(c)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await n.loadAsync("audio/around.mp3").then(o=>{d=new oe(e),d.setBuffer(o),d.setLoop(!0),d.setRefDistance(40),d.setVolume(1),d.error=!1,t.add(d)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await n.loadAsync("audio/boom1.mp3").then(o=>{R=new oe(e),R.setBuffer(o),R.setLoop(!1),R.setRefDistance(40),R.setVolume(.9),R.error=!1,t.add(R)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await n.loadAsync("audio/bip.mp3").then(o=>{b=new oe(e),b.setBuffer(o),b.setLoop(!1),b.setRefDistance(40),b.setVolume(.7),b.error=!1,t.add(b)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)})}document.querySelector(".auth_link").addEventListener("click",()=>{ysdk.auth.openAuthDialog().then(()=>{ysdk.isAvailableMethod("leaderboards.setLeaderboardScore").then(e=>{Y=e,ysdk.getLeaderboards().then(n=>{le=n,n.getLeaderboardEntries("main",{quantityTop:3,includeUser:Y,quantityAround:0}).then(o=>{console.log(o),document.querySelector(".records_wrap>div").innerHTML="",p.language==0?document.querySelector(".need_auth").textContent="\u0412\u044B \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u043E\u0432\u0430\u043B\u0438\u0441\u044C! \u041C\u043E\u0436\u0435\u0442\u0435 \u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0440\u0435\u043A\u043E\u0440\u0434\u044B!":document.querySelector(".need_auth").textContent="You have logged in! You can set records!",document.querySelector(".need_auth").classList.add("green"),o.entries.forEach((i,a)=>{o.userRank==a+1?document.querySelector(".records_wrap>div").innerHTML=document.querySelector(".records_wrap>div").innerHTML+'<p class = "main_record_green">'+parseInt(a+1)+". "+F(i.score)+"</p>":document.querySelector(".records_wrap>div").innerHTML=document.querySelector(".records_wrap>div").innerHTML+"<p>"+parseInt(a+1)+". "+F(i.score)+"</p>"})})})}),initPlayer().catch(e=>{})}).catch(()=>{})});async function Se(){await ne(!0,!1),qe?(D(Ie),YaGames.init().then(e=>{var n;(n=e.features.LoadingAPI)==null||n.ready(),e.isAvailableMethod("leaderboards.setLeaderboardScore").then(o=>{Y=o,Y&&document.querySelector(".need_auth").classList.add("hidden_block"),e.getLeaderboards().then(i=>{le=i,i.getLeaderboardEntries("main",{quantityTop:3,includeUser:Y,quantityAround:0}).then(a=>{console.log(a),a.entries.forEach((s,y)=>{a.userRank==y+1?document.querySelector(".records_wrap>div").innerHTML=document.querySelector(".records_wrap>div").innerHTML+'<p class = "main_record_green">'+parseInt(y+1)+". "+F(s.score)+"</p>":document.querySelector(".records_wrap>div").innerHTML=document.querySelector(".records_wrap>div").innerHTML+"<p>"+parseInt(y+1)+". "+F(s.score)+"</p>"})})})})}),qe=!1):D(He)}Se();async function ne(e,n){e&&await It(),n&&await Ht(),qe&&Bt()}async function Z(){for(H=!1,Ae=!1,M=0,t.userData.time=0,t.userData.boom=!1,_.forEach(e=>{e.nowSpeed=0}),j=[],ye=[],q=[],we.classList.add("hidden_block"),Ge.classList.add("hidden_block"),Ne.classList.add("hidden_block"),document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),k.start(),k.elapsedTime=t.userData.time,O=!1,t.userData.currentSpeed=0,je.textContent=t.userData.currentSpeed,M=0,fe.textContent=M;u.children.length>0;){let e=u.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(n=>n.dispose()):e.material.dispose()),u.remove(e)}A=!1}function Pt(){if(Ae&&!A&&(c!=null&&v&&(l.linvel().z>3&&t.userData.onGround?c.isPlaying||c.play():c.isPlaying&&c.stop()),z?t.userData.boom?(w.lookAt(g.position),c==null||c.stop()):(w.lookAt(new x(w.position.x,t.position.y,t.position.z+5)),w.position.y=t.position.y+5,w.position.z=t.position.z-3):t.userData.boom?(G.position.y>0&&w.lookAt(g.position),c==null||c.stop()):(w.lookAt(new x(w.position.x,t.position.y,t.position.z+5)),w.position.y=t.position.y+4,w.position.z=t.position.z-4),f.position.set(t.position.x,t.position.y,t.position.z+5)),H){A?(D(mt),c==null||c.stop()):(M=k.getElapsedTime().toFixed(3),fe.textContent=M,Ft(),Ot()),t.position.x>Ue.x-t.userData.size.x/1.3&&(f.position.x=t.position.x,t.userData.hTransition=-.4),t.position.x<$e.x+t.userData.size.x/1.3&&(f.position.x=t.position.x,t.userData.hTransition=.4);let e=new m.EventQueue(!0);h.step(e),ce[S].position.copy(l.translation()),ce[S].quaternion.copy(l.rotation()),ue.position.copy(g.position),ue.rotation.copy(g.rotation),pe.position.copy(B.position),pe.rotation.copy(B.rotation),me.position.copy(P.position),me.rotation.copy(P.rotation),Q.position.copy(L.position),Q.rotation.copy(L.rotation),X.position.copy(C.position),X.rotation.copy(C.rotation);for(let n=0,o=q.length;n<o;n++)q[n][0].position.copy(q[n][1].translation()),q[n][0].quaternion.copy(q[n][1].rotation());e.drainCollisionEvents((n,o,i)=>{Te.forEach((a,s)=>{var y,r;l.handle==n&&a.handle==o&&!A?l.linvel().z<15&&t.userData.boom==!1&&(R!=null&&v&&R.play(),h.removeImpulseJoint(ze),g.userData.body.applyImpulse({x:5,y:5,z:5},!0),g.userData.body.setEnabledRotations(!0),ve.setFriction(20),setTimeout(()=>{H=!1,D(Be)},3e3),(y=ysdk.features.GameplayAPI)==null||y.stop(),t.userData.boom=!0):l.handle==n&&!A&&l.linvel().z<15&&t.position.y<5&&t.userData.boom==!1&&(R!=null&&v&&R.play(),h.removeImpulseJoint(ze),g.userData.body.applyImpulse({x:5,y:5,z:5},!0),g.userData.body.setEnabledRotations(!0),ve.setFriction(20),(r=ysdk.features.GameplayAPI)==null||r.stop(),t.userData.boom=!0,setTimeout(()=>{H=!1,D(Be)},3e3))})})}}J.setAnimationLoop(()=>{he+=Tt.getDelta(),he>Qe&&!O&&(Pt(),J.render(u,w),he=he%Qe)}),document.addEventListener("touchend",Gt),document.addEventListener("touchstart",Ze),document.addEventListener("touchmove",Ze),window.addEventListener("keydown",Jt),window.addEventListener("keyup",Nt);function Ot(){Oe.forEach((e,n)=>{let o=e,i=Fe[n];i.setLinvel(o.userData.direction,!0),i.setAngvel({x:o.userData.direction.z,y:o.userData.direction.y,z:-o.userData.direction.x},!0);const a=o.userData.direction;o.userData.raycaster.set(new x(o.position.x,.4,o.position.z),a.clone().normalize());const s=o.userData.raycaster.intersectObjects(j);s.length>0&&s[0].distance<o.userData.size.x/2&&(o.userData.direction.x=o.userData.direction.x*-1)})}function Ft(){var a;t.position.z>ke.position.z&&!t.userData.boom&&(M=k.getElapsedTime().toFixed(3),fe.textContent=M,A=!0,(a=ysdk.features.GameplayAPI)==null||a.stop(),yt.textContent=M,p.levelsTimes["time"+N]!=null?W=p.levelsTimes["time"+N]:W=0,(M<W||W==0)&&(W=M,Je.textContent=W,p.levelsTimes["time"+N]=W,ie=Object.keys(p.levelsTimes).length,ie==be.length&&(E=0,Object.values(p.levelsTimes).forEach(s=>{E+=parseFloat(s)}),ae.textContent=F(Math.round(E*1e3)),ae.classList.add("main_record_green"),Y&&(console.log(Math.round(E*1e3)),le.setLeaderboardScore("main",Math.round(E*1e3)).then(()=>{console.log("setNewRec"),ysdk.getLeaderboards().then(s=>{le=s,s.getLeaderboardEntries("main",{quantityTop:3,includeUser:!0,quantityAround:0}).then(y=>{console.log(y),document.querySelector(".records_wrap>div").innerHTML="",y.entries.forEach((r,T)=>{y.userRank==T+1?document.querySelector(".records_wrap>div").innerHTML=document.querySelector(".records_wrap>div").innerHTML+'<p class = "main_record_green">'+parseInt(T+1)+". "+F(r.score)+"</p>":document.querySelector(".records_wrap>div").innerHTML=document.querySelector(".records_wrap>div").innerHTML+"<p>"+parseInt(T+1)+". "+F(r.score)+"</p>"})})})})),console.log("mainRecord "+E.toFixed(3))),localStorage.setItem("playerData",JSON.stringify(p))),t.position.z=0),f.position.x+=t.userData.hTransition;const e=new x().subVectors(l.translation(),f.position).normalize(),n=l.linvel(),o=new x(e.x*-_[S].hSpeed,n.y,e.z*-_[S].nowSpeed);l.translation().y<100&&l.translation().y>=20&&(_[S].nowSpeed+=.05,l.rotation().x<.04&&l.setRotation({w:l.rotation().w,x:.04,y:l.rotation().y,z:l.rotation().z})),l.translation().y<20&&l.translation().y>1&&l.lockRotations(!0,!0,!0,!0),l.setLinvel(o,!0),f.lookAt(f.position.x-(t.position.x-f.position.x),f.position.y-(t.position.y-f.position.y),f.position.z-(t.position.z-f.position.z)),l.setRotation({w:f.quaternion.w,x:l.rotation().x,y:f.quaternion.y,z:l.rotation().z}),g.userData.body.setRotation({w:f.quaternion.w,x:l.rotation().x,y:f.quaternion.y,z:l.rotation().z}),(Q.rotation.y>0||Q.rotation.y<0)&&L.userData.body.setRotation({w:L.userData.body.rotation().w,x:L.userData.body.rotation().x,y:0,z:L.userData.body.rotation().z}),(X.rotation.y>0||X.rotation.y<0)&&C.userData.body.setRotation({w:C.userData.body.rotation().w,x:C.userData.body.rotation().x,y:0,z:C.userData.body.rotation().z}),Xe.set(t.position,Et);const i=Xe.intersectObjects(j);i.length>0&&(i[0].distance<.4?(t.userData.flying=!1,t.userData.onGround=!0):(t.userData.onGround=!1,t.userData.flying=!0)),l.linvel().z>0?t.userData.currentSpeed=l.linvel().z.toFixed(0):t.userData.currentSpeed=0,je.textContent=t.userData.currentSpeed,t.userData.left&&t.userData.onGround&&!t.userData.onStartArea&&(t.userData.hTransition<5&&(t.userData.hTransition+=_[S].maxHSpeed),_[S].nowSpeed-=.009),t.userData.right&&t.userData.onGround&&!t.userData.onStartArea&&(t.userData.hTransition>-5&&(t.userData.hTransition-=_[S].maxHSpeed),_[S].nowSpeed-=.009),_[S].resetHAngle&&!t.userData.left&&!t.userData.right&&(t.userData.hTransition<-_[S].maxHSpeed?t.userData.hTransition+=_[S].maxHSpeed:t.userData.hTransition>_[S].maxHSpeed?t.userData.hTransition-=_[S].maxHSpeed:t.userData.hTransition=0),t.position.z>Ce.position.z?(t.userData.onStartArea==!0&&z&&document.querySelector(".anim_tap_top").classList.add("hidden_block"),t.userData.onStartArea==!0&&z&&document.querySelector(".anim_tap_left").classList.remove("hidden_block"),t.userData.onStartArea==!0&&z&&document.querySelector(".anim_tap_right").classList.remove("hidden_block"),t.userData.onStartArea==!0&&z&&setTimeout(()=>{document.querySelector(".anim_tap_left").classList.add("hidden_block"),document.querySelector(".anim_tap_right").classList.add("hidden_block")},2e3),t.userData.onStartArea=!1):t.userData.onStartArea=!0}function Ze(e){if(t.userData.onGround){e=e.changedTouches[0];var n=J.domElement.getBoundingClientRect();U.x=(e.clientX-n.left)/n.width*2-1,U.y=-((e.clientY-n.top)/n.height)*2+1,zt.setFromCamera(U,w),U.y>0&&t.userData.canBoostStep&&H&&t.userData.onStartArea&&l.linvel().z<_[S].maxSpeed&&l.linvel().y<5&&l.linvel().y>-5&&!A&&_[S].nowSpeed<_[S].maxSpeed&&(_[S].nowSpeed+=_[S].stepSpeed),t.userData.canBoostStep=!1,U.y<.5&&(U.x>0?(t.userData.left=!1,t.userData.right=!0):(t.userData.right=!1,t.userData.left=!0))}}function Gt(e){t.userData.right=!1,t.userData.left=!1,t.userData.canBoostStep=!0}function Jt(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep&&H&&t.userData.onStartArea&&l.linvel().z<_[S].maxSpeed&&l.linvel().y<5&&l.linvel().y>-5&&!A&&_[S].nowSpeed<_[S].maxSpeed&&(_[S].nowSpeed+=_[S].stepSpeed),t.userData.canBoostStep=!1;break;case"KeyS":case"ArrowDown":break;case"KeyA":case"ArrowLeft":t.userData.left=!0;break;case"KeyD":case"ArrowRight":t.userData.right=!0;break}}function Nt(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep=!0;break;case"KeyS":case"ArrowDown":break;case"KeyA":case"ArrowLeft":t.userData.left=!1;break;case"KeyD":case"ArrowRight":t.userData.right=!1;break}}function I(e){let n,o;const i=e.rotation.clone();e.rotation.set(0,0,0);const a=new K().setFromObject(e).getSize(new x);if(e.rotation.copy(i),e.name.includes("player")?(t.userData.size=a,t.userData.orgRotation=i,n=h.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),o=m.ColliderDesc.cuboid(a.x/5,a.y/1.5,a.z/3).setMass(e.userData.mass).setRestitution(0).setFriction(0),l=n,ve=o,o.setActiveEvents(m.ActiveEvents.COLLISION_EVENTS),h.createCollider(o,n),t.userData.handle=l.handle,q.push([e,n,e.id])):e.name.includes("ground")&&(n=h.createRigidBody(m.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),o=m.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),h.createCollider(o,n),Ye=n,$.userData.handle=Ye.handle,q.push([e,n,e.id])),e.name.includes("wall")){n=h.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0)),o=m.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(40);let s=h.createCollider(o,n);Te.push(s),q.push([e,n,e.id])}if(e.name.includes("moving_block")){n=h.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!0,!0).setLinearDamping(0)),o=m.ColliderDesc.ball(a.x/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(20);let s=n;Fe.push(s);let y=h.createCollider(o,n);Te.push(y),q.push([e,n,e.id])}e.name.includes("itsmen_body")&&(n=h.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!0).setLinearDamping(0).setAngularDamping(0)),o=m.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(0).setRestitution(0).setFriction(0).setDensity(2),g.userData.body=n,g.userData.collider=o,h.createCollider(o,n),q.push([e,n,e.id])),e.name.includes("itsmen_left_hand")&&(n=h.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=m.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),B.userData.body=n,B.userData.collider=o,h.createCollider(o,n),q.push([e,n,e.id])),e.name.includes("itsmen_right_hand")&&(n=h.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=m.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),P.userData.body=n,P.userData.collider=o,h.createCollider(o,n),q.push([e,n,e.id])),e.name.includes("itsmen_left_leg")&&(n=h.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=m.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),L.userData.body=n,L.userData.collider=o,h.createCollider(o,n),q.push([e,n,e.id])),e.name.includes("itsmen_right_leg")&&(n=h.createRigidBody(m.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=m.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),C.userData.body=n,C.userData.collider=o,h.createCollider(o,n),q.push([e,n,e.id]))}document.addEventListener("visibilitychange",function(){var e,n;document.visibilityState==="visible"?(de=!1,v&&O==!1&&(d==null||d.play()),l.linvel().z>3&&t.userData.onGround&&v&&O==!1&&(c==null||c.play()),!A&&H&&O==!1&&((e=ysdk.features.GameplayAPI)==null||e.start(),k.start(),k.elapsedTime=t.userData.time)):(de=!0,(n=ysdk.features.GameplayAPI)==null||n.stop(),b!=null&&b.isPlaying&&b.pause(),d==null||d.stop(),c==null||c.stop(),O==!1&&!A&&H&&(t.userData.time=k.getElapsedTime(),k.stop()))});
