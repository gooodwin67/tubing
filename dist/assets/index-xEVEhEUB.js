import{C as j,S as ge,a as De,F as fe,H as Se,b as xe,D as be,c as ve,A as ze,P as _e,d as ke,W as Be,e as Le,V as y,R as te,G as ne,B as C}from"./three-C4_QSHiD.js";import{O as l}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();function I(e,n){e.geometry.computeBoundingBox(),n.forEach(function(a,s,$){a.children.length>0?a.children.forEach(function(z,he,we){z.geometry.computeBoundingBox()}):a.geometry.computeBoundingBox()}),e.updateMatrixWorld(),n.forEach(function(a,s,$){a.updateMatrixWorld()});let i=e.geometry.boundingBox.clone();i.applyMatrix4(e.matrixWorld);var o=!1;return n.forEach(function(a,s,$){if(a.children.length>0)a.children.forEach(function(z,he,we){let ee=z.geometry.boundingBox.clone();ee.applyMatrix4(z.matrixWorld),i.intersectsBox(ee)&&(o=z)});else{let z=a.geometry.boundingBox.clone();z.applyMatrix4(a.matrixWorld),i.intersectsBox(z)&&(o=a)}}),o}function ae(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}let T=document.querySelector(".main_load"),oe=document.querySelector(".main_menu"),Ae=document.querySelector(".select_level"),Ce=document.querySelector(".select_tube"),Ee=document.querySelector(".finish_window"),qe=document.querySelectorAll("body>.overlay"),Re=document.querySelector(".startButton"),Te=document.querySelectorAll(".load_level_wrap>div"),Me=document.querySelectorAll(".load_tubes_wrap>div"),U=document.querySelector(".current_time"),He=document.querySelector(".best_time"),Fe=document.querySelector(".finish_again"),We=document.querySelector(".finish_in_menu"),ie=document.querySelector(".speed_block>.speed"),Oe=document.querySelector(".shadow_check"),M=document.querySelector(".load_percent"),Ge=document.querySelector(".pause_button"),Ke=document.querySelector(".reset_button"),Pe=document.querySelector(".inmenu_button"),se=document.querySelector(".start_time"),re=document.querySelector(".start_time_wrap");Te.forEach((e,n)=>{e.addEventListener("click",async()=>{de=n+1,f(T),await K(!1,!0),f(Ce)})}),Me.forEach((e,n)=>{e.addEventListener("click",()=>{c=n,f(0),N()})});function N(){F[c].position.copy(r.translation());let e=0,n=setInterval(i=>{re.classList.remove("hidden_block"),e++,e==4?(se.textContent="GO",_=!0,clearInterval(n),setTimeout(()=>{re.classList.add("hidden_block")},800)):se.textContent=4-e},1e3)}Re.addEventListener("click",()=>{Q=ae(),Q&&document.body.requestFullscreen().then(()=>{screen.orientation.lock("landscape")}),oe.classList.add("hidden_block"),Ae.classList.remove("hidden_block")});function f(e){qe.forEach(n=>{n.classList.add("hidden_block")}),e!=0&&e.classList.remove("hidden_block")}Fe.addEventListener("click",async()=>{f(T),await P(),await K(!0,!0),f(0),N()}),Ke.addEventListener("click",async()=>{await P(),await K(!0,!0),f(0),N()}),We.addEventListener("click",async()=>{f(T),await P(),await Z()}),Pe.addEventListener("click",async()=>{f(T),await P(),await Z()}),Ge.addEventListener("click",()=>{H?(g.start(),g.elapsedTime=t.userData.time,H=!1):(t.userData.time=g.getElapsedTime(),g.stop(),H=!0)}),Oe.onchange=function(){this.checked?(D.shadowMap.enabled=!0,d.traverse(e=>{e.material&&(e.material.needsUpdate=!0)})):(D.shadowMap.enabled=!1,d.traverse(e=>{e.material&&(e.material.needsUpdate=!0)}))};let p,je=[],de=0,H=!1,t,r,F=[],c=0,V,E=[],J,b;const h=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,maxSpeed:26,resetHAngle:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:10,maxSpeed:180,resetHAngle:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:3,maxSpeed:30,resetHAngle:!0}];let S=[],v=new y,X=new te,_=!1,Y=!1,L,ce,le,k,A,q=[],w,Q=ae(),Ie=new j,g=new j,W=0,ue=1/60,O=0,x=0;const pe=new te,Ue=new y(0,-1,0),d=new ge;d.background=new De(14479094),d.fog=new fe(d.background,1,300);const R=new Se(16777215,16777215,2);R.color.setHSL(.6,1,.6),R.groundColor.setHSL(.095,1,.75),R.position.set(0,100,0),new xe(R,10);const m=new be(16777215,3);m.position.set(1,2,.2),m.position.multiplyScalar(120),m.castShadow=!0,m.shadow.mapSize.width=2048,m.shadow.mapSize.height=2048;const G=1e3;m.shadow.camera.left=-G,m.shadow.camera.right=G,m.shadow.camera.top=G,m.shadow.camera.bottom=-G,m.shadow.camera.far=3500,m.shadow.bias=-.001,new ve(m,10),new ze(11184810,1);const u=new _e(75,window.innerWidth/window.innerHeight,.1,1e3);u.position.set(0,4,-10);let me=new ke;document.body.appendChild(me.dom);const D=new Be;D.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(D.domElement),D.shadowMap.enabled=!0,D.shadowMap.type=Le,window.addEventListener("resize",Ne,!1);function Ne(){u.aspect=window.innerWidth/window.innerHeight,u.updateProjectionMatrix(),D.setSize(window.innerWidth,window.innerHeight)}async function Ve(){g=new j,d.add(m),d.add(R),x=0,await l.init(),p=new l.World(new l.Vector3(0,-9.81,0)),await new ne().loadAsync("models/map-menu.glb",onprogress=n=>{M.textContent=Math.round(n.loaded/n.total*100)+"%"}).then(n=>{const i=n.scene;M.textContent="0",i.traverse(o=>{if(o.name=="player")t=o.clone(),t.userData.vertices=t.geometry.attributes.position.array,t.userData.indices=t.geometry.index.array,t.castShadow=!0,t.receiveShadow=!0,t.material.transparent=!0,t.material.opacity=0,t.userData.mass=1,t.userData.playerBraking=!1,t.userData.hTransition=0,t.userData.currentSpeed=0,t.userData.onStartArea=!0,t.userData.canBoostStep=!0,t.userData.time=0,t.userData.right=!1,t.userData.left=!1,t.userData.onGround=!1,t.userData.flying=!1,t.userData.origPosition=t.position,B(t),d.add(t);else if(o.name.includes("player-tube")){var a=o.clone();a.userData.startPosition=new y(a.position.x,a.position.y,a.position.z),F[o.name.slice(-1)-1]=a,d.add(a)}else if(o.name=="arrow_area")w=o.clone(),w.userData.hPos=0,d.add(w);else if(o.name.includes("ground"))new C().setFromObject(o).getSize(new y),L=o.clone(),L.receiveShadow=!0,L.userData.mass=0,B(L),q.push(L),d.add(L),o.name=="left_ground_wall"?ce=o.position:o.name=="right_ground_wall"&&(le=o.position);else if(o.name.includes("wall")){new C().setFromObject(o).getSize(new y);let s=o.clone();s.castShadow=!0,s.receiveShadow=!0,s.userData.mass=1,B(s),q.push(s),d.add(s)}else if(o.name.includes("area")){let s=o.clone();s.castShadow=!0,d.add(s)}else o.name.includes("start_flag")?(V=o.clone(),d.add(V)):o.name.includes("itsmen_body")?(k=o.clone(),d.add(k),B(k)):o.name.includes("itsmen_left_hand")&&(A=o.clone(),d.add(A),B(A))})}),d.traverse(function(n){n.material&&(n.material.needsUpdate=!0)});let e=l.JointData.spherical({x:.3,y:.4,z:0},{x:0,y:-.4,z:0});p.createImpulseJoint(e,k.userData.body,A.userData.body,!0),Y=!0}async function Je(){b=!1;const e=new ne,n="models/map"+de+".glb";await e.loadAsync(n,onprogress=i=>{M.textContent=Math.round(i.loaded/i.total*100)+"%"}).then(i=>{const o=i.scene;M.textContent="0",o.traverse(a=>{if(a.name.includes("ground")){new C().setFromObject(a).getSize(new y);let s=a.clone();s.receiveShadow=!0,s.userData.mass=0,s.name=a.name,B(s),q.push(s),d.add(s)}else if(a.name.includes("wall")){new C().setFromObject(a).getSize(new y);let s=a.clone();s.userData.mass=1,B(s),q.push(s),d.add(s)}else if(a.name.includes("area")){let s=a.clone();s.castShadow=!0,s.receiveShadow=!0,d.add(s),a.name.includes("star_area")&&E.push(s)}else a.name.includes("finish_block")&&(J=a.clone(),d.add(J))})})}async function Z(){await K(!0,!1),f(oe)}Z();async function K(e,n){e&&await Ve(),n&&await Je()}async function P(){for(_=!1,Y=!1,x=0,t.userData.currentSpeed=0,ie.textContent=t.userData.currentSpeed,x=0,U.textContent=x;d.children.length>0;){let e=d.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(n=>n.dispose()):e.material.dispose()),d.remove(e)}b=!1}function Xe(){if(Y&&!b&&(Q?(u.lookAt(new y(u.position.x,t.position.y,t.position.z+5)),u.position.y=t.position.y+5,u.position.z=t.position.z-3):(u.lookAt(new y(u.position.x,t.position.y,t.position.z+5)),u.position.y=t.position.y+4,u.position.z=t.position.z-4),w.position.set(t.position.x,t.position.y,t.position.z+5)),_){b?f(Ee):(x=g.getElapsedTime().toFixed(3),U.textContent=x,Ye(),E.forEach((e,n,i)=>{e.rotation.z+=.05}),I(t,E)&&(console.log(I(t,E)),d.remove(I(t,E)))),t.position.x>ce.x-t.userData.size.x/1.3&&(w.position.x=t.position.x,t.userData.hTransition=-.4),t.position.x<le.x+t.userData.size.x/1.3&&(w.position.x=t.position.x,t.userData.hTransition=.4),p.step(),F[c].position.copy(r.translation()),F[c].quaternion.copy(r.rotation());for(let e=0,n=S.length;e<n;e++)S[e][0].position.copy(S[e][1].translation()),S[e][0].quaternion.copy(S[e][1].rotation())}me.update()}D.setAnimationLoop(()=>{W+=Ie.getDelta(),W>ue&&!H&&(Xe(),D.render(d,u),W=W%ue)}),document.addEventListener("touchend",Ze),document.addEventListener("touchstart",ye),document.addEventListener("touchmove",ye),window.addEventListener("keydown",$e),window.addEventListener("keyup",et),document.addEventListener("mousedown",Qe,!1);function Ye(){t.position.z>J.position.z&&(x=g.getElapsedTime().toFixed(3),U.textContent=x,b=!0,(x<O||O==0)&&(O=x,He.textContent=O),t.position.z=0),w.position.x+=t.userData.hTransition;const e=new y().subVectors(r.translation(),w.position).normalize();w.lookAt(t.position.x,t.position.y,t.position.z),r.setRotation({w:w.quaternion.w,x:r.rotation().x,y:w.quaternion.y,z:r.rotation().z}),r.setLinvel({x:e.x*-h[c].hSpeed,y:r.linvel().y,z:r.linvel().z}),pe.set(t.position,Ue);const n=pe.intersectObjects(q);if(n.length>0&&(n[0].distance<.4?(t.userData.flying=!1,!t.userData.onGround&&t.userData.flying,t.userData.onGround=!0):(t.userData.onGround=!1,t.userData.flying=!0)),r.linvel().z>0?t.userData.currentSpeed=r.linvel().z.toFixed(0):t.userData.currentSpeed=0,ie.textContent=t.userData.currentSpeed,t.userData.left&&t.userData.onGround){t.userData.hTransition<5&&(t.userData.hTransition+=h[c].maxHSpeed);let i=r.linvel();i.z*=.9996,r.setLinvel(i,!0)}if(t.userData.right&&t.userData.onGround){t.userData.hTransition>-5&&(t.userData.hTransition-=h[c].maxHSpeed);let i=r.linvel();i.z*=.9996,r.setLinvel(i,!0)}h[c].resetHAngle&&!t.userData.left&&!t.userData.right&&(t.userData.hTransition<-h[c].maxHSpeed?t.userData.hTransition+=h[c].maxHSpeed:t.userData.hTransition>h[c].maxHSpeed?t.userData.hTransition-=h[c].maxHSpeed:t.userData.hTransition=0),t.position.z>V.position.z?t.userData.onStartArea=!1:t.userData.onStartArea=!0}function ye(e){if(t.userData.onGround){e=e.changedTouches[0];var n=D.domElement.getBoundingClientRect();v.x=(e.clientX-n.left)/n.width*2-1,v.y=-((e.clientY-n.top)/n.height)*2+1,X.setFromCamera(v,u),v.y>0&&t.userData.canBoostStep&&_&&t.userData.onStartArea&&r.linvel().z<h[c].maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&!b&&r.applyImpulse({x:0,y:0,z:h[c].stepSpeed},!0),t.userData.canBoostStep=!1,v.y<0&&(v.x>0?(t.userData.left=!1,t.userData.right=!0):(t.userData.right=!1,t.userData.left=!0))}}function Qe(e){e.preventDefault();var n=D.domElement.getBoundingClientRect();v.x=(e.clientX-n.left)/n.width*2-1,v.y=-((e.clientY-n.top)/n.height)*2+1,X.setFromCamera(v,u),je.forEach(i=>{i.geometry.computeBoundingBox();var o=i.geometry.boundingBox.clone();o.applyMatrix4(i.matrixWorld),X.ray.intersectBox(o,new y)})}function Ze(e){t.userData.right=!1,t.userData.left=!1,t.userData.canBoostStep=!0}function $e(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep&&_&&t.userData.onStartArea&&r.linvel().z<h[c].maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&!b&&r.applyImpulse({x:0,y:0,z:h[c].stepSpeed},!0),t.userData.canBoostStep=!1;break;case"KeyS":case"ArrowDown":t.userData.playerBraking=!0;break;case"KeyA":case"ArrowLeft":t.userData.left=!0;break;case"KeyD":case"ArrowRight":t.userData.right=!0,k.userData.body.applyImpulse({x:0,y:5,z:0},!0);break}}function et(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep=!0;break;case"KeyS":case"ArrowDown":r.linvel().y<.1&&(t.userData.playerBraking=!1);break;case"KeyA":case"ArrowLeft":t.userData.left=!1;break;case"KeyD":case"ArrowRight":t.userData.right=!1;break}}function B(e){let n,i;const o=e.rotation.clone();e.rotation.set(0,0,0);const a=new C().setFromObject(e).getSize(new y);e.rotation.copy(o),e.name.includes("player")?(t.userData.size=a,t.userData.orgRotation=o,n=p.createRigidBody(l.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),i=l.ColliderDesc.cuboid(a.x/5,a.y/1.5,a.z/3).setMass(e.userData.mass).setRestitution(0).setFriction(0),r=n,p.createCollider(i,n),S.push([e,n,e.id])):e.name.includes("ground")&&(n=p.createRigidBody(l.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),i=l.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),p.createCollider(i,n),S.push([e,n,e.id])),e.name.includes("wall")&&(n=p.createRigidBody(l.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0)),i=l.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(40),p.createCollider(i,n),S.push([e,n,e.id])),e.name.includes("itsmen_body")&&(n=p.createRigidBody(l.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!0).setLinearDamping(0).setAngularDamping(0)),i=l.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(1).setRestitution(0).setFriction(0).setDensity(2),k.userData.body=n,k.userData.collider=i,p.createCollider(i,n),S.push([e,n,e.id])),e.name.includes("itsmen_left_hand")&&(n=p.createRigidBody(l.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0).setAngularDamping(0)),i=l.ColliderDesc.capsule(a.z/2,a.x/10).setMass(1).setRestitution(0).setFriction(0).setDensity(20),A.userData.body=n,A.userData.collider=i,p.createCollider(i,n),S.push([e,n,e.id]))}document.addEventListener("visibilitychange",function(){document.visibilityState==="visible"?!b&&_&&(g.start(),g.elapsedTime=t.userData.time):!b&&_&&(t.userData.time=g.getElapsedTime(),g.stop())});
