import{C as j,S as xe,a as ve,F as be,H as ze,b as _e,D as ke,c as Le,A as Be,P as Ce,d as Ee,W as qe,e as Ae,V as h,R as ie,G as se,B as R}from"./three-C4_QSHiD.js";import{O as c}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();function J(e,n){e.geometry.computeBoundingBox(),n.forEach(function(a,s,ae){a.children.length>0?a.children.forEach(function(_,fe,Se){_.geometry.computeBoundingBox()}):a.geometry.computeBoundingBox()}),e.updateMatrixWorld(),n.forEach(function(a,s,ae){a.updateMatrixWorld()});let i=e.geometry.boundingBox.clone();i.applyMatrix4(e.matrixWorld);var o=!1;return n.forEach(function(a,s,ae){if(a.children.length>0)a.children.forEach(function(_,fe,Se){let oe=_.geometry.boundingBox.clone();oe.applyMatrix4(_.matrixWorld),i.intersectsBox(oe)&&(o=_)});else{let _=a.geometry.boundingBox.clone();_.applyMatrix4(a.matrixWorld),i.intersectsBox(_)&&(o=a)}}),o}function re(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}let O=document.querySelector(".main_load"),le=document.querySelector(".main_menu"),Te=document.querySelector(".select_level"),Re=document.querySelector(".select_tube"),Me=document.querySelector(".finish_window"),He=document.querySelector(".finish_you_time span"),Fe=document.querySelectorAll("body>.overlay"),Oe=document.querySelector(".startButton"),We=document.querySelectorAll(".load_level_wrap>div"),Ie=document.querySelectorAll(".load_level_wrap .level_time"),Ge=document.querySelectorAll(".load_tubes_wrap>div"),U=document.querySelector(".current_time"),de=document.querySelector(".best_time"),Ke=document.querySelector(".finish_again"),Ne=document.querySelector(".finish_in_menu"),ce=document.querySelector(".speed_block>.speed"),Pe=document.querySelector(".shadow_check"),W=document.querySelector(".load_percent"),V=document.querySelector(".pause_button"),je=document.querySelector(".close_pause_button"),Je=document.querySelector(".reset_button"),Ue=document.querySelector(".inmenu_button"),Ve=document.querySelector(".menu_in_game_wrap"),ue=document.querySelector(".start_time"),pe=document.querySelector(".start_time_wrap");We.forEach((e,n)=>{e.addEventListener("click",async()=>{E=n+1,w(O),await N(!1,!0),w(Re)})}),Ge.forEach((e,n)=>{e.addEventListener("click",()=>{d=n,w(0),X()})});function X(){I[d].position.copy(r.translation());let e=0;Y=!0;let n=setInterval(i=>{pe.classList.remove("hidden_block"),e++,e==4?(Y=!1,ue.textContent="GO",k=!0,V.classList.remove("hidden_block"),clearInterval(n),setTimeout(()=>{pe.classList.add("hidden_block")},600)):ue.textContent=4-e},1e3)}Oe.addEventListener("click",()=>{te=re(),te&&document.body.requestFullscreen().then(()=>{screen.orientation.lock("landscape")}),le.classList.add("hidden_block"),Te.classList.remove("hidden_block")});function w(e){Fe.forEach(n=>{n.classList.add("hidden_block")}),e!=0&&e.classList.remove("hidden_block")}Ke.addEventListener("click",async()=>{w(O),await P(),await N(!0,!0),w(0),X()}),Je.addEventListener("click",async()=>{await P(),await N(!0,!0),w(0),X()}),Ne.addEventListener("click",async()=>{w(O),await P(),await ne()}),Ue.addEventListener("click",async()=>{w(O),await P(),await ne()}),V.addEventListener("click",()=>{Y==!1&&k&&!v&&(w(Ve),t.userData.time=m.getElapsedTime(),m.stop(),q=!0)}),je.addEventListener("click",()=>{w(0),m.start(),m.elapsedTime=t.userData.time,q=!1}),Pe.onchange=function(){this.checked?(x.shadowMap.enabled=!0,l.traverse(e=>{e.material&&(e.material.needsUpdate=!0)})):(x.shadowMap.enabled=!1,l.traverse(e=>{e.material&&(e.material.needsUpdate=!0)}))};let p;performance.now();let Xe=[],E=0,q=!1,t,r,Y=!1,I=[],d=0,Q,M=[],Z,v;const g=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,maxSpeed:26,resetHAngle:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:10,maxSpeed:180,resetHAngle:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:3,maxSpeed:30,resetHAngle:!0}];let b=[],z=new h,$=new ie,k=!1,ee=!1,A,me,ye,L,T,H=[],D,te=re(),Ye=new j,m=new j,G=0,he=1/60,B=0,f=0,S;const we=new ie,Qe=new h(0,-1,0),l=new xe;l.background=new ve(14479094),l.fog=new be(l.background,1,300);const F=new ze(16777215,16777215,2);F.color.setHSL(.6,1,.6),F.groundColor.setHSL(.095,1,.75),F.position.set(0,100,0),new _e(F,10);const y=new ke(16777215,3);y.position.set(1,2,.2),y.position.multiplyScalar(120),y.castShadow=!0,y.shadow.mapSize.width=2048,y.shadow.mapSize.height=2048;const K=1e3;y.shadow.camera.left=-K,y.shadow.camera.right=K,y.shadow.camera.top=K,y.shadow.camera.bottom=-K,y.shadow.camera.far=3500,y.shadow.bias=-.001,new Le(y,10),new Be(11184810,1);const u=new Ce(75,window.innerWidth/window.innerHeight,.1,1e3);u.position.set(0,4,-10);let ge=new Ee;document.body.appendChild(ge.dom);const x=new qe;x.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(x.domElement),x.shadowMap.enabled=!0,x.shadowMap.type=Ae,window.addEventListener("resize",Ze,!1);function Ze(){u.aspect=window.innerWidth/window.innerHeight,u.updateProjectionMatrix(),x.setSize(window.innerWidth,window.innerHeight)}async function $e(){localStorage.getItem("playerData")?S=JSON.parse(localStorage.getItem("playerData")):(S={levelsTimes:{}},localStorage.setItem("playerData",JSON.stringify(S))),JSON.stringify(S),Ie.forEach((e,n,i)=>{S.levelsTimes["time"+(n+1)]!=null?e.childNodes[1].textContent=S.levelsTimes["time"+(n+1)]:e.childNodes[1].textContent=0})}async function et(){m=new j,l.add(y),l.add(F),f=0,await c.init(),p=new c.World(new c.Vector3(0,-9.81,0)),await new se().loadAsync("models/map-menu.glb",onprogress=n=>{W.textContent=Math.round(n.loaded/n.total*100)+"%"}).then(n=>{const i=n.scene;W.textContent="0",i.traverse(o=>{if(o.name=="player")t=o.clone(),t.userData.vertices=t.geometry.attributes.position.array,t.userData.indices=t.geometry.index.array,t.castShadow=!0,t.receiveShadow=!0,t.material.transparent=!0,t.material.opacity=0,t.userData.mass=1,t.userData.playerBraking=!1,t.userData.hTransition=0,t.userData.currentSpeed=0,t.userData.onStartArea=!0,t.userData.canBoostStep=!0,t.userData.time=0,t.userData.right=!1,t.userData.left=!1,t.userData.onGround=!1,t.userData.flying=!1,t.userData.origPosition=t.position,C(t),l.add(t);else if(o.name.includes("player-tube")){var a=o.clone();a.userData.startPosition=new h(a.position.x,a.position.y,a.position.z),I[o.name.slice(-1)-1]=a,l.add(a)}else if(o.name=="arrow_area")D=o.clone(),D.userData.hPos=0,l.add(D);else if(o.name.includes("ground"))new R().setFromObject(o).getSize(new h),A=o.clone(),A.receiveShadow=!0,A.userData.mass=0,C(A),H.push(A),l.add(A),o.name=="left_ground_wall"?me=o.position:o.name=="right_ground_wall"&&(ye=o.position);else if(o.name.includes("wall")){new R().setFromObject(o).getSize(new h);let s=o.clone();s.castShadow=!0,s.receiveShadow=!0,s.userData.mass=1,C(s),H.push(s),l.add(s)}else if(o.name.includes("area")){let s=o.clone();s.castShadow=!0,l.add(s)}else o.name.includes("start_flag")?(Q=o.clone(),l.add(Q)):o.name.includes("itsmen_body")?(L=o.clone(),l.add(L),C(L)):o.name.includes("itsmen_left_hand")&&(T=o.clone(),l.add(T),C(T))})}),l.traverse(function(n){n.material&&(n.material.needsUpdate=!0)}),await $e();let e=c.JointData.spherical({x:.3,y:.4,z:0},{x:0,y:-.4,z:0});p.createImpulseJoint(e,L.userData.body,T.userData.body,!0),ee=!0}async function tt(){v=!1;const e=new se,n="models/map"+E+".glb";await e.loadAsync(n,onprogress=i=>{W.textContent=Math.round(i.loaded/i.total*100)+"%"}).then(i=>{const o=i.scene;W.textContent="0",o.traverse(a=>{if(a.name.includes("ground")){new R().setFromObject(a).getSize(new h);let s=a.clone();s.receiveShadow=!0,s.userData.mass=0,s.name=a.name,C(s),H.push(s),l.add(s)}else if(a.name.includes("wall")){new R().setFromObject(a).getSize(new h);let s=a.clone();s.userData.mass=1,C(s),H.push(s),l.add(s)}else if(a.name.includes("area")){let s=a.clone();s.castShadow=!0,s.receiveShadow=!0,l.add(s),a.name.includes("star_area")&&M.push(s)}else a.name.includes("finish_block")&&(Z=a.clone(),l.add(Z))})}),de.textContent=S.levelsTimes["time"+E]}async function ne(){await N(!0,!1),w(le)}ne();async function N(e,n){e&&await et(),n&&await tt()}async function P(){for(k=!1,ee=!1,f=0,t.userData.time=0,V.classList.add("hidden_block"),m.start(),m.elapsedTime=t.userData.time,q=!1,t.userData.currentSpeed=0,ce.textContent=t.userData.currentSpeed,f=0,U.textContent=f;l.children.length>0;){let e=l.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(n=>n.dispose()):e.material.dispose()),l.remove(e)}v=!1}function nt(){if(performance.now(),ee&&!v&&(te?(u.lookAt(new h(u.position.x,t.position.y,t.position.z+5)),u.position.y=t.position.y+5,u.position.z=t.position.z-3):(u.lookAt(new h(u.position.x,t.position.y,t.position.z+5)),u.position.y=t.position.y+4,u.position.z=t.position.z-4),D.position.set(t.position.x,t.position.y,t.position.z+5)),k){v?w(Me):(f=m.getElapsedTime().toFixed(3),U.textContent=f,at(),M.forEach((e,n,i)=>{e.rotation.z+=.05}),J(t,M)&&(console.log(J(t,M)),l.remove(J(t,M)))),t.position.x>me.x-t.userData.size.x/1.3&&(D.position.x=t.position.x,t.userData.hTransition=-.4),t.position.x<ye.x+t.userData.size.x/1.3&&(D.position.x=t.position.x,t.userData.hTransition=.4),p.step(),I[d].position.copy(r.translation()),I[d].quaternion.copy(r.rotation());for(let e=0,n=b.length;e<n;e++)b[e][0].position.copy(b[e][1].translation()),b[e][0].quaternion.copy(b[e][1].rotation())}ge.update()}x.setAnimationLoop(()=>{G+=Ye.getDelta(),G>he&&!q&&(nt(),x.render(l,u),G=G%he)}),document.addEventListener("touchend",it),document.addEventListener("touchstart",De),document.addEventListener("touchmove",De),window.addEventListener("keydown",st),window.addEventListener("keyup",rt),document.addEventListener("mousedown",ot,!1);function at(){t.position.z>Z.position.z&&(f=m.getElapsedTime().toFixed(3),U.textContent=f,v=!0,He.textContent=f,S.levelsTimes["time"+E]!=null?B=S.levelsTimes["time"+E]:B=0,(f<B||B==0)&&(B=f,de.textContent=B,S.levelsTimes["time"+E]=B,localStorage.setItem("playerData",JSON.stringify(S))),t.position.z=0),D.position.x+=t.userData.hTransition;const e=new h().subVectors(r.translation(),D.position).normalize();D.lookAt(t.position.x,t.position.y,t.position.z),r.setRotation({w:D.quaternion.w,x:r.rotation().x,y:D.quaternion.y,z:r.rotation().z}),r.setLinvel({x:e.x*-g[d].hSpeed,y:r.linvel().y,z:r.linvel().z}),we.set(t.position,Qe);const n=we.intersectObjects(H);if(n.length>0&&(n[0].distance<.4?(t.userData.flying=!1,!t.userData.onGround&&t.userData.flying,t.userData.onGround=!0):(t.userData.onGround=!1,t.userData.flying=!0)),r.linvel().z>0?t.userData.currentSpeed=r.linvel().z.toFixed(0):t.userData.currentSpeed=0,ce.textContent=t.userData.currentSpeed,t.userData.left&&t.userData.onGround){t.userData.hTransition<5&&(t.userData.hTransition+=g[d].maxHSpeed);let i=r.linvel();i.z*=.9996,r.setLinvel(i,!0)}if(t.userData.right&&t.userData.onGround){t.userData.hTransition>-5&&(t.userData.hTransition-=g[d].maxHSpeed);let i=r.linvel();i.z*=.9996,r.setLinvel(i,!0)}g[d].resetHAngle&&!t.userData.left&&!t.userData.right&&(t.userData.hTransition<-g[d].maxHSpeed?t.userData.hTransition+=g[d].maxHSpeed:t.userData.hTransition>g[d].maxHSpeed?t.userData.hTransition-=g[d].maxHSpeed:t.userData.hTransition=0),t.position.z>Q.position.z?t.userData.onStartArea=!1:t.userData.onStartArea=!0}function De(e){if(t.userData.onGround){e=e.changedTouches[0];var n=x.domElement.getBoundingClientRect();z.x=(e.clientX-n.left)/n.width*2-1,z.y=-((e.clientY-n.top)/n.height)*2+1,$.setFromCamera(z,u),z.y>0&&t.userData.canBoostStep&&k&&t.userData.onStartArea&&r.linvel().z<g[d].maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&!v&&r.applyImpulse({x:0,y:0,z:g[d].stepSpeed},!0),t.userData.canBoostStep=!1,z.y<0&&(z.x>0?(t.userData.left=!1,t.userData.right=!0):(t.userData.right=!1,t.userData.left=!0))}}function ot(e){e.preventDefault();var n=x.domElement.getBoundingClientRect();z.x=(e.clientX-n.left)/n.width*2-1,z.y=-((e.clientY-n.top)/n.height)*2+1,$.setFromCamera(z,u),Xe.forEach(i=>{i.geometry.computeBoundingBox();var o=i.geometry.boundingBox.clone();o.applyMatrix4(i.matrixWorld),$.ray.intersectBox(o,new h)})}function it(e){t.userData.right=!1,t.userData.left=!1,t.userData.canBoostStep=!0}function st(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep&&k&&t.userData.onStartArea&&r.linvel().z<g[d].maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&!v&&r.applyImpulse({x:0,y:0,z:g[d].stepSpeed},!0),t.userData.canBoostStep=!1;break;case"KeyS":case"ArrowDown":t.userData.playerBraking=!0;break;case"KeyA":case"ArrowLeft":t.userData.left=!0;break;case"KeyD":case"ArrowRight":t.userData.right=!0,L.userData.body.applyImpulse({x:0,y:5,z:0},!0);break}}function rt(e){switch(e.code){case"KeyW":case"ArrowUp":t.userData.canBoostStep=!0;break;case"KeyS":case"ArrowDown":r.linvel().y<.1&&(t.userData.playerBraking=!1);break;case"KeyA":case"ArrowLeft":t.userData.left=!1;break;case"KeyD":case"ArrowRight":t.userData.right=!1;break}}function C(e){let n,i;const o=e.rotation.clone();e.rotation.set(0,0,0);const a=new R().setFromObject(e).getSize(new h);e.rotation.copy(o),e.name.includes("player")?(t.userData.size=a,t.userData.orgRotation=o,n=p.createRigidBody(c.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),i=c.ColliderDesc.cuboid(a.x/5,a.y/1.5,a.z/3).setMass(e.userData.mass).setRestitution(0).setFriction(0),r=n,p.createCollider(i,n),b.push([e,n,e.id])):e.name.includes("ground")&&(n=p.createRigidBody(c.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),i=c.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),p.createCollider(i,n),b.push([e,n,e.id])),e.name.includes("wall")&&(n=p.createRigidBody(c.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0)),i=c.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(40),p.createCollider(i,n),b.push([e,n,e.id])),e.name.includes("itsmen_body")&&(n=p.createRigidBody(c.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!0).setLinearDamping(0).setAngularDamping(0)),i=c.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(0).setRestitution(0).setFriction(0).setDensity(2),L.userData.body=n,L.userData.collider=i,p.createCollider(i,n),b.push([e,n,e.id])),e.name.includes("itsmen_left_hand")&&(n=p.createRigidBody(c.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0).setAngularDamping(0)),i=c.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),T.userData.body=n,T.userData.collider=i,p.createCollider(i,n),b.push([e,n,e.id]))}document.addEventListener("visibilitychange",function(){document.visibilityState==="visible"?!v&&k&&q==!1&&(m.start(),m.elapsedTime=t.userData.time):q==!1&&!v&&k&&(t.userData.time=m.getElapsedTime(),m.stop())});
