import{C as he,S as Ze,a as et,F as tt,H as nt,b as ot,D as at,c as st,A as it,P as rt,W as lt,G as Ae,V as x,B as W,R as _e,d as ct,e as dt,f as te}from"./three-Dhj7f3wh.js";import{O as p}from"./@dimforge-D3Mqfikn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))o(l);new MutationObserver(l=>{for(const a of l)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(l){const a={};return l.integrity&&(a.integrity=l.integrity),l.referrerPolicy&&(a.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?a.credentials="include":l.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(l){if(l.ep)return;l.ep=!0;const a=t(l);fetch(l.href,a)}})();function Ee(){let e=window.matchMedia||window.msMatchMedia;return e?e("(pointer:coarse)").matches:!1}function ut(e){const t=Math.floor(e),o=Math.round((e-t)*1e3);return t*1e3+o}let K=document.querySelector(".main_load"),Re=document.querySelector(".main_menu"),Te=document.querySelector(".select_level"),ge=document.querySelectorAll(".select_level .level_shadow"),pt=document.querySelector(".select_tube"),mt=document.querySelector(".finish_window"),yt=document.querySelector(".finish_you_time .finish_you_time_time"),Ie=document.querySelector(".boom_window"),ne=document.querySelector(".main_record"),ht=document.querySelectorAll("body>.overlay"),_t=document.querySelector(".startButton"),gt=document.querySelectorAll(".load_level_wrap>div"),St=document.querySelectorAll(".load_level_wrap .level_time"),Be=document.querySelectorAll(".load_tubes_wrap>div"),oe=document.querySelectorAll(".language_block>img"),Me=[],Fe=[],Pe=document.querySelector(".times"),Se=document.querySelector(".current_time"),He=document.querySelector(".best_time"),Dt=document.querySelector(".finish_window .finish_again"),bt=document.querySelector(".finish_window .finish_in_menu"),ft=document.querySelector(".boom_window .finish_again"),wt=document.querySelector(".boom_window .finish_in_menu"),Oe=document.querySelector(".speed_block"),Ge=document.querySelector(".speed_block>.speed"),xt=document.querySelector(".instr_check"),ae=document.querySelector(".load_percent");document.querySelector(".records_wrap");let De=document.querySelector(".pause_button_wrap"),vt=document.querySelector(".close_pause_button"),qt=document.querySelector(".reset_button"),Ct=document.querySelector(".inmenu_button"),Lt=document.querySelector(".before_start"),zt=document.querySelector(".instruction_start_btn"),kt=document.querySelector(".menu_in_game_wrap"),Je=document.querySelector(".start_time"),Ne=document.querySelector(".start_time_wrap"),be=document.querySelector(".audio_button");oe.forEach((e,t)=>{e.addEventListener("click",()=>{m.language!=t&&(oe.forEach(o=>{o.classList.remove("selected")}),e.classList.add("selected"),m.language=t,localStorage.setItem("playerData",JSON.stringify(m)),je(m.language))})});function je(e){e==0?(document.querySelector(".title_game").src="./images/title.png",document.querySelector(".startgame_title").textContent="\u043D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".language_title").textContent="\u042F\u0437\u044B\u043A:",document.querySelectorAll(".level_text h2>span").forEach(t=>{t.textContent="\u0423\u0440\u043E\u0432\u0435\u043D\u044C"}),document.querySelectorAll(".leveltime_title").forEach(t=>{t.textContent="\u0412\u0440\u0435\u043C\u044F: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(t=>{t.textContent="\u0422\u044E\u0431\u0438\u043D\u0433"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(t=>{t.textContent="\u0421\u043A\u043E\u0440\u043E\u0441\u0442\u044C: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(t=>{t.textContent="\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435: "}),document.querySelector(".selecttubedesc_title").textContent="\u041F\u0440\u043E\u0445\u043E\u0434\u0438\u0442\u0435 \u0443\u0440\u043E\u0432\u043D\u0438, \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0442\u044E\u0431\u0438\u043D\u0433\u0438",document.querySelector(".menu_in_game_wrap_head").textContent="\u041F\u0430\u0443\u0437\u0430",document.querySelector(".close_pause_button").textContent="\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0438\u0433\u0440\u0443",document.querySelector(".reset_button").textContent="\u041D\u0430\u0447\u0430\u0442\u044C \u0437\u0430\u043D\u043E\u0432\u043E",document.querySelector(".inmenu_button").textContent="\u0412\u044B\u0439\u0442\u0438",document.querySelector(".finish_you_time_title").textContent="\u0412\u0430\u0448\u0435 \u0432\u0440\u0435\u043C\u044F: ",document.querySelector(".crash_title").textContent="\u0412\u044B \u0432\u0440\u0435\u0437\u0430\u043B\u0438\u0441\u044C",document.querySelector(".finish_title").textContent="\u0412\u044B \u043F\u0440\u0438\u0435\u0445\u0430\u043B\u0438",document.querySelectorAll(".finish_again").forEach(t=>{t.textContent="\u0415\u0449\u0435 \u0440\u0430\u0437"}),document.querySelectorAll(".finish_in_menu").forEach(t=>{t.textContent="\u0412\u044B\u0431\u043E\u0440 \u0443\u0440\u043E\u0432\u043D\u044F"}),document.querySelector(".current_time_title").textContent="\u0412\u0440\u0435\u043C\u044F",document.querySelector(".best_time_title").textContent="\u041B\u0443\u0447\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F",document.querySelector(".speed_title").textContent="\u041A\u041C/\u0427",document.querySelector(".instruction_start_btn").textContent="\u0421\u0422\u0410\u0420\u0422",document.querySelector(".instr-disabled span").textContent="\u0411\u043E\u043B\u044C\u0448\u0435 \u043D\u0435 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0442\u044C",document.querySelector(".desktop_instr").innerHTML=`<h2>\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435</h2>
    <span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 <span class='button_active'>W</span> \u0438\u043B\u0438 <span class='button_active'>\u2191</span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041A\u043B\u0430\u0432\u0438\u0448\u0430\u043C\u0438 <span>\u2190</span> <span>\u2192</span> \u0438\u043B\u0438 <span>A</span> <span>D</span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>
    <span>\u0426\u0435\u043B\u044C - \u0434\u043E\u0435\u0445\u0430\u0442\u044C \u0434\u043E \u0444\u0438\u043D\u0438\u0448\u0430 \u0437\u0430 \u043A\u0440\u0430\u0442\u0447\u0430\u0439\u0448\u0435\u0435 \u0432\u0440\u0435\u043C\u044F</span>`,document.querySelector(".mobile_instr div").innerHTML=`<span>\u0411\u044B\u0441\u0442\u0440\u043E \u043D\u0430\u0436\u0438\u043C\u0430\u0439\u0442\u0435 \u043D\u0430 \u0437\u043E\u043D\u0443 <span> \u2191 </span> \u0447\u0442\u043E\u0431\u044B \u0440\u0430\u0437\u043E\u0433\u043D\u0430\u0442\u044C\u0441\u044F \u0434\u043E \u0441\u0442\u0430\u0440\u0442\u043E\u0432\u043E\u0439 \u043E\u0442\u043C\u0435\u0442\u043A\u0438</span>
    <span>\u041D\u0430\u0436\u0438\u043C\u0430\u044F \u043D\u0430 \u0437\u043E\u043D\u044B <span> \u2190 </span> \u0438 <span> \u2192 </span> \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0439\u0442\u0435 \u0442\u044E\u0431\u0438\u043D\u0433\u043E\u043C</span>`,document.querySelector(".sci-fi-loader strong").textContent="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430",document.querySelector(".main_record_title").textContent="\u041E\u0431\u0449\u0435\u0435 \u0432\u0440\u0435\u043C\u044F: ",(T=0)&&(document.querySelector(".main_record").textContent="\u041F\u0440\u043E\u0439\u0434\u0438\u0442\u0435 \u0432\u0441\u0435 \u0443\u0440\u043E\u0432\u043D\u0438, \u0447\u0442\u043E\u0431\u044B \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u043E\u0431\u0449\u0438\u0439 \u0440\u0435\u043A\u043E\u0440\u0434")):(document.querySelector(".title_game").src="./images/title-en.png",document.querySelector(".startgame_title").textContent="start game",document.querySelector(".language_title").textContent="Language:",document.querySelectorAll(".level_text h2>span").forEach(t=>{t.textContent="Level"}),document.querySelectorAll(".leveltime_title").forEach(t=>{t.textContent="Time: "}),document.querySelectorAll(".load_tubes_wrap .selecttube_title").forEach(t=>{t.textContent="Tubing"}),document.querySelectorAll(".load_tubes_wrap .selecttubespeed_title").forEach(t=>{t.textContent="Speed: "}),document.querySelectorAll(".load_tubes_wrap .selecttubecontrol_title").forEach(t=>{t.textContent="Control: "}),document.querySelector(".selecttubedesc_title").textContent="Complete the levels to unlock the tubings",document.querySelector(".menu_in_game_wrap_head").textContent="Pause",document.querySelector(".close_pause_button").textContent="Continue",document.querySelector(".reset_button").textContent="Start again",document.querySelector(".inmenu_button").textContent="Exit to levels",document.querySelector(".finish_you_time_title").textContent="You time: ",document.querySelector(".crash_title").textContent="You crashed",document.querySelector(".finish_title").textContent="You finished",document.querySelectorAll(".finish_again").forEach(t=>{t.textContent="Again"}),document.querySelectorAll(".finish_in_menu").forEach(t=>{t.textContent="Select Level"}),document.querySelector(".current_time_title").textContent="Time",document.querySelector(".best_time_title").textContent="Best time",document.querySelector(".speed_title").textContent="KM/H",document.querySelector(".instruction_start_btn").textContent="START",document.querySelector(".instr-disabled span").textContent="Don't show again",document.querySelector(".desktop_instr").innerHTML=`<h2>Instructions</h2>
    <span>Quickly press <span class='button_active'>W</span> or <span class='button_active'>\u2191</span> to accelerate to the starting point</span>
    <span>Use <span>\u2190</span> <span>\u2192</span> or <span>A</span> <span>D</span> keys to control the tubing</span>
    <span>The goal is to reach the finish line in the shortest time</span>`,document.querySelector(".mobile_instr div").innerHTML=`<span>Quickly press on zone <span> \u2191 </span> to accelerate to the starting point</span>
    <span>By taps on zones <span> \u2190 </span> and <span> \u2192 </span> control the tubing</span>`,document.querySelector(".sci-fi-loader strong").textContent="Loading ",document.querySelector(".main_record_title").textContent="Total time: ",(T=0)&&(document.querySelector(".main_record").textContent="Complete all the levels to keep the overall record"))}gt.forEach((e,t)=>{e.addEventListener("click",async()=>{t+1<=ke&&(J=t+1,Be.forEach((o,l)=>{h[l].levels.includes(J)?(o.classList.remove("disabledTube"),h[l].canInLevel=!0):(o.classList.add("disabledTube"),h[l].canInLevel=!1)}),S(K),await ee(!1,!0),S(pt))})}),Be.forEach((e,t)=>{e.addEventListener("click",()=>{h[t].canInLevel&&(_=t,S(0),X())})});function X(){if(!m.canStart)S(Lt),H?document.querySelector(".mobile_instr").classList.remove("hidden_instr"):document.querySelector(".desktop_instr").classList.remove("hidden_instr");else{Pe.classList.remove("hidden_block"),Oe.classList.remove("hidden_block"),ie[_].position.copy(r.translation());let e=0;xe=!0,H&&document.querySelector(".instr-mobile-ingame").classList.remove("hidden_block"),H&&document.querySelector(".anim_tap").classList.remove("hidden_block");let t=setInterval(o=>{b!=null&&!b.isPlaying&&z&&!re&&b.play(),Ne.classList.remove("hidden_block"),re||e++,e==2&&H&&(document.querySelector(".instr-mobile-ingame").classList.add("hidden_block"),document.querySelector(".anim_tap").classList.add("hidden_block")),e==4?(b==null||b.stop(2.5),xe=!1,Je.textContent="GO",I=!0,De.classList.remove("hidden_block"),clearInterval(t),ysdk.features.GameplayAPI.start(),setTimeout(()=>{Ne.classList.add("hidden_block")},600)):Je.textContent=4-e},1e3)}}zt.addEventListener("click",()=>{m.canStart=!0,S(0),X()}),be.addEventListener("click",()=>{z==!0?(be.classList.add("audio_off"),d!=null&&d.isPlaying&&d.stop(),c!=null&&c.isPlaying&&c.stop(),b!=null&&b.isPlaying&&b.stop(),z=!1):(be.classList.remove("audio_off"),d!=null&&!d.isPlaying&&d.play(),r.linvel().z>3&&n.userData.onGround&&!F&&(c==null||c.play()),z=!0)}),_t.addEventListener("click",()=>{H=Ee(),document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),d!=null&&z&&d.play(),H&&document.body.requestFullscreen().then(()=>{screen.orientation.lock("landscape")}),Re.classList.add("hidden_block"),Te.classList.remove("hidden_block")});function S(e){ht.forEach(t=>{t.classList.add("hidden_block")}),e!=0&&e.classList.remove("hidden_block")}Dt.addEventListener("click",async()=>{S(K),await $(),await ee(!0,!0),S(0),X()}),ft.addEventListener("click",async()=>{S(K),await $(),await ee(!0,!0),S(0),X()}),qt.addEventListener("click",async()=>{await $(),await ee(!0,!0),S(0),X()}),bt.addEventListener("click",async()=>{S(K),await $(),await ye(),ysdk.adv.showFullscreenAdv({callbacks:{onOpen:function(e){d!=null&&d.isPlaying&&d.stop()},onClose:function(e){d!=null&&!d.isPlaying&&d.play()},onError:function(e){}}})}),wt.addEventListener("click",async()=>{S(K),await $(),await ye()}),Ct.addEventListener("click",async()=>{S(K),await $(),await ye()}),De.addEventListener("click",()=>{var e;xe==!1&&I&&!k&&((e=ysdk.features.GameplayAPI)==null||e.stop(),S(kt),n.userData.time=L.getElapsedTime(),L.stop(),document.querySelector(".audio_button_wrap").classList.add("hidden_block"),c==null||c.stop(),d==null||d.stop(),F=!0)}),vt.addEventListener("click",()=>{var e;S(0),L.start(),L.elapsedTime=n.userData.time,document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),z&&(d==null||d.play()),r.linvel().z>3&&n.userData.onGround&&z&&(c==null||c.play()),F=!1,(e=ysdk.features.GameplayAPI)==null||e.start()}),xt.onchange=function(){this.checked?(m.canStart=!0,localStorage.setItem("playerData",JSON.stringify(m))):(m.canStart=!1,localStorage.setItem("playerData",JSON.stringify(m)))};let y,fe=!0;performance.now();let J=0,F=!1,z=!0,T=0,se=0,We,Ke=!1,n,r,we,xe=!1,ie=[],_=0,P,ve,re=!1,qe,k;const h=[{hSpeed:10,maxHSpeed:.08,stepSpeed:1,nowSpeed:0,maxSpeed:26,resetHAngle:!1,levels:[1,2,3,4,5,6,7,8,9],canInLevel:!1},{hSpeed:12,maxHSpeed:.1,stepSpeed:2,nowSpeed:0,maxSpeed:38,resetHAngle:!1,levels:[4,5,6,7,8,9],canInLevel:!1},{hSpeed:14,maxHSpeed:.12,stepSpeed:2,nowSpeed:0,maxSpeed:44,resetHAngle:!0,levels:[7,8,9],canInLevel:!1}];let c,d,A,b,Ve,v=[],V=new x,At=new _e,I=!1,Ce=!1,U,Ue,Ye,g,B,M,q,C,le,ce,de,Y,Q,Le,N=[],ue=[],ze=[],f,H=Ee(),Et=new he,L=new he,pe=0,Qe=1/60,j=0,E=0,ke=2,m;const $e=new _e,Rt=new x(0,-1,0),u=new Ze;u.background=new et(14479094),u.fog=new tt(u.background,1,300);const Z=new nt(16777215,16777215,2);Z.color.setHSL(.6,1,.6),Z.groundColor.setHSL(.095,1,.75),Z.position.set(0,100,0),new ot(Z,10);const me=new at(16777215,3);me.position.set(1,2,.2),me.position.multiplyScalar(120),new st(me,10),new it(11184810,1);const w=new rt(85,document.body.offsetWidth/document.body.offsetHeight,.1,310);w.position.set(0,4,-10);const O=new lt({antialias:!0});O.setSize(document.body.offsetWidth,document.body.offsetHeight),document.body.appendChild(O.domElement),O.shadowMap.enabled=!1,window.addEventListener("resize",Tt,!1);function Tt(){H?(w.aspect=document.body.offsetWidth/document.body.offsetHeight,w.updateProjectionMatrix(),O.setSize(innerWidth,innerHeight)):(w.aspect=document.body.offsetWidth/document.body.offsetHeight,w.updateProjectionMatrix(),O.setSize(document.body.offsetWidth,document.body.offsetHeight))}async function It(){localStorage.getItem("playerData")?(m=JSON.parse(localStorage.getItem("playerData")),oe.forEach(e=>{e.classList.remove("selected")}),oe[m.language].classList.add("selected"),je(m.language),se=Object.keys(m.levelsTimes).length,se==ge.length&&(T=0,Object.values(m.levelsTimes).forEach(e=>{T+=parseFloat(e)}),ne.textContent=T.toFixed(3),ne.classList.add("main_record_green"))):(m={levelsTimes:{},canStart:!1,language:0},localStorage.setItem("playerData",JSON.stringify(m))),JSON.stringify(m),ke=0,ge.forEach((e,t)=>{t<Object.keys(m.levelsTimes).length+2&&(ke++,e.classList.remove("level_disabled"))}),St.forEach((e,t,o)=>{m.levelsTimes["time"+(t+1)]!=null?e.childNodes[2].textContent=m.levelsTimes["time"+(t+1)]:e.childNodes[2].textContent="00.000"})}async function Bt(){L=new he,u.add(me),u.add(Z),E=0,await p.init(),y=new p.World(new p.Vector3(0,-9.81,0)),await new Ae().loadAsync("models/map-menu.glb",onprogress=i=>{console.log(`Loaded: ${i.loaded}, Total: ${i.total}`);let D=Math.min(Math.round(i.loaded/i.total*100),100);ae.textContent=D+"%"}).then(i=>{const D=i.scene;ae.textContent="0",D.traverse(s=>{if(s.name=="player")n=s.clone(),n.userData.vertices=n.geometry.attributes.position.array,n.userData.indices=n.geometry.index.array,n.material.transparent=!0,n.material.opacity=0,n.userData.mass=1,n.userData.playerBraking=!1,n.userData.hTransition=0,n.userData.currentSpeed=0,n.userData.boom=!1,n.userData.onStartArea=!0,n.userData.canBoostStep=!0,n.userData.time=0,n.userData.right=!1,n.userData.left=!1,n.userData.onGround=!1,n.userData.flying=!1,n.userData.origPosition=n.position,R(n),u.add(n);else if(s.name.includes("player-tube"))P=s.clone(),P.userData.startPosition=new x(P.position.x,P.position.y,P.position.z),ie[s.name.slice(-1)-1]=P,u.add(P);else if(s.name=="arrow_area")f=s.clone(),f.userData.hPos=0,u.add(f);else if(s.name.includes("ground"))new W().setFromObject(s).getSize(new x),U=s.clone(),U.userData.mass=0,R(U),N.push(U),u.add(U),s.name=="left_ground_wall"?Ue=s.position:s.name=="right_ground_wall"&&(Ye=s.position);else if(s.name.includes("wall")){new W().setFromObject(s).getSize(new x);let G=s.clone();G.userData.mass=1,R(G),N.push(G),ue.push(G),u.add(G)}else if(s.name.includes("area")){let G=s.clone();u.add(G)}else s.name.includes("start_flag")?(ve=s.clone(),u.add(ve)):s.name.includes("itsmen_body")?(g=s.clone(),g.material.transparent=!0,g.material.opacity=0,u.add(g),R(g)):s.name.includes("itsmen_left_hand")?(B=s.clone(),B.material.transparent=!0,B.material.opacity=0,u.add(B),R(B)):s.name.includes("itsmen_right_hand")?(M=s.clone(),M.material.transparent=!0,M.material.opacity=0,u.add(M),R(M)):s.name.includes("itsmen_left_leg")?(q=s.clone(),q.material.transparent=!0,q.material.opacity=0,u.add(q),R(q)):s.name.includes("itsmen_right_leg")?(C=s.clone(),C.material.transparent=!0,C.material.opacity=0,u.add(C),R(C)):s.name.includes("qmen_body")?(le=s.clone(),u.add(le)):s.name.includes("qmen_left_hand")?(ce=s.clone(),u.add(ce)):s.name.includes("qmen_right_hand")?(de=s.clone(),u.add(de)):s.name.includes("qmen_left_leg")?(Y=s.clone(),u.add(Y)):s.name.includes("qmen_right_leg")&&(Q=s.clone(),u.add(Q))})}),u.traverse(function(i){i.material&&(i.material.needsUpdate=!0)}),await It();let e=p.JointData.spherical({x:.2,y:0,z:-.2},{x:-.4,y:0,z:0});y.createImpulseJoint(e,g.userData.body,B.userData.body,!0);let t=p.JointData.spherical({x:-.2,y:0,z:-.2},{x:.4,y:0,z:0});y.createImpulseJoint(t,g.userData.body,M.userData.body,!0);let o=p.JointData.spherical({x:.22,y:0,z:.5},{x:0,y:0,z:-.5});y.createImpulseJoint(o,g.userData.body,q.userData.body,!0);let l=p.JointData.spherical({x:-.22,y:0,z:.5},{x:0,y:0,z:-.5});y.createImpulseJoint(l,g.userData.body,C.userData.body,!0);let a=p.JointData.spherical({x:0,y:0,z:0},{x:0,y:.3,z:0});Le=y.createImpulseJoint(a,g.userData.body,r,!0),Ce=!0}async function Mt(){k=!1;const e=new Ae,t="models/map"+J+".glb";await e.loadAsync(t,onprogress=o=>{let l=Math.min(Math.round(o.loaded/o.total*100),100);ae.textContent=l+"%"}).then(o=>{const l=o.scene;ae.textContent="0",l.traverse(a=>{if(a.name.includes("ground")){new W().setFromObject(a).getSize(new x);let i=a.clone();i.userData.mass=0,i.name=a.name,R(i),N.push(i),u.add(i)}else if(a.name.includes("wall")){new W().setFromObject(a).getSize(new x);let i=a.clone();i.userData.mass=1,R(i),N.push(i),ue.push(i),u.add(i)}else if(a.name.includes("moving_block")){const i=new W().setFromObject(a).getSize(new x);let D=a.clone();D.userData.size=i,D.userData.mass=1,D.userData.raycaster=new _e,D.userData.speed=-a.name.substr(a.name.indexOf("speed")+6),D.userData.direction=new x(D.userData.speed,0,0),Me.push(D),R(D),ue.push(D),u.add(D)}else if(a.name.includes("area")){let i=a.clone();u.add(i)}else a.name.includes("finish_block")&&(qe=a.clone(),u.add(qe))})}),He.textContent=m.levelsTimes["time"+J]}async function Ft(){const e=new ct;n.add(e);const t=new dt;await t.loadAsync("audio/slide.mp3").then(o=>{c=new te(e),c.setBuffer(o),c.setLoop(!0),c.setRefDistance(40),c.setVolume(.7),n.add(c)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await t.loadAsync("audio/around.mp3").then(o=>{d=new te(e),d.setBuffer(o),d.setLoop(!0),d.setRefDistance(40),d.setVolume(1),d.error=!1,n.add(d)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await t.loadAsync("audio/boom1.mp3").then(o=>{A=new te(e),A.setBuffer(o),A.setLoop(!1),A.setRefDistance(40),A.setVolume(.9),A.error=!1,n.add(A)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)}),await t.loadAsync("audio/bip.mp3").then(o=>{b=new te(e),b.setBuffer(o),b.setLoop(!1),b.setRefDistance(40),b.setVolume(.7),b.error=!1,n.add(b)}).catch(o=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0430\u0443\u0434\u0438\u043E:",o)})}async function ye(){await ee(!0,!1),fe?(S(Re),YaGames.init().then(e=>{var t;(t=e.features.LoadingAPI)==null||t.ready(),e.getLeaderboards().then(o=>{We=o,o.getLeaderboardEntries("main",{quantityTop:3,includeUser:!0,quantityAround:0}).then(l=>{console.log(l),l.entries.forEach((a,i)=>{document.querySelector(".records_wrap").innerHTML=document.querySelector(".records_wrap").innerHTML+"<p>"+parseInt(i+1)+". "+a.score+"<p/>"})})}),e.isAvailableMethod("leaderboards.setLeaderboardScore").then(o=>{Ke=o}),e.isAvailableMethod("leaderboards.getLeaderboardPlayerEntry").then(o=>{})}),fe=!1):S(Te)}ye();async function ee(e,t){e&&await Bt(),t&&await Mt(),fe&&Ft()}async function $(){for(I=!1,Ce=!1,E=0,n.userData.time=0,n.userData.boom=!1,h.forEach(e=>{e.nowSpeed=0}),N=[],ue=[],v=[],De.classList.add("hidden_block"),Pe.classList.add("hidden_block"),Oe.classList.add("hidden_block"),document.querySelector(".audio_button_wrap").classList.remove("hidden_block"),L.start(),L.elapsedTime=n.userData.time,F=!1,n.userData.currentSpeed=0,Ge.textContent=n.userData.currentSpeed,E=0,Se.textContent=E;u.children.length>0;){let e=u.children[0];e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()),u.remove(e)}k=!1}function Pt(){if(Ce&&!k&&(c!=null&&z&&(r.linvel().z>3&&n.userData.onGround?c.isPlaying||c.play():c.isPlaying&&c.stop()),H?n.userData.boom?(w.lookAt(g.position),c==null||c.stop()):(w.lookAt(new x(w.position.x,n.position.y,n.position.z+5)),w.position.y=n.position.y+5,w.position.z=n.position.z-3):n.userData.boom?(P.position.y>0&&w.lookAt(g.position),c==null||c.stop()):(w.lookAt(new x(w.position.x,n.position.y,n.position.z+5)),w.position.y=n.position.y+4,w.position.z=n.position.z-4),f.position.set(n.position.x,n.position.y,n.position.z+5)),I){k?(S(mt),c==null||c.stop()):(E=L.getElapsedTime().toFixed(3),Se.textContent=E,Ot(),Ht()),n.position.x>Ue.x-n.userData.size.x/1.3&&(f.position.x=n.position.x,n.userData.hTransition=-.4),n.position.x<Ye.x+n.userData.size.x/1.3&&(f.position.x=n.position.x,n.userData.hTransition=.4);let e=new p.EventQueue(!0);y.step(e),ie[_].position.copy(r.translation()),ie[_].quaternion.copy(r.rotation()),le.position.copy(g.position),le.rotation.copy(g.rotation),ce.position.copy(B.position),ce.rotation.copy(B.rotation),de.position.copy(M.position),de.rotation.copy(M.rotation),Y.position.copy(q.position),Y.rotation.copy(q.rotation),Q.position.copy(C.position),Q.rotation.copy(C.rotation);for(let t=0,o=v.length;t<o;t++)v[t][0].position.copy(v[t][1].translation()),v[t][0].quaternion.copy(v[t][1].rotation());e.drainCollisionEvents((t,o,l)=>{ze.forEach((a,i)=>{var D,s;r.handle==t&&a.handle==o&&!k?r.linvel().z<15&&n.userData.boom==!1&&(A!=null&&z&&A.play(),y.removeImpulseJoint(Le),g.userData.body.applyImpulse({x:5,y:5,z:5},!0),g.userData.body.setEnabledRotations(!0),we.setFriction(20),setTimeout(()=>{I=!1,S(Ie)},3e3),(D=ysdk.features.GameplayAPI)==null||D.stop(),n.userData.boom=!0):r.handle==t&&!k&&r.linvel().z<15&&n.position.y<5&&n.userData.boom==!1&&(A!=null&&z&&A.play(),y.removeImpulseJoint(Le),g.userData.body.applyImpulse({x:5,y:5,z:5},!0),g.userData.body.setEnabledRotations(!0),we.setFriction(20),(s=ysdk.features.GameplayAPI)==null||s.stop(),n.userData.boom=!0,setTimeout(()=>{I=!1,S(Ie)},3e3))})})}}O.setAnimationLoop(()=>{pe+=Et.getDelta(),pe>Qe&&!F&&(Pt(),O.render(u,w),pe=pe%Qe)}),document.addEventListener("touchend",Gt),document.addEventListener("touchstart",Xe),document.addEventListener("touchmove",Xe),window.addEventListener("keydown",Jt),window.addEventListener("keyup",Nt);function Ht(){Me.forEach((e,t)=>{let o=e,l=Fe[t];l.setLinvel(o.userData.direction,!0),l.setAngvel({x:o.userData.direction.z,y:o.userData.direction.y,z:-o.userData.direction.x},!0);const a=o.userData.direction;o.userData.raycaster.set(new x(o.position.x,.4,o.position.z),a.clone().normalize());const i=o.userData.raycaster.intersectObjects(N);i.length>0&&i[0].distance<o.userData.size.x/2&&(o.userData.direction.x=o.userData.direction.x*-1)})}function Ot(){var a;n.position.z>qe.position.z&&!n.userData.boom&&(E=L.getElapsedTime().toFixed(3),Se.textContent=E,k=!0,(a=ysdk.features.GameplayAPI)==null||a.stop(),yt.textContent=E,m.levelsTimes["time"+J]!=null?j=m.levelsTimes["time"+J]:j=0,(E<j||j==0)&&(j=E,He.textContent=j,m.levelsTimes["time"+J]=j,se=Object.keys(m.levelsTimes).length,se==ge.length&&(T=0,Object.values(m.levelsTimes).forEach(i=>{T+=parseFloat(i)}),ne.textContent=T.toFixed(3),ne.classList.add("main_record_green"),Ke&&(We.setLeaderboardScore("main",ut(T.toFixed(3))),console.log("setNewRec")),console.log("mainRecord "+T.toFixed(3))),localStorage.setItem("playerData",JSON.stringify(m))),n.position.z=0),f.position.x+=n.userData.hTransition;const e=new x().subVectors(r.translation(),f.position).normalize(),t=r.linvel(),o=new x(e.x*-h[_].hSpeed,t.y,e.z*-h[_].nowSpeed);r.translation().y<100&&r.translation().y>=20&&(h[_].nowSpeed+=.05,r.rotation().x<.04&&r.setRotation({w:r.rotation().w,x:.04,y:r.rotation().y,z:r.rotation().z})),r.translation().y<20&&r.translation().y>1&&r.lockRotations(!0,!0,!0,!0),r.setLinvel(o,!0),f.lookAt(f.position.x-(n.position.x-f.position.x),f.position.y-(n.position.y-f.position.y),f.position.z-(n.position.z-f.position.z)),r.setRotation({w:f.quaternion.w,x:r.rotation().x,y:f.quaternion.y,z:r.rotation().z}),g.userData.body.setRotation({w:f.quaternion.w,x:r.rotation().x,y:f.quaternion.y,z:r.rotation().z}),(Y.rotation.y>0||Y.rotation.y<0)&&q.userData.body.setRotation({w:q.userData.body.rotation().w,x:q.userData.body.rotation().x,y:0,z:q.userData.body.rotation().z}),(Q.rotation.y>0||Q.rotation.y<0)&&C.userData.body.setRotation({w:C.userData.body.rotation().w,x:C.userData.body.rotation().x,y:0,z:C.userData.body.rotation().z}),$e.set(n.position,Rt);const l=$e.intersectObjects(N);l.length>0&&(l[0].distance<.4?(n.userData.flying=!1,n.userData.onGround=!0):(n.userData.onGround=!1,n.userData.flying=!0)),r.linvel().z>0?n.userData.currentSpeed=r.linvel().z.toFixed(0):n.userData.currentSpeed=0,Ge.textContent=n.userData.currentSpeed,n.userData.left&&n.userData.onGround&&!n.userData.onStartArea&&(n.userData.hTransition<5&&(n.userData.hTransition+=h[_].maxHSpeed),h[_].nowSpeed-=.009),n.userData.right&&n.userData.onGround&&!n.userData.onStartArea&&(n.userData.hTransition>-5&&(n.userData.hTransition-=h[_].maxHSpeed),h[_].nowSpeed-=.009),h[_].resetHAngle&&!n.userData.left&&!n.userData.right&&(n.userData.hTransition<-h[_].maxHSpeed?n.userData.hTransition+=h[_].maxHSpeed:n.userData.hTransition>h[_].maxHSpeed?n.userData.hTransition-=h[_].maxHSpeed:n.userData.hTransition=0),n.position.z>ve.position.z?n.userData.onStartArea=!1:n.userData.onStartArea=!0}function Xe(e){if(n.userData.onGround){e=e.changedTouches[0];var t=O.domElement.getBoundingClientRect();V.x=(e.clientX-t.left)/t.width*2-1,V.y=-((e.clientY-t.top)/t.height)*2+1,At.setFromCamera(V,w),V.y>0&&n.userData.canBoostStep&&I&&n.userData.onStartArea&&r.linvel().z<h[_].maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&!k&&h[_].nowSpeed<h[_].maxSpeed&&(h[_].nowSpeed+=h[_].stepSpeed),n.userData.canBoostStep=!1,V.y<.5&&(V.x>0?(n.userData.left=!1,n.userData.right=!0):(n.userData.right=!1,n.userData.left=!0))}}function Gt(e){n.userData.right=!1,n.userData.left=!1,n.userData.canBoostStep=!0}function Jt(e){switch(e.code){case"KeyW":case"ArrowUp":n.userData.canBoostStep&&I&&n.userData.onStartArea&&r.linvel().z<h[_].maxSpeed&&r.linvel().y<5&&r.linvel().y>-5&&!k&&h[_].nowSpeed<h[_].maxSpeed&&(h[_].nowSpeed+=h[_].stepSpeed),n.userData.canBoostStep=!1;break;case"KeyS":case"ArrowDown":break;case"KeyA":case"ArrowLeft":n.userData.left=!0;break;case"KeyD":case"ArrowRight":n.userData.right=!0;break}}function Nt(e){switch(e.code){case"KeyW":case"ArrowUp":n.userData.canBoostStep=!0;break;case"KeyS":case"ArrowDown":break;case"KeyA":case"ArrowLeft":n.userData.left=!1;break;case"KeyD":case"ArrowRight":n.userData.right=!1;break}}function R(e){let t,o;const l=e.rotation.clone();e.rotation.set(0,0,0);const a=new W().setFromObject(e).getSize(new x);if(e.rotation.copy(l),e.name.includes("player")?(n.userData.size=a,n.userData.orgRotation=l,t=y.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!1).setLinearDamping(0).setAngularDamping(2)),o=p.ColliderDesc.cuboid(a.x/5,a.y/1.5,a.z/3).setMass(e.userData.mass).setRestitution(0).setFriction(0),r=t,we=o,o.setActiveEvents(p.ActiveEvents.COLLISION_EVENTS),y.createCollider(o,t),n.userData.handle=r.handle,v.push([e,t,e.id])):e.name.includes("ground")&&(t=y.createRigidBody(p.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0)),o=p.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass).setRestitution(0).setFriction(0),y.createCollider(o,t),Ve=t,U.userData.handle=Ve.handle,v.push([e,t,e.id])),e.name.includes("wall")){t=y.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!1).setLinearDamping(0)),o=p.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(40);let i=y.createCollider(o,t);ze.push(i),v.push([e,t,e.id])}if(e.name.includes("moving_block")){t=y.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!0,!0,!0).setLinearDamping(0)),o=p.ColliderDesc.ball(a.x/2).setMass(e.userData.mass*10).setRestitution(0).setFriction(20);let i=t;Fe.push(i);let D=y.createCollider(o,t);ze.push(D),v.push([e,t,e.id])}e.name.includes("itsmen_body")&&(t=y.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!0,!1,!0).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.cuboid(a.x/2,a.y/2,a.z/2).setMass(0).setRestitution(0).setFriction(0).setDensity(2),g.userData.body=t,g.userData.collider=o,y.createCollider(o,t),v.push([e,t,e.id])),e.name.includes("itsmen_left_hand")&&(t=y.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),B.userData.body=t,B.userData.collider=o,y.createCollider(o,t),v.push([e,t,e.id])),e.name.includes("itsmen_right_hand")&&(t=y.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),M.userData.body=t,M.userData.collider=o,y.createCollider(o,t),v.push([e,t,e.id])),e.name.includes("itsmen_left_leg")&&(t=y.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),q.userData.body=t,q.userData.collider=o,y.createCollider(o,t),v.push([e,t,e.id])),e.name.includes("itsmen_right_leg")&&(t=y.createRigidBody(p.RigidBodyDesc.dynamic().setTranslation(e.position.x,e.position.y,e.position.z).setRotation(e.quaternion).setCanSleep(!1).enabledRotations(!1,!0,!1).setLinearDamping(0).setAngularDamping(0)),o=p.ColliderDesc.capsule(a.z/2,a.x/10).setMass(0).setRestitution(0).setFriction(0).setDensity(2),C.userData.body=t,C.userData.collider=o,y.createCollider(o,t),v.push([e,t,e.id]))}document.addEventListener("visibilitychange",function(){var e,t;document.visibilityState==="visible"?(re=!1,z&&F==!1&&(d==null||d.play()),r.linvel().z>3&&n.userData.onGround&&z&&F==!1&&(c==null||c.play()),!k&&I&&F==!1&&((e=ysdk.features.GameplayAPI)==null||e.start(),L.start(),L.elapsedTime=n.userData.time)):(re=!0,(t=ysdk.features.GameplayAPI)==null||t.stop(),b!=null&&b.isPlaying&&b.pause(),d==null||d.stop(),c==null||c.stop(),F==!1&&!k&&I&&(n.userData.time=L.getElapsedTime(),L.stop()))});
